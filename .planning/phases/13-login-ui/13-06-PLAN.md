---
phase: 13-login-ui
plan: 06
type: execute
wave: 4
depends_on: ["13-04", "13-05"]
files_modified:
  - apps/web/src/features/auth/components/LoginForm.test.tsx
  - apps/web/src/features/auth/context/AuthContext.test.tsx
  - apps/web/src/app/App.test.tsx
autonomous: false

must_haves:
  truths:
    - "Login form submits credentials and redirects on success"
    - "Login form shows error on invalid credentials"
    - "Registration form submits and shows verification notice"
    - "AuthContext attempts refresh on mount"
    - "ProtectedRoute redirects to /login when not authenticated"
    - "User can log out from dashboard"
    - "Root URL redirects based on auth state"
    - "Full login-to-logout cycle works in browser"
  artifacts:
    - path: "apps/web/src/features/auth/components/LoginForm.test.tsx"
      provides: "Unit tests for LoginForm"
      contains: "LoginForm"
    - path: "apps/web/src/features/auth/context/AuthContext.test.tsx"
      provides: "Unit tests for AuthContext"
      contains: "AuthProvider"
  key_links:
    - from: "apps/web/src/features/auth/components/LoginForm.tsx"
      to: "/auth/token"
      via: "form submission through useAuth().login()"
      pattern: "/auth/token"
    - from: "apps/web/src/features/auth/context/AuthContext.tsx"
      to: "/auth/refresh"
      via: "optimistic mount refresh"
      pattern: "/auth/refresh"
    - from: "apps/web/src/features/auth/components/UserMenu.tsx"
      to: "/auth/logout"
      via: "useAuth().logout()"
      pattern: "/auth/logout"
---

<objective>
Add unit tests for auth components/context and perform end-to-end verification of the complete auth flow.

Purpose: This is the final plan for Phase 13. Unit tests validate individual component behavior. The HITL checkpoint verifies the complete login-to-logout cycle works in a real browser against the running backend.

Output: Unit tests for auth components, verified end-to-end auth flow.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/features/auth/context/AuthContext.tsx
@apps/web/src/features/auth/components/LoginForm.tsx
@apps/web/src/features/auth/components/RegisterForm.tsx
@apps/web/src/features/auth/components/UserMenu.tsx
@apps/web/src/pages/LoginPage.tsx
@apps/web/src/pages/RegisterPage.tsx
@apps/web/src/pages/VerifyEmailPage.tsx
@apps/web/src/pages/DashboardPage.tsx
@apps/web/src/app/App.tsx
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for auth components and context</name>
  <files>
    apps/web/src/features/auth/components/LoginForm.test.tsx
    apps/web/src/features/auth/context/AuthContext.test.tsx
    apps/web/src/app/App.test.tsx
  </files>
  <action>
Write Vitest + React Testing Library tests for the auth system. Mock the api module to avoid real HTTP calls.

**`apps/web/src/features/auth/components/LoginForm.test.tsx`:**

Test cases:
1. Renders email, password, remember me, and submit button
2. Shows validation error when email is invalid
3. Shows validation error when password is empty
4. Calls login() with form data on valid submission
5. Displays server error message on login failure (mock login to throw)
6. Submit button shows loading state during submission
7. Password toggle switches between text and password input type

Mock useAuth to return { login: vi.fn(), ... }. Wrap in MemoryRouter for Link components.

**`apps/web/src/features/auth/context/AuthContext.test.tsx`:**

Test cases:
1. Starts in loading state (isLoading: true)
2. Attempts /auth/refresh on mount and sets user if successful
3. Sets isLoading to false after auth check completes
4. Sets user to null if refresh fails (401)
5. login() calls /auth/token then /auth/me and updates user
6. logout() calls /auth/logout and clears user

Mock the api module (vi.mock('../../../lib/api')) to control responses. Render AuthProvider with a test consumer component that reads useAuth() values.

**`apps/web/src/app/App.test.tsx`:**

Update or create tests that verify:
1. Unauthenticated user at / is redirected to /login
2. Authenticated user at / is redirected to /dashboard

Mock AuthProvider or the api module to control auth state. Use MemoryRouter with initialEntries for route testing.

Important notes:
- Use `vi.mock()` for mocking modules (Vitest, not Jest)
- Use `waitFor` from @testing-library/react for async state updates
- Use `userEvent` from @testing-library/user-event for form interactions
- If the existing App.test.tsx file exists from Phase 12, update it to work with the new routing structure. If it tested the old sidebar layout, those tests may need to move to DashboardPage tests or be updated.
- For form tests, render within a FormProvider context since shadcn/ui Form components require it
  </action>
  <verify>
    `npx nx typecheck web && npx nx test web` — all tests pass.
  </verify>
  <done>
    Unit tests cover: LoginForm (7 cases), AuthContext (6 cases), App routing (2 cases). All tests pass with mocked API calls.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 13 Login UI:
    - Backend cookie fixes (samesite=lax, remember_me param)
    - Axios client with silent token refresh interceptors
    - AuthContext with optimistic mount refresh
    - Login page with form validation, password toggle, remember me
    - Registration page with verification notice
    - Email verification page with success/error/expired states
    - User menu with avatar initials and logout
    - Dashboard page with sidebar layout
    - Protected route with auth redirect
    - Unit tests for auth components and context
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    Start both services:
    ```bash
    npx nx serve api   # Terminal 1 — backend at :8000
    npx nx serve web   # Terminal 2 — frontend at :5173
    ```

    **Test 1: Registration flow**
    1. Open http://localhost:5173 → should redirect to /login
    2. Click "Don't have an account? Sign up" → should navigate to /register
    3. Fill in: email=testuser@test.com, password=TestPass1!, display name=Test User
    4. Click Register → should show "Check your email to verify" message
    5. Should NOT auto-login

    **Test 2: Login flow**
    6. Navigate to /login
    7. Leave fields empty and click Login → should show validation errors
    8. Enter invalid credentials → should show "Invalid credentials" error
    9. Enter valid credentials (from a previously registered and verified user)
    10. Click Login → should redirect to /dashboard
    11. Dashboard should show sidebar + user menu in header

    **Test 3: Session persistence**
    12. Refresh the page (F5) at /dashboard
    13. Should stay on /dashboard (not flash login page)
    14. Token refresh happens in background

    **Test 4: Logout**
    15. Click user avatar/name in header → dropdown appears
    16. Click "Log out" → immediate redirect to /login
    17. Try navigating to /dashboard → should redirect to /login

    **Test 5: Protected routes**
    18. In a new incognito window, navigate to http://localhost:5173/dashboard
    19. Should redirect to /login silently (no toast/message)

    **Test 6: Password toggle**
    20. On login page, click the eye icon on password field
    21. Password should become visible (input type=text)
    22. Click again → hidden (input type=password)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npx nx typecheck web && npx nx test web` — all tests pass
- `npx nx typecheck api && npx nx test api` — backend tests still pass
- Full verification ladder: typecheck -> test -> serve both services -> smoke test auth flow
</verification>

<success_criteria>
1. All unit tests pass
2. Login-to-logout cycle works in browser
3. Session persists across refresh
4. Protected routes redirect to login
5. Registration shows verification notice
6. All 5 phase success criteria met (from roadmap)
</success_criteria>

<output>
After completion, create `.planning/phases/13-login-ui/13-06-SUMMARY.md`
</output>
