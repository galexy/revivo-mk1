---
phase: 13-login-ui
plan: 05
type: execute
wave: 3
depends_on: ["13-03"]
files_modified:
  - apps/web/src/pages/VerifyEmailPage.tsx
  - apps/web/src/features/auth/components/UserMenu.tsx
  - apps/web/src/pages/DashboardPage.tsx
  - apps/web/src/app/App.tsx
autonomous: true

must_haves:
  truths:
    - "Email verification page calls GET /auth/verify?token=... and shows success or failure"
    - "Expired token shows message + button to resend verification email"
    - "Verification success page has link to login"
    - "UserMenu shows avatar initials + display name"
    - "Clicking Log out triggers immediate logout (no confirmation dialog)"
    - "After logout, user is redirected to /login"
    - "Dashboard page shows sidebar with accounts and user menu in header"
  artifacts:
    - path: "apps/web/src/pages/VerifyEmailPage.tsx"
      provides: "Email verification landing page"
      contains: "VerifyEmailPage"
    - path: "apps/web/src/features/auth/components/UserMenu.tsx"
      provides: "Dropdown menu with avatar and logout"
      contains: "UserMenu"
    - path: "apps/web/src/pages/DashboardPage.tsx"
      provides: "Dashboard layout with sidebar and user menu"
      contains: "DashboardPage"
  key_links:
    - from: "apps/web/src/pages/VerifyEmailPage.tsx"
      to: "/auth/verify"
      via: "api.get call with token param"
      pattern: "/auth/verify"
    - from: "apps/web/src/features/auth/components/UserMenu.tsx"
      to: "apps/web/src/features/auth/context/useAuth.ts"
      via: "useAuth().logout()"
      pattern: "useAuth.*logout"
---

<objective>
Build the email verification page, user menu with logout, and dashboard shell.

Purpose: The verify page handles the email link flow. The UserMenu provides the logout action (accessible from any authenticated page). The DashboardPage is the post-login landing page with the sidebar layout from the original App.tsx.

Output: Working verify page, user menu dropdown with logout, dashboard shell with sidebar.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/features/auth/context/AuthContext.tsx
@apps/web/src/features/auth/context/useAuth.ts
@apps/web/src/features/auth/types.ts
@apps/web/src/lib/api.ts
@apps/web/src/app/App.tsx
@libs/ui/src/index.ts
@.planning/phases/13-login-ui/13-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifyEmailPage</name>
  <files>
    apps/web/src/pages/VerifyEmailPage.tsx
  </files>
  <action>
**Create `apps/web/src/pages/VerifyEmailPage.tsx`:**

This page handles the `/verify?token=...` URL that users click from their verification email.

Implementation:
1. Read `token` from URL search params using `useSearchParams()` from react-router-dom
2. On mount (useEffect), if token exists, call `GET /auth/verify?token=${token}` via the api instance
3. States: `loading` (initial), `success` (verified), `error` (failed), `expired` (token expired)
4. Display states:

**Loading:** Centered card with "Verifying your email..." message and a loading indicator.

**Success:** Centered card with:
- Checkmark icon or success styling
- "Email verified successfully" heading
- "Your email has been verified. You can now log in." message
- Button/link: "Go to Login" → navigates to /login

**Error (generic):** Centered card with:
- "Verification failed" heading
- Error message from server (response.data.detail)
- Link to /login

**Expired token:** Centered card with:
- "Verification link expired" heading
- "Your verification link has expired." message
- Button: "Resend verification email" (see below)
- Link to /login

Detecting expired vs generic error: The backend returns 400 with a detail message. Check if the message contains "expired" (case-insensitive) to distinguish expired from other errors.

**Resend verification:** When user clicks "Resend verification email", show an email input field (pre-filled if available from response) and a submit button. On submit, call `POST /auth/register` with the same email — the backend will re-send verification email for existing unverified users (returns 202 regardless per enumeration protection). Show a confirmation message: "If an account exists with this email, a new verification link has been sent."

Note: The backend doesn't have a dedicated resend-verification endpoint. Re-registering triggers the UserRegistered event which sends a new verification email. This is a pragmatic approach for Phase 13 — a dedicated endpoint can be added later if needed.

Layout: Same centered card pattern as login/register pages. No auth required (this is a public page).
  </action>
  <verify>
    `npx nx typecheck web` passes.
  </verify>
  <done>
    VerifyEmailPage reads token from URL params, calls /auth/verify, shows success/error/expired states. Expired state has resend button. Success state links to login.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserMenu and DashboardPage, wire into App routes</name>
  <files>
    apps/web/src/features/auth/components/UserMenu.tsx
    apps/web/src/pages/DashboardPage.tsx
    apps/web/src/app/App.tsx
  </files>
  <action>
**Create `apps/web/src/features/auth/components/UserMenu.tsx`:**

Dropdown menu with avatar initials and logout action per locked decisions.

Implementation:
1. Use useAuth() to get user and logout
2. Generate initials from user.display_name: split by space, take first letter of each word, uppercase, max 2 chars
3. Trigger: Avatar circle with initials + display name text
4. Content:
   - Disabled item showing user.email (informational, not clickable)
   - Separator
   - "Log out" menu item that calls logout() directly (no confirmation dialog per user decision)

Use shadcn/ui DropdownMenu, Avatar from @workspace/ui:
```typescript
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  Avatar,
  AvatarFallback,
  Button,
} from '@workspace/ui';
```

The trigger should be a Button variant="ghost" wrapping the avatar and name. The dropdown aligns to the end (`align="end"`).

**Create `apps/web/src/pages/DashboardPage.tsx`:**

This restores the sidebar layout from the original App.tsx, now with UserMenu in the header area.

Layout (based on original App.tsx but enhanced):
```
┌─────────┬──────────────────────────────┐
│ Sidebar  │ Header: "Personal Finance"  [UserMenu] │
│ Accounts │                              │
│ - Check  │  Account cards grid          │
│ - Save   │  Quick add transaction       │
│ - Credit │                              │
│          │                              │
│ [Theme]  │                              │
└─────────┴──────────────────────────────┘
```

Implementation:
- Move the existing sidebar + main content from the old App.tsx into DashboardPage
- Add a header bar at the top of main content with the app title on the left and UserMenu on the right
- Keep the dark mode toggle in the sidebar
- Keep the existing theme state logic (useState + useEffect for dark class toggle + localStorage)

**Update `apps/web/src/app/App.tsx`:**

Replace remaining placeholder components with actual imports:
```typescript
import { VerifyEmailPage } from '../pages/VerifyEmailPage';
import { DashboardPage } from '../pages/DashboardPage';
```

Remove inline placeholder functions for VerifyEmailPage and DashboardPage.

The final App.tsx should only contain:
- Route definitions (Routes/Route)
- RootRedirect component
- No inline page components

Also check: if `/login?expired=true` URL param is present, the login page should show "Your session has expired. Please log in again." message. This is triggered by the Axios interceptor when refresh token is expired. Add this to LoginPage — read `expired` search param, if present show a message above the form. This connects to the Axios interceptor in lib/api.ts which redirects to `/login?expired=true`.

Wait — this should be in LoginPage, which was created in Plan 04. If Plan 04 didn't add this, add it here by updating LoginPage.tsx to check for the `expired` search param. If LoginPage was already created in Plan 04, modify it to read `useSearchParams()` and display a session expired banner when `expired=true`.
  </action>
  <verify>
    `npx nx typecheck web` passes.
    `npx nx test web` passes.
    Start `npx nx serve web` and verify:
    - Navigate to /verify?token=invalid — see error state
    - Navigate to / when not logged in — redirect to /login
    - The app shell renders without errors
  </verify>
  <done>
    UserMenu shows avatar initials + name, logout triggers immediate redirect. DashboardPage has sidebar + header + UserMenu. VerifyEmailPage handles all token states. App.tsx uses real page imports for all routes. Session expired message shown on /login?expired=true.
  </done>
</task>

</tasks>

<verification>
- `npx nx typecheck web && npx nx test web` passes
- VerifyEmailPage handles token verification states correctly
- UserMenu renders avatar and logout
- DashboardPage has sidebar layout with UserMenu in header
- All routes use real page components (no inline placeholders)
</verification>

<success_criteria>
1. Email verification page shows success/error/expired states
2. Expired token shows resend button
3. UserMenu dropdown with avatar initials + display name + logout
4. Logout triggers immediately (no confirmation dialog), redirects to /login
5. DashboardPage has sidebar + header + user menu
6. Session expired message on /login?expired=true
</success_criteria>

<output>
After completion, create `.planning/phases/13-login-ui/13-05-SUMMARY.md`
</output>
