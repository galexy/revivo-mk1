---
phase: 04-authentication-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - alembic/versions/006_add_auth_tables.py
  - src/adapters/persistence/orm/tables.py
  - src/adapters/persistence/orm/types.py
autonomous: true

must_haves:
  truths:
    - "households table exists with id, name, owner_id, timestamps"
    - "users table expanded with password_hash, display_name, household_id"
    - "refresh_tokens table exists for token rotation"
    - "accounts, transactions, categories, payees have household_id column"
    - "Existing data migrated to 'Default' household"
  artifacts:
    - path: "alembic/versions/006_add_auth_tables.py"
      provides: "Auth schema migration"
      contains: "create_table"
    - path: "src/adapters/persistence/orm/tables.py"
      provides: "SQLAlchemy table definitions"
      contains: "households"
  key_links:
    - from: "src/adapters/persistence/orm/tables.py"
      to: "alembic migration"
      via: "table definitions match migration"
      pattern: "Table.*households"
---

<objective>
Create database migration for authentication tables and add household_id to existing tables.

Purpose: Establish the persistence layer schema for users, households, and refresh tokens. Add household scoping to all user-owned data. Migrations and ORM table definitions are infrastructure/config work -- NOT TDD candidates.

Output: Migration 006, updated table definitions, existing data migrated to Default household.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-RESEARCH.md
@src/adapters/persistence/orm/tables.py
@src/adapters/persistence/orm/types.py
@alembic/versions/005_add_split_identity.py
</context>

<tasks>

<task id="1">
  <title>Add HouseholdIdType to ORM types</title>
  <type>auto</type>
  <files>src/adapters/persistence/orm/types.py</files>
  <action>
Add HouseholdIdType following the existing pattern for UserIdType, AccountIdType, etc.:

```python
class HouseholdIdType(TypeDecorator):
    """SQLAlchemy type for HouseholdId domain type.

    Converts between HouseholdId domain type and String database type.
    Handles both HouseholdId instances and string values.
    """

    impl = String
    cache_ok = True

    def __init__(self, length: int = 36) -> None:
        super().__init__(length)

    def process_bind_param(
        self, value: HouseholdId | str | None, dialect: Dialect
    ) -> str | None:
        if value is None:
            return None
        if isinstance(value, HouseholdId):
            return str(value)
        return value

    def process_result_value(
        self, value: str | None, dialect: Dialect
    ) -> HouseholdId | None:
        if value is None:
            return None
        return HouseholdId.from_string(value)
```

Add import for HouseholdId at top of file. Export HouseholdIdType.
  </action>
  <verify>python -c "from src.adapters.persistence.orm.types import HouseholdIdType; print(HouseholdIdType)"</verify>
  <done>HouseholdIdType converts between HouseholdId and String for database storage</done>
</task>

<task id="2">
  <title>Update tables.py with auth tables and household columns</title>
  <type>auto</type>
  <files>src/adapters/persistence/orm/tables.py</files>
  <action>
Update tables.py with new tables and household_id columns.

**1. Add households table (before users table):**
```python
households = Table(
    "households",
    metadata,
    Column("id", HouseholdIdType(36), primary_key=True),
    Column("name", String(255), nullable=False),
    Column("owner_id", UserIdType(36), nullable=False),
    Column("created_at", DateTime(timezone=True), nullable=False),
    Column("updated_at", DateTime(timezone=True), nullable=False),
)
```

**2. Expand users table:**
```python
users = Table(
    "users",
    metadata,
    Column("id", UserIdType(36), primary_key=True),
    Column("email", String(255), nullable=False, unique=True),
    Column("display_name", String(255), nullable=False),
    Column("password_hash", String(255), nullable=False),
    Column("household_id", HouseholdIdType(36), ForeignKey("households.id"), nullable=False),
    Column("email_verified", Boolean, nullable=False, default=False),
    Column("email_verified_at", DateTime(timezone=True), nullable=True),
    Column("created_at", DateTime(timezone=True), nullable=False),
    Column("updated_at", DateTime(timezone=True), nullable=False),
    Index("ix_users_email", "email", unique=True),
    Index("ix_users_household_id", "household_id"),
)
```

**3. Add refresh_tokens table:**
```python
refresh_tokens = Table(
    "refresh_tokens",
    metadata,
    Column("id", Integer, primary_key=True, autoincrement=True),
    Column("user_id", UserIdType(36), ForeignKey("users.id", ondelete="CASCADE"), nullable=False),
    Column("token_hash", String(64), nullable=False),
    Column("token_family", String(36), nullable=False),
    Column("expires_at", DateTime(timezone=True), nullable=False),
    Column("created_at", DateTime(timezone=True), nullable=False),
    Column("revoked_at", DateTime(timezone=True), nullable=True),
    Index("ix_refresh_tokens_user_id", "user_id"),
    Index("ix_refresh_tokens_token_hash", "token_hash", unique=True),
    Index("ix_refresh_tokens_family", "token_family"),
)
```

**4. Add household_id to existing tables:**
- accounts: Add `Column("household_id", HouseholdIdType(36), ForeignKey("households.id"), nullable=False)`
- transactions: Add same column
- categories: Add same column
- payees: Add same column

Add import for HouseholdIdType at top.
  </action>
  <verify>python -c "from src.adapters.persistence.orm.tables import households, users, refresh_tokens; print('Tables defined')"</verify>
  <done>Table definitions include households, expanded users, refresh_tokens, and household_id on existing tables</done>
</task>

<task id="3">
  <title>Create Alembic migration 006</title>
  <type>auto</type>
  <files>alembic/versions/006_add_auth_tables.py</files>
  <action>
Create migration that:
1. Creates households table
2. Expands users table with new columns
3. Creates refresh_tokens table
4. Adds household_id to accounts, transactions, categories, payees
5. Creates "Default" household and migrates existing data

```python
"""Add authentication tables and household scoping.

Revision ID: 006
Revises: 005
Create Date: 2026-02-04

This migration:
1. Creates households table
2. Expands users table with authentication fields
3. Creates refresh_tokens table for token rotation
4. Adds household_id to all user-owned tables
5. Migrates existing data to a "Default" household
"""

from alembic import op
import sqlalchemy as sa
from datetime import UTC, datetime

revision = "006"
down_revision = "005"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # 1. Create households table
    op.create_table(
        "households",
        sa.Column("id", sa.String(36), primary_key=True),
        sa.Column("name", sa.String(255), nullable=False),
        sa.Column("owner_id", sa.String(36), nullable=True),  # Initially nullable for bootstrap
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
    )

    # 2. Add new columns to users table
    op.add_column("users", sa.Column("display_name", sa.String(255), nullable=True))
    op.add_column("users", sa.Column("password_hash", sa.String(255), nullable=True))
    op.add_column("users", sa.Column("household_id", sa.String(36), nullable=True))
    op.add_column("users", sa.Column("email_verified_at", sa.DateTime(timezone=True), nullable=True))

    # 3. Create refresh_tokens table
    op.create_table(
        "refresh_tokens",
        sa.Column("id", sa.Integer, primary_key=True, autoincrement=True),
        sa.Column("user_id", sa.String(36), sa.ForeignKey("users.id", ondelete="CASCADE"), nullable=False),
        sa.Column("token_hash", sa.String(64), nullable=False),
        sa.Column("token_family", sa.String(36), nullable=False),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("revoked_at", sa.DateTime(timezone=True), nullable=True),
    )
    op.create_index("ix_refresh_tokens_user_id", "refresh_tokens", ["user_id"])
    op.create_index("ix_refresh_tokens_token_hash", "refresh_tokens", ["token_hash"], unique=True)
    op.create_index("ix_refresh_tokens_family", "refresh_tokens", ["token_family"])

    # 4. Add household_id to existing tables (nullable initially for migration)
    op.add_column("accounts", sa.Column("household_id", sa.String(36), nullable=True))
    op.add_column("transactions", sa.Column("household_id", sa.String(36), nullable=True))
    op.add_column("categories", sa.Column("household_id", sa.String(36), nullable=True))
    op.add_column("payees", sa.Column("household_id", sa.String(36), nullable=True))

    # 5. Create Default household and migrate existing data
    conn = op.get_bind()
    now = datetime.now(UTC).isoformat()

    default_hh_id = "hh_00000000000000000000000000"
    conn.execute(
        sa.text(
            "INSERT INTO households (id, name, owner_id, created_at, updated_at) "
            "VALUES (:id, :name, NULL, :created_at, :updated_at)"
        ),
        {"id": default_hh_id, "name": "Default", "created_at": now, "updated_at": now},
    )

    for table in ["accounts", "transactions", "categories", "payees"]:
        conn.execute(
            sa.text(f"UPDATE {table} SET household_id = :hh_id WHERE household_id IS NULL"),
            {"hh_id": default_hh_id},
        )

    conn.execute(
        sa.text(
            "UPDATE users SET household_id = :hh_id, "
            "display_name = COALESCE(display_name, email), "
            "password_hash = COALESCE(password_hash, 'PLACEHOLDER_NEEDS_RESET') "
            "WHERE household_id IS NULL"
        ),
        {"hh_id": default_hh_id},
    )

    # 6. Make columns NOT NULL after migration
    op.alter_column("users", "display_name", nullable=False)
    op.alter_column("users", "password_hash", nullable=False)
    op.alter_column("users", "household_id", nullable=False)
    op.alter_column("accounts", "household_id", nullable=False)
    op.alter_column("transactions", "household_id", nullable=False)
    op.alter_column("categories", "household_id", nullable=False)
    op.alter_column("payees", "household_id", nullable=False)

    # 7. Add foreign key constraints
    op.create_foreign_key("fk_users_household", "users", "households", ["household_id"], ["id"])
    op.create_foreign_key("fk_accounts_household", "accounts", "households", ["household_id"], ["id"])
    op.create_foreign_key("fk_transactions_household", "transactions", "households", ["household_id"], ["id"])
    op.create_foreign_key("fk_categories_household", "categories", "households", ["household_id"], ["id"])
    op.create_foreign_key("fk_payees_household", "payees", "households", ["household_id"], ["id"])

    # 8. Add indexes
    op.create_index("ix_users_household_id", "users", ["household_id"])
    op.create_index("ix_accounts_household_id", "accounts", ["household_id"])
    op.create_index("ix_transactions_household_id", "transactions", ["household_id"])
    op.create_index("ix_categories_household_id", "categories", ["household_id"])
    op.create_index("ix_payees_household_id", "payees", ["household_id"])


def downgrade() -> None:
    op.drop_index("ix_payees_household_id")
    op.drop_index("ix_categories_household_id")
    op.drop_index("ix_transactions_household_id")
    op.drop_index("ix_accounts_household_id")
    op.drop_index("ix_users_household_id")

    op.drop_constraint("fk_payees_household", "payees", type_="foreignkey")
    op.drop_constraint("fk_categories_household", "categories", type_="foreignkey")
    op.drop_constraint("fk_transactions_household", "transactions", type_="foreignkey")
    op.drop_constraint("fk_accounts_household", "accounts", type_="foreignkey")
    op.drop_constraint("fk_users_household", "users", type_="foreignkey")

    op.drop_column("payees", "household_id")
    op.drop_column("categories", "household_id")
    op.drop_column("transactions", "household_id")
    op.drop_column("accounts", "household_id")

    op.drop_index("ix_refresh_tokens_family")
    op.drop_index("ix_refresh_tokens_token_hash")
    op.drop_index("ix_refresh_tokens_user_id")
    op.drop_table("refresh_tokens")

    op.drop_column("users", "email_verified_at")
    op.drop_column("users", "household_id")
    op.drop_column("users", "password_hash")
    op.drop_column("users", "display_name")

    op.drop_table("households")
```
  </action>
  <verify>
cd /workspace && alembic upgrade head
psql $DATABASE_URL -c "SELECT * FROM households" -- should show Default household
psql $DATABASE_URL -c "\d users" -- should show new columns
  </verify>
  <done>Migration creates auth tables, adds household_id to existing tables, migrates existing data to Default household</done>
</task>

</tasks>

<verification>
Database schema is complete:
1. `alembic upgrade head` runs without errors
2. `alembic downgrade -1 && alembic upgrade head` round-trips successfully
3. households, refresh_tokens tables exist
4. users table has password_hash, display_name, household_id
5. accounts, transactions, categories, payees have household_id
6. Default household exists with migrated data
</verification>

<success_criteria>
- Migration 006 creates households table
- Migration 006 expands users table
- Migration 006 creates refresh_tokens table
- Migration 006 adds household_id to all user-owned tables
- Existing data migrated to Default household
- All foreign key constraints in place
- Tables.py definitions match migration
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-03-SUMMARY.md`
</output>
