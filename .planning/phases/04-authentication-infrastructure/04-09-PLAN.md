---
phase: 04-authentication-infrastructure
plan: 09
type: execute
wave: 5
depends_on: ["04-08"]
files_modified:
  - tests/integration/api/test_accounts.py
  - tests/integration/api/test_transactions.py
  - tests/integration/api/test_categories.py
autonomous: true

must_haves:
  truths:
    - "Existing E2E tests use real auth flow (register, login, use JWT)"
    - "All existing tests pass with authentication"
    - "Household isolation prevents cross-household data access"
  artifacts:
    - path: "tests/integration/api/test_accounts.py"
      provides: "Account tests with auth"
      contains: "auth_headers"
    - path: "tests/integration/api/test_transactions.py"
      provides: "Transaction tests with auth"
      contains: "auth_headers"
    - path: "tests/integration/api/test_categories.py"
      provides: "Category tests with auth"
      contains: "auth_headers"
  key_links:
    - from: "tests/integration/api/test_accounts.py"
      to: "tests/conftest.py"
      via: "auth fixture"
      pattern: "auth_headers|authenticated_client"
    - from: "tests/integration/api/test_accounts.py"
      to: "household isolation"
      via: "cross-household 404 test"
      pattern: "TestHouseholdIsolation|other_household"
---

<objective>
Update all existing integration tests to use real auth flow and add household isolation tests.

Purpose: Ensure existing account, transaction, and category tests work with authentication enabled. Verify household scoping prevents cross-household data access.

Output: All existing tests passing with auth, household isolation verified.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-08-SUMMARY.md
@tests/conftest.py
@tests/integration/api/test_accounts.py
@tests/integration/api/test_transactions.py
@tests/integration/api/test_categories.py
</context>

<tasks>

<task id="1">
  <title>Update existing integration tests to use auth_headers fixture</title>
  <type>auto</type>
  <files>tests/integration/api/test_accounts.py, tests/integration/api/test_transactions.py, tests/integration/api/test_categories.py</files>
  <action>
Update all existing integration tests to pass `auth_headers` to protected endpoint calls. The auth_headers fixture was created in 04-08 (tests/conftest.py).

**For each test file, add `auth_headers` parameter to every test method that calls a protected endpoint:**

```python
# Before:
def test_create_checking_account(self, client: TestClient) -> None:
    response = client.post("/api/v1/accounts/checking", json={...})

# After:
def test_create_checking_account(self, client: TestClient, auth_headers: dict) -> None:
    response = client.post("/api/v1/accounts/checking", json={...}, headers=auth_headers)
```

Apply this pattern to ALL test methods in:
- `tests/integration/api/test_accounts.py` - all account CRUD tests
- `tests/integration/api/test_transactions.py` - all transaction CRUD tests
- `tests/integration/api/test_categories.py` - all category CRUD tests

Work through one file at a time, running tests after each file to catch issues incrementally:
1. Update test_accounts.py, run `pytest tests/integration/api/test_accounts.py -x`
2. Update test_transactions.py, run `pytest tests/integration/api/test_transactions.py -x`
3. Update test_categories.py, run `pytest tests/integration/api/test_categories.py -x`
  </action>
  <verify>pytest tests/integration/api/test_accounts.py tests/integration/api/test_transactions.py tests/integration/api/test_categories.py -v (all existing tests PASS with auth)</verify>
  <done>All existing E2E tests updated to use auth_headers fixture and pass with authentication enabled</done>
</task>

<task id="2">
  <title>Add household isolation tests</title>
  <type>auto</type>
  <files>tests/integration/api/test_accounts.py</files>
  <action>
Add a TestHouseholdIsolation class to test_accounts.py that verifies cross-household data access is denied.

```python
class TestHouseholdIsolation:
    """Verify that users cannot access data from other households."""

    def _create_second_user(self, client: TestClient) -> dict:
        """Register and authenticate a second user (different household)."""
        import uuid
        user_data = {
            "email": f"other_{uuid.uuid4().hex[:8]}@example.com",
            "password": "OtherPassword123!",
            "display_name": "Other User",
        }
        # Register
        client.post("/auth/register", json=user_data)
        # Verify email
        from src.adapters.security.tokens import generate_verification_token
        token = generate_verification_token(user_data["email"])
        client.get(f"/auth/verify?token={token}")
        # Login
        response = client.post(
            "/auth/token",
            data={"username": user_data["email"], "password": user_data["password"]},
        )
        return {"Authorization": f"Bearer {response.json()['access_token']}"}

    def test_cannot_access_other_household_account(
        self, client: TestClient, auth_headers: dict
    ) -> None:
        """Accessing another household's account returns 404."""
        # Create account with first user
        response = client.post(
            "/api/v1/accounts/checking",
            json={"name": "My Account", "opening_balance": {"amount": "100.00", "currency": "USD"}},
            headers=auth_headers,
        )
        account_id = response.json()["id"]

        # Login as second user (different household)
        other_headers = self._create_second_user(client)

        # Try to access first user's account -> 404
        response = client.get(f"/api/v1/accounts/{account_id}", headers=other_headers)
        assert response.status_code == 404

    def test_cannot_list_other_household_accounts(
        self, client: TestClient, auth_headers: dict
    ) -> None:
        """Listing accounts only shows own household's accounts."""
        # Create account with first user
        client.post(
            "/api/v1/accounts/checking",
            json={"name": "Hidden Account", "opening_balance": {"amount": "50.00", "currency": "USD"}},
            headers=auth_headers,
        )

        # Login as second user
        other_headers = self._create_second_user(client)

        # List accounts as second user -> should be empty
        response = client.get("/api/v1/accounts", headers=other_headers)
        assert response.status_code == 200
        assert len(response.json()) == 0
```
  </action>
  <verify>pytest tests/integration/api/test_accounts.py::TestHouseholdIsolation -v (both isolation tests PASS)</verify>
  <done>Household isolation verified: cross-household account access returns 404, listing only shows own household's data</done>
</task>

</tasks>

<verification>
Full test suite is complete:
1. `pytest tests/integration/api/ -v` - all tests pass (existing + new isolation tests)
2. Account tests pass with auth headers
3. Transaction tests pass with auth headers
4. Category tests pass with auth headers
5. Household isolation tests confirm cross-household returns 404
</verification>

<success_criteria>
- All existing account tests pass with auth_headers
- All existing transaction tests pass with auth_headers
- All existing category tests pass with auth_headers
- Household isolation: accessing other household's account returns 404
- Household isolation: listing shows only own household's accounts
- Full suite: `pytest tests/integration/api/ -v` passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-09-SUMMARY.md`
</output>
