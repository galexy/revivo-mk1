---
phase: 04-authentication-infrastructure
plan: 07
type: execute
wave: 4
depends_on: ["04-03", "04-06"]
files_modified:
  - src/adapters/api/routes/accounts.py
  - src/adapters/api/routes/transactions.py
  - src/adapters/api/routes/categories.py
  - src/adapters/api/dependencies.py
  - src/application/services/account_service.py
  - src/application/services/transaction_service.py
  - src/application/services/category_service.py
autonomous: true

must_haves:
  truths:
    - "All non-auth routes require valid JWT (401 without token)"
    - "Services filter data by household_id from CurrentUser"
    - "Cross-household access returns 404 (not 403)"
    - "Existing tests fail without authentication (verified, then fixed)"
  artifacts:
    - path: "src/adapters/api/routes/accounts.py"
      provides: "Protected account routes"
      contains: "get_current_user"
    - path: "src/application/services/account_service.py"
      provides: "Household-scoped account service"
      contains: "household_id"
  key_links:
    - from: "src/adapters/api/routes/accounts.py"
      to: "src/adapters/api/dependencies.py"
      via: "CurrentUser dependency"
      pattern: "Depends\\(get_current_user\\)"
    - from: "src/application/services/account_service.py"
      to: "household_id"
      via: "query filter"
      pattern: "household_id"
---

<objective>
Update all existing routes to use CurrentUser authentication and update services to filter by household_id.

Purpose: Protect all API routes and scope data access to the authenticated user's household. This is the final wiring that makes authentication work end-to-end.

Output: All routes protected, services filter by household, cross-household returns 404.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-RESEARCH.md
@src/adapters/api/routes/accounts.py
@src/adapters/api/routes/transactions.py
@src/adapters/api/routes/categories.py
@src/adapters/api/dependencies.py
@src/application/services/account_service.py
@src/application/services/transaction_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update services to accept and use household_id</name>
  <files>src/application/services/account_service.py, src/application/services/transaction_service.py, src/application/services/category_service.py</files>
  <action>
Update all service methods to accept household_id and filter queries accordingly.

**AccountService changes:**

1. Change all create methods to accept `household_id: HouseholdId` instead of `user_id: UserId`:
```python
def create_checking(
    self,
    household_id: HouseholdId,
    name: str,
    opening_balance: Money,
    ...
) -> Account | AccountError:
```

2. Store household_id on the account (Account entity needs this field - it already exists from migration).

3. Update `get_user_accounts` to `get_household_accounts`:
```python
def get_household_accounts(
    self,
    household_id: HouseholdId,
    status: AccountStatus | None = None,
    account_type: AccountType | None = None,
) -> list[Account]:
    """Get all accounts for a household."""
```

4. Update `get_account` to verify household ownership:
```python
def get_account(
    self,
    account_id: AccountId,
    household_id: HouseholdId,
) -> Account | AccountError:
    """Get account by ID, verifying household ownership.

    Returns NOT_FOUND for cross-household access (prevents probing).
    """
    account = self._uow.accounts.get_by_id(account_id)
    if not account or account.household_id != household_id:
        return AccountError("NOT_FOUND", "Account not found")
    return account
```

5. Similarly update close_account, reopen_account, delete_account, update_account_name.

**TransactionService changes:**

Apply same pattern - all methods accept household_id, verify ownership for single-item access.

**CategoryService changes:**

Apply same pattern - all methods accept household_id, verify ownership.

**Note:** The Account domain model needs a `household_id` field. Check if it exists, add if missing.
  </action>
  <verify>
Run `python -c "from src.application.services.account_service import AccountService; print('AccountService updated')"` to verify no import errors.
  </verify>
  <done>Services accept household_id parameter and filter/verify ownership on all operations.</done>
</task>

<task type="auto">
  <name>Task 2: Update Account domain model with household_id</name>
  <files>src/domain/model/account.py</files>
  <action>
Add household_id field to Account entity.

Add import:
```python
from .entity_id import AccountId, HouseholdId, UserId
```

Add field to Account dataclass:
```python
@dataclass(eq=False)
class Account:
    # ... existing fields ...
    household_id: HouseholdId  # Add after id field
```

Update create methods (create_checking, create_savings, etc.) to accept and store household_id:
```python
@classmethod
def create_checking(
    cls,
    name: str,
    opening_balance: Money,
    household_id: HouseholdId,  # Add parameter
    ...
) -> "Account":
    return cls(
        id=AccountId.generate(),
        household_id=household_id,  # Store it
        name=name,
        ...
    )
```

Update ORM mapper in mappers.py to map household_id column.
  </action>
  <verify>
Run `python -c "from src.domain.model.account import Account; from src.domain.model.entity_id import HouseholdId; print(hasattr(Account, 'household_id'))"` should print True after adding the field.
  </verify>
  <done>Account entity has household_id field, all factory methods accept and store it.</done>
</task>

<task type="auto">
  <name>Task 3: Update routes to use CurrentUser dependency</name>
  <files>src/adapters/api/routes/accounts.py, src/adapters/api/routes/transactions.py, src/adapters/api/routes/categories.py, src/adapters/api/dependencies.py</files>
  <action>
Update all route files to use CurrentUser instead of the placeholder get_current_user_id.

**accounts.py:**

1. Update imports:
```python
from src.adapters.api.dependencies import (
    CurrentUser,
    get_current_user,
    get_unit_of_work,
)
```

2. Replace type alias:
```python
CurrentUserDep = Annotated[CurrentUser, Depends(get_current_user)]
```

3. Update all route handlers to use household_id:
```python
@router.post("/checking", ...)
async def create_checking_account(
    request: CreateCheckingAccountRequest,
    service: AccountServiceDep,
    current_user: CurrentUserDep,  # Now CurrentUser, not UserId
) -> AccountResponse:
    result = service.create_checking(
        household_id=current_user.household_id,  # Use household_id
        name=request.name,
        ...
    )
```

4. Update list endpoint:
```python
async def list_accounts(
    service: AccountServiceDep,
    current_user: CurrentUserDep,
    ...
) -> AccountListResponse:
    accounts = service.get_household_accounts(
        household_id=current_user.household_id,
        ...
    )
```

5. Update get/update/delete endpoints to pass household_id for ownership verification.

**transactions.py:**

Apply same pattern - replace get_current_user_id with get_current_user, use household_id.

**categories.py:**

Apply same pattern.

**dependencies.py:**

Remove the old `get_current_user_id()` placeholder function (it's no longer needed).
  </action>
  <verify>
Start app and test without auth: `curl http://localhost:8000/api/v1/accounts` should return 401.
Test with invalid token: `curl -H "Authorization: Bearer invalid" http://localhost:8000/api/v1/accounts` should return 401.
  </verify>
  <done>All routes require valid JWT, pass household_id to services, placeholder removed.</done>
</task>

</tasks>

<verification>
Route protection is complete:
1. All non-auth routes return 401 without token
2. Valid token allows access
3. Services filter by household_id
4. Cross-household GET returns 404 (not 403)
5. `make lint` passes
</verification>

<success_criteria>
- CurrentUser replaces UserId in all routes
- Services use household_id for filtering
- get_account, get_transaction, get_category verify household ownership
- Cross-household access returns 404 (security: prevents probing)
- All routes except /auth/*, /health, /docs are protected
- Old get_current_user_id placeholder removed
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-07-SUMMARY.md`
</output>
