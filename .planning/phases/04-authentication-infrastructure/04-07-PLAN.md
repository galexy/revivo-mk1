---
phase: 04-authentication-infrastructure
plan: 07
type: execute
wave: 4
depends_on: ["04-03", "04-06"]
files_modified:
  - src/adapters/api/routes/accounts.py
  - src/adapters/api/routes/transactions.py
  - src/adapters/api/routes/categories.py
  - src/adapters/api/dependencies.py
  - src/application/services/account_service.py
  - src/application/services/transaction_service.py
  - src/application/services/category_service.py
  - src/domain/model/account.py
  - src/adapters/persistence/orm/mappers.py
autonomous: true

must_haves:
  truths:
    - "All non-auth routes require valid JWT (401 without token)"
    - "Services filter data by household_id from CurrentUser"
    - "Cross-household access returns 404 (not 403)"
    - "Existing tests fail without authentication (verified, then fixed)"
  artifacts:
    - path: "src/adapters/api/routes/accounts.py"
      provides: "Protected account routes"
      contains: "get_current_user"
    - path: "src/application/services/account_service.py"
      provides: "Household-scoped account service"
      contains: "household_id"
  key_links:
    - from: "src/adapters/api/routes/accounts.py"
      to: "src/adapters/api/dependencies.py"
      via: "CurrentUser dependency"
      pattern: "Depends\\(get_current_user\\)"
    - from: "src/application/services/account_service.py"
      to: "household_id"
      via: "query filter"
      pattern: "household_id"
---

<objective>
Update all existing routes to use CurrentUser authentication and update services to filter by household_id.

Purpose: Protect all API routes and scope data access to the authenticated user's household. This is refactoring/wiring work -- updating existing code to use new auth infrastructure. NOT TDD candidates (no new testable behavior, just rewiring existing flows).

Output: All routes protected, services filter by household, cross-household returns 404.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-RESEARCH.md
@src/adapters/api/routes/accounts.py
@src/adapters/api/routes/transactions.py
@src/adapters/api/routes/categories.py
@src/adapters/api/dependencies.py
@src/application/services/account_service.py
@src/application/services/transaction_service.py
</context>

<tasks>

<task id="1">
  <title>Update Account domain model and services for household scoping</title>
  <type>auto</type>
  <files>src/domain/model/account.py, src/adapters/persistence/orm/mappers.py, src/application/services/account_service.py, src/application/services/transaction_service.py, src/application/services/category_service.py</files>
  <action>
**Update Account entity with household_id:**
- Add HouseholdId import from entity_id
- Add `household_id: HouseholdId` field to Account dataclass
- Update all create methods (create_checking, create_savings, etc.) to accept and store household_id
- Update ORM mapper to include household_id column mapping

**Update AccountService:**
- Change create methods to accept `household_id: HouseholdId` instead of `user_id: UserId`
- Rename `get_user_accounts` to `get_household_accounts(household_id, ...)`
- Update get_account to verify household ownership: if account.household_id != household_id, return NOT_FOUND (not FORBIDDEN)
- Similarly update close_account, reopen_account, delete_account, update_account_name

**Update TransactionService:**
- All methods accept household_id, verify ownership for single-item access

**Update CategoryService:**
- All methods accept household_id, verify ownership
  </action>
  <verify>python -c "from src.application.services.account_service import AccountService; print('AccountService updated')"</verify>
  <done>Services accept household_id parameter and filter/verify ownership on all operations</done>
</task>

<task id="2">
  <title>Update routes to use CurrentUser dependency</title>
  <type>auto</type>
  <files>src/adapters/api/routes/accounts.py, src/adapters/api/routes/transactions.py, src/adapters/api/routes/categories.py, src/adapters/api/dependencies.py</files>
  <action>
**All route files:**
1. Update imports: `from src.adapters.api.dependencies import CurrentUser, get_current_user, get_unit_of_work`
2. Replace type alias: `CurrentUserDep = Annotated[CurrentUser, Depends(get_current_user)]`
3. Update all route handlers to accept `current_user: CurrentUserDep`
4. Pass `current_user.household_id` to service methods instead of user_id
5. Update list endpoints to use `get_household_accounts(household_id=current_user.household_id)`
6. Update get/update/delete endpoints to pass household_id for ownership verification

**dependencies.py:**
- Remove the old `get_current_user_id()` placeholder function
  </action>
  <verify>
Start app and test without auth: curl http://localhost:8000/api/v1/accounts should return 401.
Test with invalid token: curl -H "Authorization: Bearer invalid" http://localhost:8000/api/v1/accounts should return 401.
  </verify>
  <done>All routes require valid JWT, pass household_id to services, placeholder removed</done>
</task>

</tasks>

<verification>
Route protection is complete:
1. All non-auth routes return 401 without token
2. Valid token allows access
3. Services filter by household_id
4. Cross-household GET returns 404 (not 403)
5. `make lint` passes
</verification>

<success_criteria>
- CurrentUser replaces UserId in all routes
- Services use household_id for filtering
- get_account, get_transaction, get_category verify household ownership
- Cross-household access returns 404 (security: prevents probing)
- All routes except /auth/*, /health, /docs are protected
- Old get_current_user_id placeholder removed
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-07-SUMMARY.md`
</output>
