---
phase: 04-authentication-infrastructure
plan: 07
type: tdd
wave: 4
depends_on: ["04-03", "04-06"]
files_modified:
  - src/adapters/api/routes/accounts.py
  - src/adapters/api/routes/transactions.py
  - src/adapters/api/routes/categories.py
  - src/adapters/api/dependencies.py
  - src/application/services/account_service.py
  - src/application/services/transaction_service.py
  - src/application/services/category_service.py
  - src/domain/model/account.py
  - src/adapters/persistence/orm/mappers.py
  - tests/integration/api/test_auth.py
autonomous: true

must_haves:
  truths:
    - "All non-auth routes require valid JWT (401 without token)"
    - "Services filter data by household_id from CurrentUser"
    - "Cross-household access returns 404 (not 403)"
    - "Protected route tests verify 401 without token and 200 with token"
  artifacts:
    - path: "src/adapters/api/routes/accounts.py"
      provides: "Protected account routes"
      contains: "get_current_user"
    - path: "src/application/services/account_service.py"
      provides: "Household-scoped account service"
      contains: "household_id"
    - path: "tests/integration/api/test_auth.py"
      provides: "Route protection tests"
      contains: "TestProtectedRoutes"
  key_links:
    - from: "src/adapters/api/routes/accounts.py"
      to: "src/adapters/api/dependencies.py"
      via: "CurrentUser dependency"
      pattern: "Depends\\(get_current_user\\)"
    - from: "src/application/services/account_service.py"
      to: "household_id"
      via: "query filter"
      pattern: "household_id"
    - from: "tests/integration/api/test_auth.py"
      to: "src/adapters/api/routes/accounts.py"
      via: "HTTP requests to protected endpoints"
      pattern: "test_accounts_requires_auth"
---

<objective>
Update all existing routes to use CurrentUser authentication, update services to filter by household_id, and verify route protection with TDD.

Purpose: Protect all API routes and scope data access to the authenticated user's household. TDD approach: write failing tests for route protection first (expect 401 without token, 200 with token), then update routes and services to make them pass.

Output: All routes protected, services filter by household, cross-household returns 404, route protection tests pass.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-RESEARCH.md
@.planning/phases/04-authentication-infrastructure/04-06-SUMMARY.md
@src/adapters/api/routes/accounts.py
@src/adapters/api/routes/transactions.py
@src/adapters/api/routes/categories.py
@src/adapters/api/dependencies.py
@src/application/services/account_service.py
@src/application/services/transaction_service.py
@tests/integration/api/test_auth.py
</context>

<tasks>

<task id="1">
  <title>RED: Write failing route protection tests</title>
  <type>test</type>
  <files>tests/integration/api/test_auth.py</files>
  <action>
Add a TestProtectedRoutes class to the existing tests/integration/api/test_auth.py file (created in plan 06). This is the RED phase -- these tests must FAIL because routes are not yet protected.

```python
class TestProtectedRoutes:
    """Verify that non-auth routes require valid JWT."""

    def test_accounts_requires_auth(self, client) -> None:
        """GET /api/v1/accounts without token returns 401."""
        response = client.get("/api/v1/accounts")
        assert response.status_code == 401

    def test_accounts_with_valid_token(self, client, auth_headers) -> None:
        """GET /api/v1/accounts with valid token returns 200."""
        response = client.get("/api/v1/accounts", headers=auth_headers)
        assert response.status_code == 200

    def test_accounts_with_invalid_token(self, client) -> None:
        """GET /api/v1/accounts with invalid token returns 401."""
        response = client.get(
            "/api/v1/accounts",
            headers={"Authorization": "Bearer invalid-token"},
        )
        assert response.status_code == 401
```

Run the tests. They should FAIL because routes currently don't require authentication (they return 200 without a token).
  </action>
  <verify>pytest tests/integration/api/test_auth.py::TestProtectedRoutes -x -v (should FAIL - routes not yet protected)</verify>
  <done>TestProtectedRoutes class added with 3 tests, all fail because routes accept unauthenticated requests</done>
</task>

<task id="2">
  <title>GREEN: Update domain models, services, and routes for household scoping and auth</title>
  <type>impl</type>
  <files>src/domain/model/account.py, src/adapters/persistence/orm/mappers.py, src/application/services/account_service.py, src/application/services/transaction_service.py, src/application/services/category_service.py, src/adapters/api/routes/accounts.py, src/adapters/api/routes/transactions.py, src/adapters/api/routes/categories.py, src/adapters/api/dependencies.py</files>
  <action>
Implement route protection and household scoping to make the failing TestProtectedRoutes tests pass. This is the GREEN phase.

**Update Account entity with household_id:**
- Add HouseholdId import from entity_id
- Add `household_id: HouseholdId` field to Account dataclass
- Update all create methods (create_checking, create_savings, etc.) to accept and store household_id
- Update ORM mapper to include household_id column mapping

**Update AccountService:**
- Change create methods to accept `household_id: HouseholdId` instead of `user_id: UserId`
- Rename `get_user_accounts` to `get_household_accounts(household_id, ...)`
- Update get_account to verify household ownership: if account.household_id != household_id, return NOT_FOUND (not FORBIDDEN)
- Similarly update close_account, reopen_account, delete_account, update_account_name

**Update TransactionService:**
- All methods accept household_id, verify ownership for single-item access

**Update CategoryService:**
- All methods accept household_id, verify ownership

**All route files:**
1. Update imports: `from src.adapters.api.dependencies import CurrentUser, get_current_user, get_unit_of_work`
2. Replace type alias: `CurrentUserDep = Annotated[CurrentUser, Depends(get_current_user)]`
3. Update all route handlers to accept `current_user: CurrentUserDep`
4. Pass `current_user.household_id` to service methods instead of user_id
5. Update list endpoints to use `get_household_accounts(household_id=current_user.household_id)`
6. Update get/update/delete endpoints to pass household_id for ownership verification

**dependencies.py:**
- Remove the old `get_current_user_id()` placeholder function

Iterate until TestProtectedRoutes tests AND all previously passing auth tests still pass.
  </action>
  <verify>pytest tests/integration/api/test_auth.py -v (ALL tests pass, including TestProtectedRoutes)</verify>
  <done>All routes require valid JWT, pass household_id to services, placeholder removed. TestProtectedRoutes: 401 without token, 200 with token, 401 with invalid token all pass.</done>
</task>

</tasks>

<verification>
Route protection is complete:
1. All non-auth routes return 401 without token
2. Valid token allows access
3. Services filter by household_id
4. Cross-household GET returns 404 (not 403)
5. TestProtectedRoutes tests pass
6. All prior auth tests still pass
7. `make lint` passes
</verification>

<success_criteria>
- CurrentUser replaces UserId in all routes
- Services use household_id for filtering
- get_account, get_transaction, get_category verify household ownership
- Cross-household access returns 404 (security: prevents probing)
- All routes except /auth/*, /health, /docs are protected
- Old get_current_user_id placeholder removed
- TestProtectedRoutes: 3 tests pass (401 no token, 200 valid token, 401 invalid token)
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-07-SUMMARY.md`
</output>
