---
phase: 04-authentication-infrastructure
plan: 06
type: tdd
wave: 3
depends_on: ["04-02", "04-05"]
files_modified:
  - src/adapters/api/routes/auth.py
  - src/adapters/api/schemas/auth.py
  - src/adapters/api/dependencies.py
  - src/adapters/api/app.py
  - tests/unit/adapters/api/test_auth_schemas.py
autonomous: true

must_haves:
  truths:
    - "POST /auth/register creates user and returns 202"
    - "POST /auth/token returns access token in body and refresh token in cookie"
    - "POST /auth/refresh rotates refresh token and returns new access token"
    - "GET /auth/verify validates email verification token"
    - "get_current_user dependency extracts user from JWT"
  artifacts:
    - path: "src/adapters/api/routes/auth.py"
      provides: "Authentication API endpoints"
      contains: "router"
    - path: "src/adapters/api/schemas/auth.py"
      provides: "Auth request/response schemas"
      contains: "RegisterRequest"
    - path: "src/adapters/api/dependencies.py"
      provides: "get_current_user dependency"
      contains: "get_current_user"
  key_links:
    - from: "src/adapters/api/routes/auth.py"
      to: "src/application/services/auth_service.py"
      via: "AuthService dependency"
      pattern: "AuthService"
    - from: "src/adapters/api/dependencies.py"
      to: "src/adapters/security/jwt.py"
      via: "decode_access_token"
      pattern: "decode_access_token"
---

<objective>
Create authentication API routes, Pydantic schemas, and the get_current_user dependency using TDD.

Purpose: Expose authentication endpoints (register, login, refresh, verify-email) and provide the dependency that all protected routes will use. TDD ensures schema validation and route behavior are specified before wiring.

Output: Auth routes, Pydantic schemas (with password validation tests), CurrentUser dependency, router registered in app.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-authentication-infrastructure/04-CONTEXT.md
@.planning/phases/04-authentication-infrastructure/04-RESEARCH.md
@src/adapters/api/routes/accounts.py
@src/adapters/api/schemas/account.py
@src/adapters/api/dependencies.py
@src/adapters/api/app.py
</context>

<tasks>

<task id="1">
  <title>Write failing tests for auth Pydantic schemas</title>
  <type>test</type>
  <files>tests/unit/adapters/api/test_auth_schemas.py</files>
  <action>
Create test file for auth schema validation, particularly password complexity:

```python
"""Tests for auth request/response schemas."""

import pytest
from pydantic import ValidationError


class TestRegisterRequestPasswordValidation:
    """Tests for RegisterRequest password complexity rules."""

    def test_valid_password_accepted(self) -> None:
        """Valid password passes validation."""
        from src.adapters.api.schemas.auth import RegisterRequest

        req = RegisterRequest(
            email="test@example.com",
            password="ValidPass123!",
            display_name="Test",
        )
        assert req.password == "ValidPass123!"

    def test_password_too_short_rejected(self) -> None:
        """Password under 8 chars is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="8 characters"):
            RegisterRequest(
                email="test@example.com",
                password="Ab1!",
                display_name="Test",
            )

    def test_password_no_uppercase_rejected(self) -> None:
        """Password without uppercase is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="uppercase"):
            RegisterRequest(
                email="test@example.com",
                password="alllowercase1!",
                display_name="Test",
            )

    def test_password_no_lowercase_rejected(self) -> None:
        """Password without lowercase is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="lowercase"):
            RegisterRequest(
                email="test@example.com",
                password="ALLUPPERCASE1!",
                display_name="Test",
            )

    def test_password_no_number_rejected(self) -> None:
        """Password without number is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="number"):
            RegisterRequest(
                email="test@example.com",
                password="NoNumbers!!",
                display_name="Test",
            )

    def test_password_no_symbol_rejected(self) -> None:
        """Password without symbol is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="symbol"):
            RegisterRequest(
                email="test@example.com",
                password="NoSymbol123",
                display_name="Test",
            )

    def test_invalid_email_rejected(self) -> None:
        """Invalid email format is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError):
            RegisterRequest(
                email="not-an-email",
                password="ValidPass123!",
                display_name="Test",
            )

    def test_empty_display_name_rejected(self) -> None:
        """Empty display name is rejected."""
        from src.adapters.api.schemas.auth import RegisterRequest

        with pytest.raises(ValidationError, match="empty"):
            RegisterRequest(
                email="test@example.com",
                password="ValidPass123!",
                display_name="   ",
            )
```
  </action>
  <verify>pytest tests/unit/adapters/api/test_auth_schemas.py -x (should FAIL - schemas don't exist)</verify>
  <done>Test file exists with 8 tests for schema validation, all fail with ImportError</done>
</task>

<task id="2">
  <title>Implement auth schemas and dependencies to pass tests</title>
  <type>impl</type>
  <files>src/adapters/api/schemas/auth.py, src/adapters/api/schemas/__init__.py, src/adapters/api/dependencies.py</files>
  <action>
**Create src/adapters/api/schemas/auth.py** with:
- RegisterRequest: email (EmailStr), password (with field_validator for 8+ chars, uppercase, lowercase, number, symbol), display_name (strip + not empty), household_name (optional)
- RegisterResponse: message, user_id, email
- TokenResponse: access_token, token_type="bearer", expires_in=900
- RefreshRequest: empty (token from cookie)
- VerifyEmailResponse: message, user_id, email
- ErrorResponse: detail, code

Update schemas __init__.py to export.

**Update src/adapters/api/dependencies.py** with:
- oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")
- CurrentUser dataclass (frozen, slots): user_id: UserId, household_id: HouseholdId
- get_current_user(token) -> CurrentUser: decodes JWT, extracts user_id/household_id, raises 401 on failure
- get_auth_service(uow) -> AuthService: factory dependency

Keep old get_current_user_id() for backward compatibility (removed in plan 07).
  </action>
  <verify>pytest tests/unit/adapters/api/test_auth_schemas.py -x (should PASS - all 8 schema tests)</verify>
  <done>Auth schemas with password validation and CurrentUser dependency implemented, all 8 tests pass</done>
</task>

<task id="3">
  <title>Create auth routes and register router</title>
  <type>auto</type>
  <files>src/adapters/api/routes/auth.py, src/adapters/api/routes/__init__.py, src/adapters/api/app.py</files>
  <action>
Create auth routes following FastAPI OAuth2 conventions.

**src/adapters/api/routes/auth.py:**
- POST /auth/register: Accepts RegisterRequest, calls service.register(), returns 202 with RegisterResponse. Always returns 202 even on duplicate email (enumeration protection).
- POST /auth/token: OAuth2 compatible (OAuth2PasswordRequestForm), calls service.login(), sets refresh token as HttpOnly cookie (secure=True, samesite="strict", path="/auth/refresh", max_age=7days), returns TokenResponse.
- POST /auth/refresh: Reads refresh_token from Cookie, calls service.refresh(), rotates cookie, returns TokenResponse.
- GET /auth/verify: Query param token, calls service.verify_email(), returns VerifyEmailResponse or 400.
- POST /auth/logout: Clears refresh token cookie, returns 204.

Helper functions: _set_refresh_cookie(), _clear_refresh_cookie().

Update routes __init__.py to export auth router.
Update app.py to include auth router: `app.include_router(auth_router)`.
  </action>
  <verify>python -c "from src.adapters.api.routes.auth import router; print(f'{len(router.routes)} routes')"</verify>
  <done>Auth routes implement register, login, refresh, verify-email, logout with HttpOnly cookie handling</done>
</task>

</tasks>

<verification>
Auth API is complete:
1. `pytest tests/unit/adapters/api/test_auth_schemas.py -v` - all schema tests pass
2. Schema validation rejects weak passwords
3. get_current_user dependency compiles
4. Routes registered in app
5. `make lint` passes
</verification>

<success_criteria>
- RegisterRequest validates password complexity (8 tests)
- POST /auth/register returns 202 (even on duplicate email)
- POST /auth/token is OAuth2 compatible
- Refresh token set as HttpOnly cookie with path="/auth/refresh"
- get_current_user dependency extracts user from JWT
- All auth errors return generic messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-infrastructure/04-06-SUMMARY.md`
</output>
