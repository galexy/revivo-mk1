---
phase: 03-transaction-domain
plan: 07
type: execute
wave: 5
depends_on: ["03-06"]
files_modified:
  - tests/unit/domain/test_transaction.py
  - tests/unit/domain/test_split_line.py
  - tests/unit/domain/test_category.py
  - tests/integration/test_transaction_repository.py
  - tests/integration/test_transaction_api.py
autonomous: false

must_haves:
  truths:
    - "Unit tests cover Transaction factory methods and validations"
    - "Unit tests verify split line total validation"
    - "Integration tests verify transaction CRUD via API"
    - "Integration tests verify full-text search works"
    - "All Phase 3 success criteria pass"
  artifacts:
    - path: "tests/unit/domain/test_transaction.py"
      provides: "Transaction domain unit tests"
      contains: "test_create_expense"
    - path: "tests/integration/test_transaction_api.py"
      provides: "Transaction API integration tests"
      contains: "test_create_expense_endpoint"
  key_links:
    - from: "tests/integration/test_transaction_api.py"
      to: "src/adapters/api/routes/transactions.py"
      via: "TestClient"
      pattern: "client\\.post.*transactions"
---

<objective>
Create comprehensive tests and verify Phase 3 completion

Purpose: Ensure Transaction domain works correctly through unit tests (domain logic), integration tests (persistence + API), and human verification (full user workflow).

Output: Verified, tested Transaction domain ready for Phase 4
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@tests/unit/domain/test_account.py
@tests/integration/test_account_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain unit tests</name>
  <files>
tests/unit/domain/test_transaction.py
tests/unit/domain/test_split_line.py
tests/unit/domain/test_category.py
  </files>
  <action>
Create test_transaction.py following existing test patterns:

```python
from datetime import UTC, datetime
from decimal import Decimal

import pytest

from src.domain.model.entity_id import AccountId, CategoryId, UserId
from src.domain.model.money import Money
from src.domain.model.split_line import SplitLine
from src.domain.model.transaction import Transaction
from src.domain.model.transaction_types import TransactionStatus, TransactionType


class TestTransactionFactoryMethods:
    """Test Transaction factory methods."""

    def test_create_expense_succeeds(self):
        """Should create expense with valid data."""
        txn = Transaction.create_expense(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            amount=Money(Decimal("100.00"), "USD"),
            date=datetime.now(UTC),
            payee="Grocery Store",
        )
        assert txn.transaction_type == TransactionType.EXPENSE
        assert txn.amount.amount == Decimal("100.00")
        assert txn.status == TransactionStatus.PENDING
        assert len(txn.events) == 1

    def test_create_expense_rejects_zero_amount(self):
        """Should reject zero amount."""
        with pytest.raises(ValueError, match="must be positive"):
            Transaction.create_expense(
                user_id=UserId.generate(),
                account_id=AccountId.generate(),
                amount=Money(Decimal("0"), "USD"),
                date=datetime.now(UTC),
            )

    def test_create_expense_rejects_negative_amount(self):
        """Should reject negative amount."""
        with pytest.raises(ValueError, match="must be positive"):
            Transaction.create_expense(
                user_id=UserId.generate(),
                account_id=AccountId.generate(),
                amount=Money(Decimal("-50"), "USD"),
                date=datetime.now(UTC),
            )

    def test_create_income_succeeds(self):
        """Should create income transaction."""
        txn = Transaction.create_income(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            amount=Money(Decimal("1000"), "USD"),
            date=datetime.now(UTC),
            payee="Employer",
        )
        assert txn.transaction_type == TransactionType.INCOME

    def test_create_transfer_succeeds(self):
        """Should create transfer linking two accounts."""
        from_acct = AccountId.generate()
        to_acct = AccountId.generate()
        txn = Transaction.create_transfer(
            user_id=UserId.generate(),
            from_account_id=from_acct,
            to_account_id=to_acct,
            amount=Money(Decimal("500"), "USD"),
            date=datetime.now(UTC),
        )
        assert txn.transaction_type == TransactionType.TRANSFER
        assert txn.account_id == from_acct
        assert txn.transfer_account_id == to_acct
        assert txn.is_transfer is True

    def test_create_transfer_rejects_same_account(self):
        """Should reject transfer to same account."""
        acct = AccountId.generate()
        with pytest.raises(ValueError, match="same account"):
            Transaction.create_transfer(
                user_id=UserId.generate(),
                from_account_id=acct,
                to_account_id=acct,
                amount=Money(Decimal("100"), "USD"),
                date=datetime.now(UTC),
            )

    def test_create_split_expense_succeeds(self):
        """Should create split expense with multiple categories."""
        lines = [
            SplitLine(amount=Money(Decimal("70"), "USD"), category_id=CategoryId.generate()),
            SplitLine(amount=Money(Decimal("30"), "USD"), category_id=CategoryId.generate()),
        ]
        txn = Transaction.create_split_expense(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            total_amount=Money(Decimal("100"), "USD"),
            split_lines=lines,
            date=datetime.now(UTC),
        )
        assert txn.is_split is True
        assert len(txn.split_lines) == 2

    def test_create_split_expense_validates_total(self):
        """Should reject split where lines don't sum to total."""
        lines = [
            SplitLine(amount=Money(Decimal("50"), "USD"), category_id=CategoryId.generate()),
            SplitLine(amount=Money(Decimal("30"), "USD"), category_id=CategoryId.generate()),
        ]
        with pytest.raises(ValueError, match="sum.*equal"):
            Transaction.create_split_expense(
                user_id=UserId.generate(),
                account_id=AccountId.generate(),
                total_amount=Money(Decimal("100"), "USD"),
                split_lines=lines,
                date=datetime.now(UTC),
            )


class TestTransactionMutations:
    """Test Transaction mutation methods."""

    def test_update_payee(self):
        """Should update payee and emit event."""
        txn = Transaction.create_expense(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            amount=Money(Decimal("50"), "USD"),
            date=datetime.now(UTC),
            payee="Original",
        )
        txn.clear_events()

        txn.update_payee("Updated Payee")

        assert txn.payee == "Updated Payee"
        assert len(txn.events) == 1
        assert txn.events[0].field == "payee"

    def test_update_category_on_split_raises(self):
        """Should not allow category update on split transaction."""
        lines = [SplitLine(amount=Money(Decimal("100"), "USD"), category_id=CategoryId.generate())]
        txn = Transaction.create_split_expense(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            total_amount=Money(Decimal("100"), "USD"),
            split_lines=lines,
            date=datetime.now(UTC),
        )

        with pytest.raises(ValueError, match="split"):
            txn.update_category(CategoryId.generate())

    def test_update_category_on_transfer_raises(self):
        """Should not allow category on transfer."""
        txn = Transaction.create_transfer(
            user_id=UserId.generate(),
            from_account_id=AccountId.generate(),
            to_account_id=AccountId.generate(),
            amount=Money(Decimal("100"), "USD"),
            date=datetime.now(UTC),
        )

        with pytest.raises(ValueError, match="Transfers"):
            txn.update_category(CategoryId.generate())

    def test_mark_cleared(self):
        """Should mark transaction as cleared."""
        txn = Transaction.create_expense(
            user_id=UserId.generate(),
            account_id=AccountId.generate(),
            amount=Money(Decimal("50"), "USD"),
            date=datetime.now(UTC),
        )

        txn.mark_cleared()

        assert txn.status == TransactionStatus.CLEARED
        assert txn.cleared_at is not None
```

Create test_split_line.py:
```python
def test_split_line_rejects_negative():
    """Should reject negative split line amount."""
    ...

def test_split_line_rejects_zero():
    """Should reject zero split line amount."""
    ...
```

Create test_category.py:
```python
def test_category_create():
    """Should create category with name."""
    ...

def test_category_update_name_empty_raises():
    """Should reject empty name."""
    ...
```
  </action>
  <verify>Run: `pytest tests/unit/domain/test_transaction.py tests/unit/domain/test_split_line.py tests/unit/domain/test_category.py -v`</verify>
  <done>Unit tests pass for Transaction, SplitLine, Category domain models</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests</name>
  <files>
tests/integration/test_transaction_repository.py
tests/integration/test_transaction_api.py
  </files>
  <action>
Create test_transaction_repository.py:
```python
import pytest
from datetime import UTC, datetime
from decimal import Decimal

from src.adapters.persistence.unit_of_work import SqlAlchemyUnitOfWork
from src.domain.model.entity_id import AccountId, CategoryId, UserId
from src.domain.model.money import Money
from src.domain.model.transaction import Transaction


@pytest.fixture
def user_id():
    return UserId.generate()


@pytest.fixture
def account_id():
    return AccountId.generate()


class TestTransactionRepository:
    def test_add_and_get_expense(self, uow, user_id, account_id):
        """Should persist and retrieve expense transaction."""
        with uow:
            txn = Transaction.create_expense(
                user_id=user_id,
                account_id=account_id,
                amount=Money(Decimal("100"), "USD"),
                date=datetime.now(UTC),
                payee="Test Payee",
            )
            uow.transactions.add(txn)
            uow.commit()

        with uow:
            retrieved = uow.transactions.get(txn.id)
            assert retrieved is not None
            assert retrieved.amount.amount == Decimal("100")
            assert retrieved.payee == "Test Payee"

    def test_add_and_get_split_expense(self, uow, user_id, account_id):
        """Should persist and retrieve split transaction with lines."""
        # Test split_lines are persisted and loaded

    def test_search_by_payee(self, uow, user_id, account_id):
        """Should find transactions by full-text search."""
        # Create transaction with payee "Whole Foods"
        # Search for "whole" - should find it

    def test_calculate_account_balance_expenses(self, uow, user_id, account_id):
        """Should calculate balance correctly for expenses."""
        # Create multiple expenses, verify balance is negative sum

    def test_calculate_account_balance_transfers(self, uow, user_id):
        """Should handle transfers correctly in balance."""
        # Create transfer, verify source is debited, dest is credited
```

Create test_transaction_api.py:
```python
import pytest
from datetime import UTC, datetime
from fastapi.testclient import TestClient

from src.adapters.api.app import app


@pytest.fixture
def client():
    return TestClient(app)


class TestTransactionAPI:
    def test_create_expense_endpoint(self, client):
        """Should create expense via API."""
        response = client.post(
            "/api/v1/transactions/expense",
            json={
                "account_id": "acct_01h455vb4pex5vsknk084sn02q",  # Need valid account
                "amount": {"amount": "100.00", "currency": "USD"},
                "date": datetime.now(UTC).isoformat(),
                "payee": "Test Store",
            },
        )
        # May fail without valid account - adjust as needed
        assert response.status_code in [201, 404]

    def test_create_transfer_endpoint(self, client):
        """Should create transfer via API."""
        ...

    def test_list_transactions_filter_by_account(self, client):
        """Should filter transactions by account_id."""
        ...

    def test_search_transactions(self, client):
        """Should search transactions by query."""
        response = client.get("/api/v1/transactions/search?q=grocery")
        assert response.status_code == 200
        assert "transactions" in response.json()

    def test_add_attachment(self, client):
        """Should upload attachment to transaction."""
        # Create transaction first, then upload file

    def test_category_crud(self, client):
        """Should create, update, delete category."""
        # POST, GET, PATCH, DELETE
```

Note: Integration tests may need fixtures to create accounts first since transactions require valid account_id. Use the existing account fixtures from Phase 2.
  </action>
  <verify>Run: `pytest tests/integration/test_transaction_repository.py tests/integration/test_transaction_api.py -v`</verify>
  <done>Integration tests pass for repository and API</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Phase 3 Success Criteria</name>
  <what-built>
Complete Transaction domain with:
- Transaction aggregate (expense, income, transfer, split)
- Category entity with hierarchy
- Attachment entity with file storage
- Full-text search
- REST API endpoints
- Negative balance prevention
  </what-built>
  <how-to-verify>
Verify each Phase 3 success criterion:

1. **Create, edit, delete transactions (TRAN-01, 02, 03)**
   ```bash
   # Start the API server
   uvicorn src.adapters.api.app:app --reload

   # Create expense
   curl -X POST http://localhost:8000/api/v1/transactions/expense \
     -H "Content-Type: application/json" \
     -d '{
       "account_id": "[YOUR_ACCOUNT_ID]",
       "amount": {"amount": "50.00", "currency": "USD"},
       "date": "2026-01-30T10:00:00Z",
       "payee": "Grocery Store",
       "category_id": "[YOUR_CATEGORY_ID]"
     }'

   # Update transaction
   curl -X PATCH http://localhost:8000/api/v1/transactions/[TXN_ID] \
     -H "Content-Type: application/json" \
     -d '{"payee": "Updated Payee"}'

   # Delete transaction
   curl -X DELETE http://localhost:8000/api/v1/transactions/[TXN_ID]
   ```
   Expected: 201 for create, 200 for update, 204 for delete

2. **Split transactions (TRAN-05)**
   ```bash
   curl -X POST http://localhost:8000/api/v1/transactions/split \
     -H "Content-Type: application/json" \
     -d '{
       "account_id": "[YOUR_ACCOUNT_ID]",
       "total_amount": {"amount": "100.00", "currency": "USD"},
       "split_lines": [
         {"amount": {"amount": "70.00", "currency": "USD"}, "category_id": "[CAT_1]"},
         {"amount": {"amount": "30.00", "currency": "USD"}, "category_id": "[CAT_2]"}
       ],
       "date": "2026-01-30T10:00:00Z"
     }'
   ```
   Expected: 201 with split_lines in response

3. **Transfer between accounts (TRAN-06)**
   ```bash
   curl -X POST http://localhost:8000/api/v1/transactions/transfer \
     -H "Content-Type: application/json" \
     -d '{
       "from_account_id": "[ACCOUNT_1]",
       "to_account_id": "[ACCOUNT_2]",
       "amount": {"amount": "500.00", "currency": "USD"},
       "date": "2026-01-30T10:00:00Z"
     }'
   ```
   Expected: 201 with transaction_type="transfer"

4. **Attachments (TRAN-07, TRAN-08)**
   ```bash
   # Add attachment
   curl -X POST http://localhost:8000/api/v1/transactions/[TXN_ID]/attachments \
     -F "file=@receipt.jpg"

   # Get attachments
   curl http://localhost:8000/api/v1/transactions/[TXN_ID]/attachments
   ```
   Expected: File uploads successfully, list shows attachment

5. **Search and filter (TRAN-09, TRAN-10, TRAN-11)**
   ```bash
   # Full-text search
   curl "http://localhost:8000/api/v1/transactions/search?q=grocery"

   # Filter by account
   curl "http://localhost:8000/api/v1/transactions?account_id=[ACCT_ID]"

   # Filter by date range
   curl "http://localhost:8000/api/v1/transactions?date_from=2026-01-01&date_to=2026-01-31"
   ```
   Expected: Returns filtered transaction list

6. **Run all tests**
   ```bash
   pytest tests/ -v
   lint-imports
   ```
   Expected: All tests pass, no import violations
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 complete when:
1. All unit tests pass
2. All integration tests pass
3. lint-imports passes (domain independence)
4. Human verification confirms success criteria
</verification>

<success_criteria>
Phase 3 Success Criteria (from ROADMAP.md):
1. User can create, edit, and delete transactions with date, amount, payee, category, and account
2. User can split a transaction across multiple categories with specific amounts
3. User can record a transfer between two accounts as a single transaction that affects both balances
4. User can attach receipt files to transactions and view all attachments
5. User can search and filter transactions by payee, category, amount, date, or account
</success_criteria>

<output>
After completion, create `.planning/phases/03-transaction-domain/03-07-SUMMARY.md`
</output>
