---
phase: 03-transaction-domain
plan: 07
task: integration-test-gaps
status: ready_to_execute
last_updated: 2026-02-02
---

# Phase 3 Continuation: Integration Test Gaps + UAT

## Context

Phase 3 Transaction Domain implementation is complete. During UAT verification, we identified 13 additional edge case scenarios. 2 are already covered by integration tests, 11 need new tests.

## Completed Work

- Plans 01-06: All complete and committed
- Plan 07 Tasks 1-2: Category and Transaction API integration tests committed
- UAT Tests 1-15: All passed (1 minor issue logged - 500 on invalid IDs)
- UAT Tests 16-28: Added but not yet executed

## Remaining Work

### Task A: Add 11 Missing Integration Tests

Add these tests to `tests/integration/test_transaction_api.py`:

```python
# 1. Mixed splits: category + transfer in same transaction
def test_mixed_category_and_transfer_splits(self, client, test_account):
    """Transaction with both category and transfer splits should work."""
    # Create credit card account and category
    # Create transaction: -500 transfer to CC, +20 cash back category
    # Verify transaction created with both splits
    # Verify mirror created for transfer portion only

# 2. Positive transfer split (should fail)
def test_positive_transfer_split_rejected(self, client, test_account):
    """Transfer splits must be negative (outgoing)."""
    # Try to create transaction with positive transfer split
    # Should return 400

# 3. Mixed income/expense splits
def test_mixed_income_expense_splits(self, client, test_account):
    """Transaction can have both positive and negative splits (refund scenario)."""
    # Create: +100 refund, -15 restocking fee = +85 net
    # Should succeed

# 4. Empty splits array
def test_empty_splits_rejected(self, client, test_account):
    """Transaction must have at least one split."""
    # Try to create with splits: []
    # Should return 400

# 5. Cannot reconcile pending transaction
def test_cannot_reconcile_pending(self, client, test_account, test_category):
    """Must clear before reconciling."""
    # Create pending transaction
    # Try to reconcile without clearing
    # Should return 400

# 6. Cannot PATCH mirror directly
def test_cannot_patch_mirror(self, client, test_account):
    """Mirror transactions cannot be modified directly."""
    # Create transfer (creates mirror)
    # Try to PATCH the mirror
    # Should return 400

# 7. Update transfer amount syncs mirror
def test_update_transfer_syncs_mirror(self, client, test_account):
    """Updating source transfer amount should update mirror."""
    # Create transfer -500
    # PATCH to change to -600
    # Verify mirror now shows +600

# 8. Delete category with transactions fails
def test_cannot_delete_category_with_transactions(self, client, test_account, test_category):
    """Cannot delete category that has transactions."""
    # Create transaction using category
    # Try to delete category
    # Should return 400

# 9. Transaction with subcategory
def test_transaction_with_subcategory(self, client, test_account):
    """Can assign transaction to subcategory."""
    # Create parent category
    # Create child category
    # Create transaction with child category
    # Should succeed

# 10. Split with both category AND transfer (invalid)
def test_split_with_both_category_and_transfer_rejected(self, client, test_account):
    """Single split cannot have both category_id and transfer_account_id."""
    # Try to create split with both fields
    # Should return 400

# 11. Multiple transfers in one transaction
def test_multiple_transfers_in_transaction(self, client, test_account):
    """Can split transfer across multiple destination accounts."""
    # Create savings and investment accounts
    # Create transaction: -600 to savings, -400 to investment
    # Verify both mirrors created
```

### Task B: Execute Manual UAT Tests 16-28

After integration tests pass, manually verify each scenario via curl commands in UAT file.

### Task C: Complete UAT and Update STATE.md

- Mark all UAT tests as pass/fail
- Update STATE.md with Phase 3 completion
- Update ROADMAP.md to mark Phase 3 complete

## Files to Modify

- `tests/integration/test_transaction_api.py` - Add 11 new tests
- `tests/integration/test_category_api.py` - Add category deletion test (if not in transaction tests)
- `.planning/phases/03-transaction-domain/03-UAT.md` - Update test results
- `.planning/STATE.md` - Update on completion
- `.planning/ROADMAP.md` - Mark Phase 3 complete

## Commands

```bash
# Run new integration tests
pytest tests/integration/test_transaction_api.py -v --tb=short -k "test_mixed_category\|test_positive_transfer\|test_mixed_income\|test_empty_splits\|test_cannot_reconcile\|test_cannot_patch\|test_update_transfer\|test_cannot_delete_category\|test_transaction_with_subcategory\|test_split_with_both\|test_multiple_transfers"

# Run all integration tests
pytest tests/integration/ -v --tb=short

# Start API for manual UAT
uvicorn src.adapters.api.app:create_app --factory --reload
```

## Resume Instructions

When resuming:
1. Read this file for context
2. Start with Task A: Add integration tests
3. Run tests to verify
4. Proceed to Task B: Manual UAT
5. Complete Task C: Update state files

## Known Issues

- UAT Test 6: Invalid IDs return 500 instead of 400/404 (minor - logged in Gaps)
