---
phase: 07-nx-monorepo-restructure
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/api/src/**
  - apps/api/tests/**
  - apps/api/alembic/**
  - apps/api/pyproject.toml
  - apps/api/project.json
  - alembic.ini
  - docker-compose.yml
  - docker-compose.override.yml
  - .devcontainer/devcontainer.json
  - Makefile
  - scripts/**
autonomous: true

must_haves:
  truths:
    - "Backend source code lives at apps/api/src/"
    - "Backend tests live at apps/api/tests/"
    - "Alembic migrations live at apps/api/alembic/"
    - "apps/api is a registered Nx project with serve, test, lint targets"
    - "Docker Compose still starts the app service successfully"
  artifacts:
    - path: "apps/api/project.json"
      provides: "Backend API Nx project definition"
      contains: "\"name\": \"api\""
    - path: "apps/api/pyproject.toml"
      provides: "API-specific Python project config"
      contains: "personal-finance-api"
    - path: "apps/api/src/main.py"
      provides: "FastAPI application entry point"
      contains: "app"
    - path: "apps/api/alembic/env.py"
      provides: "Alembic migration environment"
      contains: "target_metadata"
  key_links:
    - from: "apps/api/project.json"
      to: "apps/api/src/"
      via: "sourceRoot configuration"
      pattern: "apps/api/src"
    - from: "alembic.ini"
      to: "apps/api/alembic"
      via: "script_location"
      pattern: "script_location = apps/api/alembic"
    - from: "docker-compose.yml"
      to: "apps/api/"
      via: "volume mount or working directory"
      pattern: "apps/api"
---

<objective>
Move the entire backend (source, tests, alembic, scripts) into apps/api/ and update all configuration to reference the new paths.

Purpose: Establish the backend as an Nx-managed app at apps/api/ per user decisions. This is the core file restructure that everything else builds on.

Output: All backend code at apps/api/, Docker/Alembic/devcontainer configs updated, Nx project registered.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nx-monorepo-restructure/07-CONTEXT.md
@.planning/phases/07-nx-monorepo-restructure/07-RESEARCH.md
@.planning/phases/07-nx-monorepo-restructure/07-01-SUMMARY.md
@pyproject.toml
@alembic.ini
@docker-compose.yml
@docker-compose.override.yml
@.devcontainer/devcontainer.json
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move backend files to apps/api/ using git mv</name>
  <files>apps/api/src/, apps/api/tests/, apps/api/alembic/, apps/api/pyproject.toml</files>
  <action>
  Use `git mv` for all moves to preserve history:

  1. Create directory structure:
     ```bash
     mkdir -p apps/api
     ```

  2. Move source code:
     ```bash
     git mv src/ apps/api/src/
     ```

  3. Move tests:
     ```bash
     git mv tests/ apps/api/tests/
     ```

  4. Move alembic:
     ```bash
     git mv alembic/ apps/api/alembic/
     ```

  5. Move scripts:
     ```bash
     git mv scripts/ apps/api/scripts/
     ```

  6. Move docs:
     ```bash
     git mv docs/ apps/api/docs/
     ```

  7. Create `apps/api/pyproject.toml` for the API project as a uv workspace member. This should contain the project-specific dependencies (all current dependencies from root pyproject.toml):
     ```toml
     [project]
     name = "personal-finance-api"
     version = "0.1.0"
     description = "Personal Finance API backend"
     requires-python = ">=3.12"

     dependencies = [
         # Read the current root pyproject.toml and copy the FULL [project] dependencies
         # list verbatim into this section. As of this writing, the dependencies are:
         #   "fastapi>=0.115.0",
         #   "uvicorn>=0.34.0",
         #   "pydantic[email]>=2.10.0",
         #   "pydantic-settings>=2.7.0",
         #   "sqlalchemy>=2.0.36",
         #   "alembic>=1.14.0",
         #   "asyncpg>=0.30.0",
         #   "psycopg2-binary>=2.9.10",
         #   "structlog>=24.4.0",
         #   "cryptography>=43.0.0",
         #   "typeid-python>=0.3.0",
         #   "returns>=0.23.0",
         #   "PyJWT>=2.11.0",
         #   "pwdlib[argon2]>=0.3.0",
         #   "itsdangerous>=2.2.0",
         #   "python-multipart>=0.0.9",
         #   "procrastinate>=3.5.0",
         #   "psycopg[binary]>=3.2.0",
         #   "Jinja2>=3.1.0",
         # The executor MUST read the root pyproject.toml at execution time and copy
         # the actual current values, since they may have changed since planning.
     ]

     [build-system]
     requires = ["hatchling"]
     build-backend = "hatchling.build"

     [tool.hatch.build.targets.wheel]
     packages = ["src"]
     ```
     Copy the full dependency list from the current root pyproject.toml.

  8. Update root `pyproject.toml` to become a workspace root:
     - Change name to "personal-finance-workspace"
     - Remove `[project] dependencies` (moved to apps/api)
     - Add `[tool.uv.workspace]` with `members = ["apps/api", "libs/domain"]`
     - Keep `[tool.uv] dev-dependencies` at root level (shared dev tools)
     - Keep ALL tool config sections (ruff, mypy, pytest, coverage, importlinter) at root for now
     - Update `[tool.pytest.ini_options] testpaths` to `["apps/api/tests"]`
     - Update `[tool.coverage.run] source` to `["apps/api/src"]`
     - Update `[tool.importlinter] root_packages` to reflect new paths
     - Update `[tool.ruff.lint.isort] known-first-party` to `["src", "domain"]`

  9. Commit this move: `git add -A && git commit -m "refactor(07): move backend to apps/api/"`

  IMPORTANT: Use `git mv` for EVERY file move to preserve git history. Do NOT use plain `mv` or `cp`.
  </action>
  <verify>
  - `ls apps/api/src/main.py` exists
  - `ls apps/api/tests/conftest.py` exists
  - `ls apps/api/alembic/env.py` exists
  - `git log --follow apps/api/src/main.py` shows history
  - No files remain at old locations: `ls src/ tests/ alembic/ scripts/ docs/` should all fail
  </verify>
  <done>All backend files moved to apps/api/ via git mv with history preserved</done>
</task>

<task type="auto">
  <name>Task 2: Update configuration files for new backend location</name>
  <files>alembic.ini, docker-compose.yml, docker-compose.override.yml, .devcontainer/devcontainer.json, Makefile, apps/api/project.json, .pre-commit-config.yaml</files>
  <action>
  Update all config files that reference backend paths:

  1. **alembic.ini** (stays at repo root per research recommendation):
     - Update `script_location = apps/api/alembic`
     - Update `prepend_sys_path` to `. apps/api` (adds both root and api to path)

  2. **docker-compose.yml**:
     - The volume mount `.:/workspace:cached` still works (mounts entire repo)
     - Update app service environment or command paths if they reference `src/` directly
     - No major changes needed since the workspace root is still mounted

  3. **docker-compose.override.yml**:
     - Volume mount `.:/workspace:cached` still correct
     - No changes needed

  4. **.devcontainer/devcontainer.json**:
     - `workspaceFolder` stays `/workspace`
     - `postCreateCommand`: update to `uv sync && npm ci` (uv workspace handles member resolution)
     - No path changes needed since workspace root is the mount point

  5. **Makefile**:
     - Update `build-emails` target paths from `src/adapters/email/templates/` to `apps/api/src/adapters/email/templates/`

  6. **Create `apps/api/project.json`**:
     ```json
     {
       "name": "api",
       "projectType": "application",
       "sourceRoot": "apps/api/src",
       "targets": {
         "serve": {
           "executor": "nx:run-commands",
           "options": {
             "command": "uvicorn src.adapters.api.app:app --host 0.0.0.0 --port 8000 --reload",
             "cwd": "apps/api"
           }
         },
         "test": {
           "executor": "nx:run-commands",
           "options": {
             "command": "python -m pytest tests/ -v --tb=short",
             "cwd": "apps/api"
           },
           "inputs": ["{projectRoot}/**/*.py", "libs/domain/**/*.py"],
           "outputs": []
         },
         "lint": {
           "executor": "nx:run-commands",
           "options": {
             "command": "ruff check src/ tests/",
             "cwd": "apps/api"
           },
           "inputs": ["{projectRoot}/**/*.py"],
           "outputs": []
         }
       }
     }
     ```

  7. **.pre-commit-config.yaml**:
     - No path changes needed (ruff and mypy operate on git-tracked files)
     - import-linter will need pyproject.toml updates (done in Task 1)

  8. **apps/api/alembic/env.py**:
     - Verify `import src.adapters.persistence.orm.tables` still resolves
     - If using `prepend_sys_path = . apps/api` in alembic.ini, the import path `src.adapters...` will resolve from apps/api/

  9. Commit config updates: `git add -A && git commit -m "chore(07): update configs for apps/api/ structure"`
  </action>
  <verify>
  - `cat alembic.ini | grep script_location` shows `apps/api/alembic`
  - `npx nx show projects` includes "api"
  - `cat apps/api/project.json` shows valid Nx project config
  - `cat Makefile` references `apps/api/src/adapters/email/templates/`
  </verify>
  <done>All configuration files updated to reference apps/api/ paths, Nx project registered for API</done>
</task>

<task type="auto">
  <name>Task 3: Verify backend works at new location</name>
  <files>none (verification only)</files>
  <action>
  Run a comprehensive verification that the backend still works after the move:

  1. Run `uv sync` from workspace root to ensure dependency resolution works with workspace layout
  2. Run `python -m pytest apps/api/tests/ -x -q` to verify all 444 tests pass
  3. Run `alembic upgrade head` to verify migrations apply against real database
  4. Start the service: `cd apps/api && uvicorn src.adapters.api.app:app --host 0.0.0.0 --port 8000 &`
  5. Smoke test: `curl -s http://localhost:8000/docs | head -5`
  6. Stop the service
  7. Run `npx nx test api` to verify Nx can run the test target
  8. Run `npx nx lint api` to verify Nx can run the lint target

  If ANY test fails, debug and fix the path issue before proceeding. Common issues:
  - PYTHONPATH not including apps/api (fix via uv workspace editable install or prepend_sys_path)
  - conftest.py sys.path manipulation needed
  - alembic can't find tables metadata (fix env.py imports)

  Do NOT skip this verification. The entire phase depends on the backend working at its new location.
  </action>
  <verify>
  - `python -m pytest apps/api/tests/ -x -q` shows 444 tests passed
  - `alembic upgrade head` succeeds
  - `curl -s http://localhost:8000/docs` returns HTML
  - `npx nx test api` succeeds
  </verify>
  <done>All 444 tests pass, migrations work, service starts, Nx commands work for API project</done>
</task>

</tasks>

<verification>
- All backend code at apps/api/ with git history preserved
- All 444 tests pass from new location
- Alembic migrations apply successfully
- Service starts and responds
- Nx recognizes api project and can run targets
- Docker Compose still works
</verification>

<success_criteria>
- Backend at apps/api/src/ with all tests passing
- Alembic at apps/api/alembic/ with migrations working
- Tests at apps/api/tests/ with all 444 passing
- Nx project.json for api with serve/test/lint targets
- Docker/devcontainer configs updated for new paths
</success_criteria>

<output>
After completion, create `.planning/phases/07-nx-monorepo-restructure/07-02-SUMMARY.md`
</output>
