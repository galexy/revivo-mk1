---
phase: 07-nx-monorepo-restructure
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - CLAUDE.md
  - .planning/ROADMAP.md
  - pyproject.toml
  - apps/api/tests/conftest.py
  - apps/api/tests/integration/conftest.py
autonomous: true

must_haves:
  truths:
    - "CLAUDE.md documents monorepo directory layout and import conventions"
    - "All 444 tests pass after full restructure"
    - "Nx commands (test, lint, serve) work for api, domain, web, ui projects"
    - "Service starts and responds to API requests at new location"
    - "Alembic migrations apply cleanly from new location"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Project-wide monorepo instructions"
      contains: "apps/api"
    - path: "nx.json"
      provides: "Nx workspace configuration"
      contains: "namedInputs"
    - path: "apps/api/project.json"
      provides: "API project Nx config"
      contains: "\"name\": \"api\""
    - path: "libs/domain/project.json"
      provides: "Domain library Nx config"
      contains: "\"name\": \"domain\""
    - path: "apps/web/project.json"
      provides: "Web app Nx config"
      contains: "\"name\": \"web\""
    - path: "libs/ui/project.json"
      provides: "UI library Nx config"
      contains: "\"name\": \"ui\""
  key_links:
    - from: "CLAUDE.md"
      to: "apps/"
      via: "documentation of monorepo structure"
      pattern: "apps/api|apps/web|libs/domain|libs/ui"
---

<objective>
Update CLAUDE.md with monorepo conventions and run the final end-to-end verification that everything works after the full restructure.

Purpose: Document the new monorepo structure for future Claude sessions and verify the entire phase is complete with all tests passing, Nx commands working, and the service operational.

Output: Updated CLAUDE.md with monorepo docs, confirmed working state, phase ready for completion.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nx-monorepo-restructure/07-CONTEXT.md
@.planning/phases/07-nx-monorepo-restructure/07-RESEARCH.md
@.planning/phases/07-nx-monorepo-restructure/07-03-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLAUDE.md with monorepo structure and conventions</name>
  <files>CLAUDE.md, .planning/ROADMAP.md</files>
  <action>
  Rewrite CLAUDE.md to document the Nx monorepo structure. The file should include:

  1. **Overview** section (update existing):
     - "Python FastAPI + PostgreSQL monorepo managed by Nx"
     - Docker Compose setup stays the same
     - Mention uv workspaces for Python dependency management

  2. **Monorepo Structure** section (new):
     ```
     ## Monorepo Structure

     Managed by Nx with uv workspaces for Python projects.

     ```
     /
     ├── apps/
     │   ├── api/          # FastAPI backend (Python)
     │   │   ├── src/      # Source code (adapters, application, main.py)
     │   │   ├── tests/    # Integration and unit tests (minus domain)
     │   │   ├── alembic/  # Database migrations
     │   │   ├── scripts/  # Operational scripts
     │   │   └── docs/     # Runbooks
     │   └── web/          # React frontend (Phase 8+)
     ├── libs/
     │   ├── domain/       # Shared domain layer (Python)
     │   │   ├── domain/   # Domain models, events, ports
     │   │   └── tests/    # Domain unit tests
     │   └── ui/           # shadcn/ui components (Phase 8+)
     ├── nx.json           # Nx workspace config
     ├── pyproject.toml    # Root workspace config (dev deps, tool config)
     └── alembic.ini       # Alembic config (points to apps/api/alembic/)
     ```

  3. **Import Conventions** section (new):
     ```
     ## Import Conventions

     - Domain layer: `from domain.model.account import Account` (shared library)
     - API internals: `from src.adapters.api.app import create_app` (app-local)
     - Application layer: `from src.application.services.account_service import AccountService`
     - Never use `src.domain.*` — domain is a separate package
     ```

  4. **Nx Commands** section (new):
     ```
     ## Nx Commands

     - `npx nx test api` — Run API tests
     - `npx nx test domain` — Run domain tests
     - `npx nx lint api` — Lint API code
     - `npx nx lint domain` — Lint domain code
     - `npx nx serve api` — Start API dev server
     - `npx nx show projects` — List all projects
     - `npx nx graph` — Visualize project dependency graph
     ```

  5. **Directory Conventions for Future Phases** section (new):
     ```
     ## Future Phase Notes

     - Phase 8 will add React + Tailwind v4 to apps/web/
     - libs/ui/ is prepared for shadcn/ui monorepo setup (https://ui.shadcn.com/docs/monorepo)
     - New shared Python libraries go in libs/ with their own pyproject.toml
     - New apps go in apps/ with project.json
     ```

  6. Keep the existing **Checkpoint Validation** and **Database Schema Changes** sections — update any paths that reference `src/` to `apps/api/src/`.

  7. **Update ROADMAP.md Phase 7 requirements**: Remove `ARCH-06, ARCH-07` from Phase 7's Requirements line. Phase 7 only creates empty frontend scaffolds (apps/web/ is an empty directory + project.json only — no React code). ARCH-06 (React frontend) and ARCH-07 (TanStack Query) belong to Phase 8. Change Phase 7 Requirements to just reference the monorepo restructure (no specific requirement codes, or use a descriptive label like "ARCH monorepo structure"). Verify Phase 8 already lists `ARCH-06` in its requirements (it does). Add `ARCH-07` to Phase 8 or Phase 10 requirements if not already there.

  8. Commit: `git add CLAUDE.md .planning/ROADMAP.md && git commit -m "docs(07): update CLAUDE.md for monorepo structure, fix ROADMAP requirements"`
  </action>
  <verify>
  - `cat CLAUDE.md` shows monorepo structure, import conventions, and Nx commands
  - CLAUDE.md references `apps/api/`, `libs/domain/`, `apps/web/`, `libs/ui/`
  - Checkpoint validation section still present with updated paths
  - `grep 'ARCH-06' .planning/ROADMAP.md` does NOT appear in Phase 7 Requirements line
  - Phase 8 Requirements in ROADMAP.md includes ARCH-06 (and ARCH-07 is in Phase 8 or 10)
  </verify>
  <done>CLAUDE.md documents monorepo layout, import conventions, Nx commands, and future shadcn/ui path. ROADMAP.md Phase 7 requirements corrected (ARCH-06/ARCH-07 moved to Phase 8).</done>
</task>

<task type="auto">
  <name>Task 2: Final end-to-end verification and smoke test</name>
  <files>none (verification only)</files>
  <action>
  Run the complete verification suite to confirm the phase is complete:

  1. **Nx project discovery:**
     ```bash
     npx nx show projects
     ```
     Must list: api, domain, web, ui

  2. **All tests pass:**
     ```bash
     python -m pytest apps/api/tests/ libs/domain/tests/ -v --tb=short -q
     ```
     Must show 444 tests passing.

  3. **Nx test targets work:**
     ```bash
     npx nx test api
     npx nx test domain
     ```

  4. **Import-linter passes:**
     ```bash
     lint-imports
     ```

  5. **Alembic migrations work:**
     ```bash
     alembic upgrade head
     alembic check
     ```

  6. **Service starts and responds (per CHECKPOINTS.md):**
     ```bash
     cd /workspace/apps/api && uvicorn src.adapters.api.app:app --host 0.0.0.0 --port 8000 &
     sleep 2
     curl -s http://localhost:8000/docs | head -5
     # Verify auth endpoint works
     curl -s -X POST http://localhost:8000/auth/register \
       -H "Content-Type: application/json" \
       -d '{"email": "smoketest@example.com", "password": "TestPass123!", "display_name": "Smoke Test"}'
     # Kill the server
     kill %1
     ```

  7. **Domain package resolves independently:**
     ```bash
     python -c "import domain; print(domain.__file__)"
     python -c "from domain.model.money import Money; m = Money(100, 'USD'); print(m)"
     ```

  8. **Git history preserved:**
     ```bash
     git log --follow --oneline apps/api/src/main.py | head -5
     git log --follow --oneline libs/domain/domain/model/money.py | head -5
     ```

  If any step fails, fix the issue before declaring the phase complete. Per CHECKPOINTS.md: "tests passing is necessary but not sufficient."
  </action>
  <verify>
  - `npx nx show projects` lists api, domain, web, ui
  - 444 tests pass
  - Nx test targets succeed for api and domain
  - `lint-imports` passes
  - `alembic check` shows no drift
  - Service starts and /docs responds
  - Domain package imports work standalone
  </verify>
  <done>Full end-to-end verification passed: all tests, Nx commands, migrations, service smoke test, import resolution</done>
</task>

</tasks>

<verification>
Per CHECKPOINTS.md:
- All tests pass (444 total)
- Alembic upgrade head succeeds
- Service starts and responds to API requests
- Architecture boundaries enforced by import-linter

Per phase success criteria:
- Nx monorepo structure in place
- Backend at apps/api/
- Frontend scaffold at apps/web/
- Libraries at libs/domain/ and libs/ui/
- Nx commands work for all projects
</verification>

<success_criteria>
- CLAUDE.md documents monorepo structure, imports, Nx commands
- All 444 tests pass
- Nx commands work for all 4 projects
- Service starts and responds
- Alembic migrations work
- Architecture boundaries enforced
- Phase 7 success criteria fully met
</success_criteria>

<output>
After completion, create `.planning/phases/07-nx-monorepo-restructure/07-04-SUMMARY.md`
</output>
