---
phase: 07-nx-monorepo-restructure
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - libs/domain/domain/**
  - libs/domain/tests/**
  - libs/domain/pyproject.toml
  - libs/domain/project.json
  - apps/api/src/**
  - apps/api/tests/**
  - apps/api/alembic/env.py
  - apps/api/src/adapters/persistence/orm/mappers.py
  - apps/api/src/application/**
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Domain layer code lives at libs/domain/domain/ (not in apps/api/)"
    - "All imports reference domain.* not src.domain.* for domain layer code"
    - "libs/domain is a registered Nx project with test and lint targets"
    - "Domain unit tests live at libs/domain/tests/"
    - "API code at apps/api/src/ imports domain.* and it resolves correctly"
  artifacts:
    - path: "libs/domain/domain/model/money.py"
      provides: "Money value object (domain layer)"
      contains: "class Money"
    - path: "libs/domain/domain/ports/unit_of_work.py"
      provides: "UnitOfWork port protocol"
      contains: "class UnitOfWork"
    - path: "libs/domain/project.json"
      provides: "Domain library Nx project definition"
      contains: "\"name\": \"domain\""
    - path: "libs/domain/pyproject.toml"
      provides: "Domain library Python project config"
      contains: "personal-finance-domain"
  key_links:
    - from: "apps/api/src/application/services/account_service.py"
      to: "libs/domain/domain/model/account.py"
      via: "import domain.model.account"
      pattern: "from domain\\."
    - from: "apps/api/src/adapters/persistence/orm/mappers.py"
      to: "libs/domain/domain/model/"
      via: "import domain.model.*"
      pattern: "from domain\\."
    - from: "libs/domain/pyproject.toml"
      to: "pyproject.toml"
      via: "uv workspace member"
      pattern: "libs/domain"
---

<objective>
Extract the domain layer from apps/api/src/domain/ into libs/domain/ as a shared library and rewrite all imports from `src.domain.*` to `domain.*`.

Purpose: Make the domain layer a standalone, reusable library that can be shared across multiple apps (API, future CLI, etc.). This is the key architectural change that enables the monorepo's shared library pattern.

Output: Domain code at libs/domain/domain/, domain tests at libs/domain/tests/, all imports updated, uv workspace member configured.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nx-monorepo-restructure/07-CONTEXT.md
@.planning/phases/07-nx-monorepo-restructure/07-RESEARCH.md
@.planning/phases/07-nx-monorepo-restructure/07-02-SUMMARY.md
@pyproject.toml
@apps/api/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract domain layer to libs/domain/</name>
  <files>libs/domain/domain/, libs/domain/tests/, libs/domain/pyproject.toml, libs/domain/project.json</files>
  <action>
  Move the domain layer out of the API app into its own library:

  1. Create libs/domain/ directory:
     ```bash
     mkdir -p libs/domain
     ```

  2. Move the domain package via git mv:
     ```bash
     git mv apps/api/src/domain/ libs/domain/domain/
     ```
     This moves the entire `domain/` package (model/, events/, ports/, exceptions.py, __init__.py) to `libs/domain/domain/`.
     The package name stays `domain` - imports will be `from domain.model.money import Money`.

  3. Move domain unit tests to libs/domain/tests/:
     ```bash
     mkdir -p libs/domain/tests/unit
     git mv apps/api/tests/unit/domain/ libs/domain/tests/unit/domain/
     ```
     Create `libs/domain/tests/__init__.py` and `libs/domain/tests/unit/__init__.py`.

  4. Create `libs/domain/pyproject.toml`:
     ```toml
     [project]
     name = "personal-finance-domain"
     version = "0.1.0"
     description = "Personal Finance domain layer - models, events, ports"
     requires-python = ">=3.12"

     dependencies = [
         "typeid-python>=0.3.0",
         "returns>=0.23.0",
     ]

     [build-system]
     requires = ["hatchling"]
     build-backend = "hatchling.build"

     [tool.hatch.build.targets.wheel]
     packages = ["domain"]
     ```
     The domain layer has minimal dependencies -- only typeid-python (for EntityId) and returns (for Result type). It must NOT depend on SQLAlchemy, FastAPI, or any infrastructure.

  5. Create `libs/domain/project.json`:
     ```json
     {
       "name": "domain",
       "projectType": "library",
       "sourceRoot": "libs/domain/domain",
       "targets": {
         "test": {
           "executor": "nx:run-commands",
           "options": {
             "command": "python -m pytest tests/ -v --tb=short",
             "cwd": "libs/domain"
           },
           "inputs": ["{projectRoot}/**/*.py"],
           "outputs": []
         },
         "lint": {
           "executor": "nx:run-commands",
           "options": {
             "command": "ruff check domain/ tests/",
             "cwd": "libs/domain"
           },
           "inputs": ["{projectRoot}/**/*.py"],
           "outputs": []
         }
       }
     }
     ```

  6. Update root `pyproject.toml` [tool.uv.workspace] members to include `libs/domain` (should already be there from 07-02).

  7. Add `personal-finance-domain` as a dependency in `apps/api/pyproject.toml`:
     ```toml
     dependencies = [
         "personal-finance-domain",
         # ... other deps
     ]
     ```
     uv workspace will resolve this to the local libs/domain/ package.

  8. Commit the move: `git add -A && git commit -m "refactor(07): extract domain layer to libs/domain/"`
  </action>
  <verify>
  - `ls libs/domain/domain/model/money.py` exists
  - `ls libs/domain/domain/ports/unit_of_work.py` exists
  - `ls libs/domain/tests/unit/domain/test_money.py` exists
  - `ls apps/api/src/domain/` should NOT exist (moved away)
  - `git log --follow libs/domain/domain/model/money.py` shows history
  - `npx nx show projects` includes "domain"
  </verify>
  <done>Domain layer extracted to libs/domain/ with git history preserved, Nx project registered</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite all imports from src.domain.* to domain.*</name>
  <files>apps/api/src/**/*.py, apps/api/tests/**/*.py, apps/api/alembic/env.py</files>
  <action>
  Update every Python file that imports from `src.domain` to use the new `domain` package path:

  1. Find all files with `src.domain` imports:
     ```bash
     grep -r "from src\.domain" apps/api/ --include="*.py" -l
     grep -r "import src\.domain" apps/api/ --include="*.py" -l
     ```

  2. Replace all occurrences:
     - `from src.domain.` -> `from domain.`
     - `import src.domain.` -> `import domain.`
     - `"src.domain"` -> `"domain"` (in string references like import-linter config)

  3. Key files to update (non-exhaustive, search finds all):
     - `apps/api/src/adapters/persistence/orm/mappers.py` (maps domain entities)
     - `apps/api/src/adapters/persistence/orm/tables.py` (may import domain types)
     - `apps/api/src/adapters/persistence/orm/types.py` (TypeDecorator imports)
     - `apps/api/src/adapters/persistence/repositories/*.py` (all repositories)
     - `apps/api/src/adapters/persistence/unit_of_work.py`
     - `apps/api/src/adapters/api/schemas/*.py` (response schemas)
     - `apps/api/src/adapters/api/routes/*.py` (route handlers)
     - `apps/api/src/adapters/api/dependencies.py`
     - `apps/api/src/adapters/security/*.py`
     - `apps/api/src/adapters/email/*.py`
     - `apps/api/src/adapters/jobs/*.py`
     - `apps/api/src/application/services/*.py` (all services)
     - `apps/api/src/application/event_bus.py`
     - `apps/api/src/application/handlers/*.py`
     - `apps/api/src/main.py`
     - `apps/api/tests/**/*.py` (all test files)
     - `apps/api/alembic/env.py`

  4. Also update `libs/domain/` internal imports -- domain files that reference `src.domain` in their own imports (they should use `domain.` now):
     ```bash
     grep -r "from src\.domain" libs/domain/ --include="*.py" -l
     ```
     Replace `from src.domain.` -> `from domain.` in domain layer files too.

  5. Update `pyproject.toml` import-linter config:
     - `root_packages` should include both `"src"` and `"domain"`
     - Domain forbidden imports source should be `"domain"` (not `"src.domain"`)
     - Layers contract should list `"domain"` (not `"src.domain"`)

  6. Run `uv sync` from workspace root to install the domain package as an editable workspace member.

  7. Verify the import rewrite is complete:
     ```bash
     # Should return NO results:
     grep -r "from src\.domain" apps/api/ libs/domain/ --include="*.py"
     grep -r "import src\.domain" apps/api/ libs/domain/ --include="*.py"
     ```

  8. Verify the domain package resolves:
     ```bash
     python -c "import domain; print(domain.__file__)"
     # Should print path to libs/domain/domain/__init__.py
     ```

  9. Commit: `git add -A && git commit -m "refactor(07): rewrite imports from src.domain to domain"`
  </action>
  <verify>
  - `grep -r "from src\.domain" apps/api/ libs/domain/ --include="*.py"` returns NO results
  - `grep -r "import src\.domain" apps/api/ libs/domain/ --include="*.py"` returns NO results
  - `python -c "import domain; print(domain.__file__)"` prints libs/domain/domain/__init__.py path
  - `python -c "from domain.model.money import Money; print(Money)"` works
  </verify>
  <done>All imports rewritten from src.domain.* to domain.*, domain package resolves correctly via uv workspace</done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass with extracted domain</name>
  <files>none (verification only)</files>
  <action>
  Comprehensive verification that domain extraction didn't break anything:

  1. Run domain unit tests from libs/domain/:
     ```bash
     cd /workspace && python -m pytest libs/domain/tests/ -v --tb=short
     ```

  2. Run API tests from apps/api/:
     ```bash
     cd /workspace && python -m pytest apps/api/tests/ -v --tb=short
     ```

  3. Run ALL tests together:
     ```bash
     cd /workspace && python -m pytest apps/api/tests/ libs/domain/tests/ -v --tb=short
     ```
     All 444 tests should pass.

  4. Run import-linter to verify architecture boundaries:
     ```bash
     lint-imports
     ```

  5. Run Nx domain test target:
     ```bash
     npx nx test domain
     ```

  6. Run Nx api test target:
     ```bash
     npx nx test api
     ```

  7. Run alembic check and upgrade to verify migrations still work:
     ```bash
     alembic upgrade head
     alembic check
     ```

  If tests fail, debug the issue. Common problems:
  - Missing `__init__.py` in libs/domain/tests/
  - PYTHONPATH not including libs/domain/ (uv workspace editable install should handle this)
  - Circular import from domain -> src (should not happen, domain has no infra deps)
  - conftest.py in tests referencing old paths
  </action>
  <verify>
  - All tests pass: `python -m pytest apps/api/tests/ libs/domain/tests/ -x -q`
  - `lint-imports` passes (architecture boundaries maintained)
  - `alembic check` shows no drift
  - `npx nx test domain` succeeds
  - `npx nx test api` succeeds
  </verify>
  <done>All 444 tests pass, import-linter passes, Nx targets work for both api and domain projects</done>
</task>

</tasks>

<verification>
- Domain code at libs/domain/domain/ with full git history
- Zero occurrences of `src.domain` in Python files
- Domain package resolves via `import domain`
- All 444 tests pass
- import-linter architecture contracts still enforced
- Nx commands work for domain project
</verification>

<success_criteria>
- libs/domain/domain/ contains all domain layer code
- libs/domain/tests/ contains domain unit tests
- All imports use domain.* not src.domain.*
- uv workspace resolves domain package as editable install
- All 444 tests pass from both apps/api/tests/ and libs/domain/tests/
- Nx test and lint targets work for domain project
</success_criteria>

<output>
After completion, create `.planning/phases/07-nx-monorepo-restructure/07-03-SUMMARY.md`
</output>
