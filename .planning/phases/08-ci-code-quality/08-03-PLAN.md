---
phase: 08-ci-code-quality
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - apps/api/src/adapters/api/routes/accounts.py
  - apps/api/src/adapters/api/routes/transactions.py
  - apps/api/src/adapters/api/routes/categories.py
  - apps/api/src/adapters/api/routes/auth.py
  - apps/api/src/adapters/api/schemas/
  - apps/api/src/adapters/api/dependencies.py
  - apps/api/src/adapters/persistence/repositories/
  - apps/api/src/application/services/
  - apps/api/tests/
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "npx nx lint api passes with zero errors"
    - "All 252 API tests still pass after lint fixes"
    - "No relative imports remain in api src/"
    - "No datetime.date.today() calls remain (DTZ011)"
  artifacts:
    - path: "pyproject.toml"
      provides: "Updated ruff config with per-file-ignores for ARG unused args in route handlers"
      contains: "per-file-ignores"
  key_links:
    - from: "apps/api/src/adapters/api/routes/"
      to: "apps/api/src/adapters/api/schemas/"
      via: "Absolute imports (not relative)"
      pattern: "from src.adapters"
---

<objective>
Fix all 214 ruff lint errors in the API project.

Purpose: Achieve zero ruff lint errors in the API project so lint can be a strictly blocking CI gate. This catches common bugs, enforces modern Python patterns, and ensures consistent code style.
Output: Zero ruff lint errors in api project (src + tests).
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-code-quality/08-RESEARCH.md
@.planning/phases/08-ci-code-quality/08-02-SUMMARY.md

Key files:
@pyproject.toml (ruff config)
@apps/api/project.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auto-fixable and configuration-fixable lint errors</name>
  <files>
    pyproject.toml
    apps/api/src/ (multiple files)
    apps/api/tests/ (multiple files)
  </files>
  <action>
Run `npx nx lint api` first to get the exact current error list.

**Step 1: Auto-fix what ruff can handle automatically.**

Run `uv run ruff check --fix apps/api/` from workspace root. This will fix:
- I001 (24 errors): Import sorting -- fully auto-fixable
- F401 (6 errors): Some unused imports -- auto-fixable (removes them)
- RUF022 (1 error): __all__ sorting -- auto-fixable
- Some SIM and RET fixes -- auto-fixable

**Step 2: Configuration changes to eliminate false positives.**

The B008 (38 errors) and SLF001 (12 errors) were already handled in plan 01 via ruff config changes. Verify they're gone.

For ARG001/ARG002 (49 total) -- many are legitimate FastAPI route handler patterns where `request` or dependency-injected services are required by the framework but unused in the function body. Handle in two ways:

a) For route handler unused args (e.g., `current_user` in routes that need auth but don't use the user object, or unused `request`): Add `_` prefix to the parameter name if it's truly unused, OR add per-file-ignore if renaming breaks FastAPI dependency injection:
```toml
# In pyproject.toml [tool.ruff.lint.per-file-ignores]
"apps/api/src/adapters/api/routes/**" = ["ARG001", "ARG002"]
"apps/api/tests/**" = ["ARG001", "ARG002"]
```
Note: FastAPI route handlers commonly have injected dependencies that appear unused. ARG rules create noise here. Per-file-ignore for routes is the pragmatic choice.

b) For service/repository unused args: Add `_` prefix to genuinely unused parameters.

**Step 3: Fix DTZ011 (47 errors) -- datetime.date.today().**

Replace all `datetime.date.today()` and `date.today()` calls with timezone-aware alternatives:
```python
# Before
from datetime import date
d = date.today()

# After
from datetime import UTC, datetime
d = datetime.now(UTC).date()
```

This is a mechanical replacement. Search for `date.today()` and `.today()` patterns in both `src/` and `tests/` directories.

Run auto-fix first, then verify remaining error count with `npx nx lint api`.
  </action>
  <verify>
- `npx nx lint api` shows reduced error count (DTZ011, B008, SLF001, I001, F401, ARG resolved)
- `npx nx test api` still passes
  </verify>
  <done>Auto-fixable errors resolved. Configuration-fixable errors resolved. DTZ011 datetime fixes applied. Error count significantly reduced.</done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining manual lint errors</name>
  <files>
    apps/api/src/adapters/api/routes/ (multiple)
    apps/api/src/adapters/api/schemas/ (multiple)
    apps/api/src/application/services/ (multiple)
    apps/api/src/adapters/persistence/ (multiple)
    apps/api/tests/ (multiple)
  </files>
  <action>
Run `npx nx lint api` to see the exact remaining errors after Task 1. Fix each category:

**1. TID252 (19 errors): Convert relative imports to absolute.**

Convert all relative imports in `src/adapters/api/routes/` and `src/adapters/api/schemas/` to absolute imports:
```python
# Before
from ..schemas.account import CreateAccountRequest
from ...application.services.account_service import AccountService

# After
from src.adapters.api.schemas.account import CreateAccountRequest
from src.application.services.account_service import AccountService
```

This is consistent with CLAUDE.md import conventions.

**2. B904 (7 errors): Add exception chaining.**

Find all `raise X` inside `except` blocks and add `from` clause:
```python
# Before
except SomeException:
    raise HTTPException(...)

# After
except SomeException as e:
    raise HTTPException(...) from e
```

Or use `from None` if the original exception should be suppressed.

**3. F821 (3 errors): Fix undefined names (forward references).**

These are likely forward references used in type annotations without `from __future__ import annotations` or proper quoting. Fix by either:
- Adding `from __future__ import annotations` at the top of the file
- Quoting the forward reference: `"ClassName"`
- Importing the referenced class

**4. TC001/TC002 (3 errors): Move imports to TYPE_CHECKING.**

Move imports used only in type annotations to `TYPE_CHECKING` block:
```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from some_module import SomeType
```

**5. PT012 (2 errors): Narrow pytest.raises blocks.**

The `pytest.raises` blocks are too broad. Move non-raising code outside the `with` block:
```python
# Before
with pytest.raises(ValueError):
    result = compute_something()
    do_assertion(result)

# After
with pytest.raises(ValueError):
    compute_something()
```

**6. SIM105/SIM102 (2 errors): Simplify try/except and if blocks.**

- SIM105: Replace `try/except/pass` with `contextlib.suppress()`
- SIM102: Collapse nested if statements

**7. RET505 (1 error): Remove unnecessary elif after return.**

Change `elif` to `else` or just `if` when previous branch returns.

**8. N806 (1 error): Rename uppercase variable in function.**

Rename the variable to lowercase following Python naming conventions.

**9. Any remaining errors:** Fix following the same patterns -- check ruff docs for the specific rule and apply the recommended fix.

After all fixes, run `npx nx lint api` to confirm zero errors.
  </action>
  <verify>
- `npx nx lint api` passes with 0 errors
- `npx nx test api` passes (all 252 tests)
- `npx nx typecheck api` still passes with 0 errors (lint fixes didn't break types)
  </verify>
  <done>Zero ruff lint errors in api project. All 252 tests pass. Typecheck still clean. No relative imports remain. All datetime calls are timezone-aware.</done>
</task>

</tasks>

<verification>
1. `npx nx lint api` -- zero errors
2. `npx nx test api` -- all 252 tests pass
3. `npx nx typecheck api` -- still zero errors (verify lint fixes didn't break types)
4. `grep -rn "from \.\." apps/api/src/` -- no relative imports
5. `grep -rn "date\.today()" apps/api/` -- no DTZ011 violations
</verification>

<success_criteria>
- API project has zero ruff lint errors
- All 252 API tests still pass
- Pyright typecheck still passes (no regressions from lint fixes)
- All relative imports converted to absolute imports
- No timezone-naive datetime.date.today() calls remain
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-03-SUMMARY.md`
</output>
