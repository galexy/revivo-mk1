---
phase: 08-ci-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/pyrightconfig.json
  - libs/domain/pyrightconfig.json
  - libs/domain/domain/py.typed
  - pyproject.toml
  - libs/domain/domain/model/money.py
  - libs/domain/domain/model/rewards_balance.py
  - libs/domain/domain/ports/repository.py
  - libs/domain/tests/unit/test_split_line.py
  - libs/domain/tests/unit/test_account.py
  - libs/domain/tests/unit/test_entity_id.py
  - libs/domain/domain/__init__.py
autonomous: true

must_haves:
  truths:
    - "npx nx typecheck domain passes with zero errors (src + tests)"
    - "npx nx lint domain passes with zero errors"
    - "uv run ruff format --check . reports no formatting violations"
    - "py.typed marker exists in libs/domain/domain/"
    - "Per-project pyrightconfig.json exists for both api and domain"
  artifacts:
    - path: "apps/api/pyrightconfig.json"
      provides: "Per-project pyright config for api (strict, includes src + tests)"
      contains: "typeCheckingMode"
    - path: "libs/domain/pyrightconfig.json"
      provides: "Per-project pyright config for domain (strict, includes domain + tests)"
      contains: "typeCheckingMode"
    - path: "libs/domain/domain/py.typed"
      provides: "PEP 561 marker for typed package"
  key_links:
    - from: "apps/api/project.json"
      to: "apps/api/pyrightconfig.json"
      via: "pyright invoked from projectRoot uses pyrightconfig.json automatically"
      pattern: "pyright"
    - from: "libs/domain/project.json"
      to: "libs/domain/pyrightconfig.json"
      via: "pyright invoked from projectRoot uses pyrightconfig.json automatically"
      pattern: "pyright"
---

<objective>
Set up per-project pyright configuration, add py.typed marker, update ruff config, auto-format all files, and fix all domain pyright + lint errors (20 pyright + 33 lint = 53 errors total).

Purpose: Establish tooling foundation and clean domain layer first, since domain is the shared library imported by all consumers. A clean domain enables clean downstream type checking.
Output: Zero pyright and ruff errors in domain project, per-project pyrightconfig.json for both projects, all files formatted.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-code-quality/08-RESEARCH.md

Key files:
@pyproject.toml
@libs/domain/project.json
@apps/api/project.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tooling configuration and auto-format</name>
  <files>
    apps/api/pyrightconfig.json
    libs/domain/pyrightconfig.json
    libs/domain/domain/py.typed
    pyproject.toml
    apps/api/project.json
    libs/domain/project.json
  </files>
  <action>
1. Create `apps/api/pyrightconfig.json`:
```json
{
  "typeCheckingMode": "strict",
  "pythonVersion": "3.12",
  "include": ["src", "tests"],
  "venvPath": "../..",
  "venv": ".venv",
  "reportMissingTypeStubs": true,
  "pythonPlatform": "Linux"
}
```

2. Create `libs/domain/pyrightconfig.json`:
```json
{
  "typeCheckingMode": "strict",
  "pythonVersion": "3.12",
  "include": ["domain", "tests"],
  "venvPath": "../..",
  "venv": ".venv",
  "reportMissingTypeStubs": true,
  "pythonPlatform": "Linux"
}
```

3. Create `libs/domain/domain/py.typed` (empty marker file for PEP 561).

4. Pin pyright version in root `pyproject.toml`: change `"pyright>=1.1.0"` to `"pyright==1.1.408"` (or whatever version is currently installed -- check with `uv run pyright --version`).

5. Update ruff config in root `pyproject.toml`:
   - Add `"W"` to `[tool.ruff.lint] select` list (pycodestyle warnings per CONTEXT)
   - Add `[tool.ruff.lint.flake8-bugbear]` section with `extend-immutable-calls` for FastAPI:
     ```toml
     [tool.ruff.lint.flake8-bugbear]
     extend-immutable-calls = [
         "fastapi.Depends",
         "fastapi.Query",
         "fastapi.Header",
         "fastapi.Body",
         "fastapi.Path",
         "fastapi.Cookie",
         "fastapi.Form",
     ]
     ```
   - Add per-file-ignores for persistence adapter layer SLF001:
     ```toml
     [tool.ruff.lint.per-file-ignores]
     "apps/api/src/adapters/persistence/**" = ["SLF001"]
     ```

6. Update Nx typecheck targets to use pyrightconfig.json (remove explicit path arguments):
   - In `apps/api/project.json`, change typecheck command from `"uv run --package personal-finance-api pyright src/"` to `"uv run --package personal-finance-api pyright"` (pyrightconfig.json controls includes)
   - In `libs/domain/project.json`, change typecheck command from `"uv run --package personal-finance-domain pyright domain/"` to `"uv run --package personal-finance-domain pyright"` (pyrightconfig.json controls includes)

7. Run `uv run ruff format .` from workspace root to fix all 26 formatting violations.
  </action>
  <verify>
- `cat apps/api/pyrightconfig.json` shows strict config with include: ["src", "tests"]
- `cat libs/domain/pyrightconfig.json` shows strict config with include: ["domain", "tests"]
- `test -f libs/domain/domain/py.typed` confirms marker exists
- `uv run ruff format --check .` reports no violations
- `grep "pyright==" pyproject.toml` shows pinned version
  </verify>
  <done>Per-project pyrightconfig.json for api and domain, py.typed marker, pyright pinned, ruff config updated with W rules + B008 fix + SLF001 per-file-ignore, all files formatted.</done>
</task>

<task type="auto">
  <name>Task 2: Fix all domain pyright and lint errors</name>
  <files>
    libs/domain/domain/model/money.py
    libs/domain/domain/model/rewards_balance.py
    libs/domain/domain/ports/repository.py
    libs/domain/domain/__init__.py
    libs/domain/tests/unit/test_split_line.py
    libs/domain/tests/unit/test_account.py
    libs/domain/tests/unit/test_entity_id.py
    libs/domain/tests/ (multiple test files)
  </files>
  <action>
**Fix 20 domain pyright errors:**

1. `money.py` (5 errors): Change `-> Self` to `-> "Money"` on all arithmetic methods (__add__, __sub__, __mul__, __neg__, etc.). Also change parameter types from `Self` to `"Money"` where applicable. Money is `frozen=True, slots=True` and won't be subclassed -- `Self` was incorrect.

2. `rewards_balance.py` (2 errors): Same pattern as Money. Change `-> Self` to concrete return type `-> "RewardsBalance"`.

3. `ports/repository.py` (1 error): Fix `reportInvalidTypeVarUse`. The TypeVar `ID` in Protocol needs to be contravariant, or the Generic usage should be removed. Check the actual error and fix accordingly -- likely change to `ID = TypeVar("ID", contravariant=True)` or simplify the Protocol.

4. `test_split_line.py` (9 errors): Wrap string literals with `Decimal("...")` where tests pass string literals where `Decimal` is expected.

5. `test_account.py` (1 error): Add `assert result is not None` or an explicit None check before accessing `.name` on the potentially-None value.

6. `test_entity_id.py` (2 errors): Tests assign to frozen dataclass fields intentionally. Use `object.__setattr__(instance, "field", value)` instead of direct assignment, or restructure the test to avoid frozen field assignment.

**Fix 33 domain lint errors:**

7. RUF043 (9 errors): Change `match=` strings in `pytest.raises` to raw strings `r"..."` for unescaped regex metacharacters.

8. PT011 (7 errors): Add `match=` parameter to overly broad `pytest.raises(...)` calls. Use the expected error message text.

9. I001 (6 errors): Run `uv run ruff check --fix libs/domain/` to auto-fix import sorting.

10. PIE790 (5 errors): Remove unnecessary `pass` statements in class bodies that have other content (docstrings, methods).

11. F401 (3 errors): Remove unused imports.

12. SIM300 (1 error): Flip Yoda condition (e.g., `0 == x` -> `x == 0`).

13. RUF022 (1 error): Sort `__all__` list alphabetically.

14. N818 (1 error): Either rename exception class to end in "Error" or add a per-file noqa for this specific case if renaming is too disruptive (it could break imports in api project). Check whether renaming is safe across the codebase.

Run lint auto-fix first (`uv run ruff check --fix libs/domain/`), then manually fix remaining errors.
  </action>
  <verify>
- `npx nx typecheck domain` passes with 0 errors
- `npx nx lint domain` passes with 0 errors
- `npx nx test domain` passes (all 192 tests)
  </verify>
  <done>Zero pyright errors in domain (src + tests). Zero ruff lint errors in domain. All 192 domain tests still pass.</done>
</task>

</tasks>

<verification>
1. `npx nx typecheck domain` -- zero errors
2. `npx nx lint domain` -- zero errors
3. `npx nx test domain` -- all 192 tests pass
4. `uv run ruff format --check .` -- no formatting violations
5. `cat apps/api/pyrightconfig.json` -- strict mode, includes src + tests
6. `cat libs/domain/pyrightconfig.json` -- strict mode, includes domain + tests
7. `test -f libs/domain/domain/py.typed` -- exists
</verification>

<success_criteria>
- Domain project has zero pyright strict errors (including tests)
- Domain project has zero ruff lint errors
- All 192 domain tests pass
- All files in workspace properly formatted
- Per-project pyrightconfig.json created for api and domain
- py.typed marker exists in libs/domain/domain/
- Pyright version pinned in pyproject.toml
- Ruff config has B008 immutable calls, W rules, SLF001 per-file-ignore
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-01-SUMMARY.md`
</output>
