---
phase: 08-ci-code-quality
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/application/services/category_service.py
  - apps/api/src/adapters/api/routes/categories.py
  - libs/domain/tests/unit/domain/test_institution.py
  - libs/domain/tests/unit/domain/test_rewards_balance.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "get_category_tree returns a CategoryTree TypedDict with distinct types per key"
    - "categories.py has zero type: ignore comments for tree access"
    - "No redundant immutability tests exist for frozen dataclasses"
  artifacts:
    - path: "apps/api/src/application/services/category_service.py"
      provides: "CategoryTree TypedDict and typed get_category_tree"
      contains: "CategoryTree"
    - path: "apps/api/src/adapters/api/routes/categories.py"
      provides: "Clean tree access without type: ignore"
  key_links:
    - from: "apps/api/src/adapters/api/routes/categories.py"
      to: "apps/api/src/application/services/category_service.py"
      via: "CategoryTree return type"
      pattern: "CategoryTree"
---

<objective>
Improve type safety: replace loosely-typed dict return from get_category_tree with a CategoryTree TypedDict, and remove redundant immutability tests that are now covered by pyright strict.

Purpose: Eliminate unnecessary type: ignore comments and redundant tests that add noise without value.
Output: Clean typed category tree access, fewer tests but same coverage quality.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/api/src/application/services/category_service.py
@apps/api/src/adapters/api/routes/categories.py
@libs/domain/tests/unit/domain/test_institution.py
@libs/domain/tests/unit/domain/test_rewards_balance.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CategoryTree TypedDict and update get_category_tree</name>
  <files>
    apps/api/src/application/services/category_service.py
    apps/api/src/adapters/api/routes/categories.py
  </files>
  <action>
    1. In apps/api/src/application/services/category_service.py, add a CategoryTree TypedDict:
       ```python
       from typing import TypedDict
       # (add TypedDict to existing TYPE_CHECKING or typing import)

       class CategoryTree(TypedDict):
           root: list[Category]
           children: dict[str, list[Category]]
       ```

    2. Update get_category_tree return type from `dict[str, list[Category] | dict[str, list[Category]]]` to `CategoryTree`:
       ```python
       def get_category_tree(self, user_id: UserId) -> CategoryTree:
       ```
       The return statement body stays the same -- the dict literal `{"root": ..., "children": ...}` already matches CategoryTree structure.

    3. In apps/api/src/adapters/api/routes/categories.py, update the get_category_tree route:
       - Import CategoryTree from the service module:
         `from src.application.services.category_service import CategoryError, CategoryService, CategoryTree`
       - Change the tree variable type annotation:
         Old (lines 117-121):
         ```python
         tree: dict[str, list[Category] | dict[str, list[Category]]] = (
             service.get_category_tree(user_id)
         )
         root_categories: list[Category] = tree["root"]  # type: ignore[assignment]  # dict value is list[Category]
         children_map: dict[str, list[Category]] = tree["children"]  # type: ignore[assignment]  # dict value is dict[str, list[Category]]
         ```
         New:
         ```python
         tree: CategoryTree = service.get_category_tree(user_id)
         root_categories = tree["root"]
         children_map = tree["children"]
         ```
         No type: ignore needed because TypedDict gives distinct types per key.
  </action>
  <verify>
    Run `npx nx typecheck api` -- zero errors, zero warnings.
    Run `npx nx test api` -- all tests pass.
  </verify>
  <done>
    CategoryTree TypedDict used. Zero type: ignore comments for tree access in categories.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove redundant immutability tests</name>
  <files>
    libs/domain/tests/unit/domain/test_institution.py
    libs/domain/tests/unit/domain/test_rewards_balance.py
  </files>
  <action>
    1. In libs/domain/tests/unit/domain/test_institution.py:
       Remove the entire `TestInstitutionDetailsImmutability` class (lines 93-118).
       This class has 4 tests that verify frozen dataclass fields can't be assigned at runtime.
       With pyright strict, these assignments are caught at compile time -- the tests themselves
       require `type: ignore[misc]` to even compile, proving they're redundant.

    2. In libs/domain/tests/unit/domain/test_rewards_balance.py:
       Remove the `test_cannot_modify_value` and `test_cannot_modify_unit` methods from
       `TestRewardsBalanceImmutability` class (lines 163-174). These have the same `type: ignore[misc]`
       pattern as the institution tests.
       KEEP `test_arithmetic_returns_new_instance` (lines 176-184) -- this tests behavioral contract
       (new instance returned from arithmetic), not just frozen field assignment. It has no type: ignore.
       Rename the class to `TestRewardsBalanceArithmetic` or similar since it no longer tests immutability per se.

    3. Check test_money.py, test_split_line.py, test_entity_id.py for similar patterns.
       If any have `type: ignore[misc]` immutability tests (testing frozen field assignment),
       remove those tests. Keep tests that verify behavioral properties.
  </action>
  <verify>
    Run `npx nx typecheck domain` -- zero errors.
    Run `npx nx test domain` -- all remaining tests pass.
    Grep for `type: ignore\[misc\]` in domain tests -- no frozen-field immutability tests remain.
  </verify>
  <done>
    Redundant immutability tests removed. Remaining tests verify behavior, not language mechanics.
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck api` -- zero errors, zero warnings
2. `npx nx typecheck domain` -- zero errors
3. `npx nx test api` -- all tests pass
4. `npx nx test domain` -- all tests pass
5. No `type: ignore[assignment]` in categories.py for tree access
6. No `type: ignore[misc]` for frozen field assignment in domain tests
</verification>

<success_criteria>
- CategoryTree TypedDict eliminates type: ignore comments in categories.py
- Redundant immutability tests removed from domain test suite
- All typecheck and test targets pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-06-SUMMARY.md`
</output>
