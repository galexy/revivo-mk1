---
phase: 08-ci-code-quality
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/api/src/adapters/persistence/repositories/account.py
  - apps/api/src/adapters/persistence/repositories/transaction.py
  - apps/api/src/adapters/persistence/repositories/category.py
  - apps/api/src/adapters/persistence/repositories/payee.py
  - apps/api/src/adapters/persistence/repositories/user.py
  - apps/api/src/adapters/persistence/repositories/household.py
  - apps/api/src/adapters/persistence/repositories/refresh_token.py
  - apps/api/src/adapters/persistence/orm/mappers.py
  - apps/api/src/adapters/api/routes/accounts.py
  - apps/api/src/adapters/api/routes/transactions.py
  - apps/api/src/adapters/api/routes/categories.py
  - apps/api/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "npx nx typecheck api passes with zero errors (src + tests)"
    - "All 252 API tests still pass after pyright fixes"
  artifacts:
    - path: "apps/api/src/adapters/persistence/repositories/account.py"
      provides: "Type-safe repository with targeted type: ignore for SQLAlchemy imperative mapping"
      contains: "type: ignore"
    - path: "apps/api/src/adapters/api/routes/accounts.py"
      provides: "Routes with NoReturn error handler and proper type narrowing"
      contains: "NoReturn"
  key_links:
    - from: "apps/api/pyrightconfig.json"
      to: "apps/api/src/"
      via: "pyrightconfig.json includes src and tests directories"
      pattern: "include.*src.*tests"
---

<objective>
Fix all 75 pyright strict errors in the API project (72 in src/ + 3 in tests/).

Purpose: Achieve zero pyright strict errors in the API project. This enables strict type checking as a CI gate and catches async/sync mismatches, missing attributes, and protocol violations before runtime.
Output: Zero pyright errors in api project (src + tests).
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-code-quality/08-RESEARCH.md
@.planning/phases/08-ci-code-quality/08-01-SUMMARY.md

Key files:
@apps/api/pyrightconfig.json (created in plan 01)
@apps/api/project.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix repository and mapper pyright errors (65 errors)</name>
  <files>
    apps/api/src/adapters/persistence/repositories/account.py
    apps/api/src/adapters/persistence/repositories/transaction.py
    apps/api/src/adapters/persistence/repositories/category.py
    apps/api/src/adapters/persistence/repositories/payee.py
    apps/api/src/adapters/persistence/repositories/user.py
    apps/api/src/adapters/persistence/repositories/household.py
    apps/api/src/adapters/persistence/repositories/refresh_token.py
    apps/api/src/adapters/persistence/orm/mappers.py
  </files>
  <action>
Run `npx nx typecheck api` first to get the exact current error list. Then fix each category:

**1. Repository filter/query errors (34 `reportArgumentType` errors across all repositories):**

Add `# type: ignore[reportArgumentType]  # SQLAlchemy imperative mapping: domain attr becomes Column at runtime` to each `.where()` clause that compares domain class attributes. Example:
```python
stmt = select(Account).where(
    Account.household_id == str(household_id)  # type: ignore[reportArgumentType]  # SQLAlchemy imperative mapping
)
```

Add a module-level docstring note at the top of each repository file explaining the pattern:
```python
# NOTE: SQLAlchemy imperative mapping makes domain class attributes behave as
# Column descriptors at runtime, but pyright sees them as their declared Python
# types. The type: ignore comments on .where() clauses are expected and correct.
```

**2. Sort/order errors (10 `reportAttributeAccessIssue` for .desc()/.asc()):**

Add `# type: ignore[reportAttributeAccessIssue]  # SQLAlchemy imperative mapping: .desc() available at runtime` to `.desc()` and `.asc()` calls on domain class attributes.

**3. Mapper attribute assignment errors (18 `reportAttributeAccessIssue` in mappers.py):**

Add `# type: ignore[reportAttributeAccessIssue]  # SQLAlchemy-injected attribute from imperative mapping` to each decomposition/reconstruction line in mappers.py where value objects are decomposed into SQLAlchemy-injected columns (e.g., `obj.opening_balance_amount = obj.opening_balance.amount`).

**4. RefreshToken .rowcount errors (3 `reportAttributeAccessIssue`):**

Add `# type: ignore[reportAttributeAccessIssue]  # SQLAlchemy Result.rowcount exists at runtime, incomplete type stubs` to `.rowcount` accesses.

Every `# type: ignore` MUST have a justification comment explaining WHY it's necessary (per CONTEXT locked decision).
  </action>
  <verify>
- `npx nx typecheck api` shows remaining errors are only in routes/ and tests/ (not repositories/mappers)
- `npx nx test api` still passes (all 252 tests)
  </verify>
  <done>All repository and mapper pyright errors fixed with targeted type: ignore annotations. Each annotation has justification comment. Tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix route and test pyright errors (11 + 3 = 14 errors)</name>
  <files>
    apps/api/src/adapters/api/routes/accounts.py
    apps/api/src/adapters/api/routes/transactions.py
    apps/api/src/adapters/api/routes/categories.py
    apps/api/tests/conftest.py
  </files>
  <action>
**1. Route error handler NoReturn (11 `reportArgumentType` errors):**

In `routes/accounts.py` (and any other route files with `_handle_error` pattern):
- Import `NoReturn` from `typing`
- Change `_handle_error()` return type to `-> NoReturn`
- This tells pyright the function always raises, enabling type narrowing in callers
- After this change, `result` will be narrowed from `Account | AccountError` to just `Account` after the `isinstance` check + `_handle_error()` call

Check all route files for the same pattern:
- `routes/accounts.py` -- likely has `_handle_error` for AccountError
- `routes/transactions.py` -- check for similar error handler pattern (TransactionError)
- `routes/categories.py` -- check for similar error handler pattern (CategoryError)

Each error handler that always raises should return `-> NoReturn`.

**2. Test conftest errors (3 `reportUndefinedVariable`):**

In `apps/api/tests/conftest.py`:
- The forward reference `"Money"` is used in fixture return types but Money is not imported
- Add `from domain.model.money import Money` at module level (or under `TYPE_CHECKING` if it's only used in annotations)
- Verify the import doesn't create circular dependency issues

**3. Final verification:**

After all fixes, run `npx nx typecheck api` to confirm zero errors. If any new errors appear (sometimes fixing one reveals another), fix them following the same patterns:
- Genuinely unfixable SQLAlchemy issues: `# type: ignore` with justification
- Missing annotations: add proper type annotations
- NoReturn patterns: annotate error handlers correctly
  </action>
  <verify>
- `npx nx typecheck api` passes with 0 errors
- `npx nx test api` passes (all 252 tests)
  </verify>
  <done>Zero pyright strict errors in api project (src + tests). All 252 API tests still pass. Every type: ignore has a justification comment.</done>
</task>

</tasks>

<verification>
1. `npx nx typecheck api` -- zero errors (src + tests covered by pyrightconfig.json)
2. `npx nx test api` -- all 252 tests pass
3. `grep -r "type: ignore" apps/api/src/ | head -20` -- all have justification comments
4. No `# type: ignore` without explanation
</verification>

<success_criteria>
- API project has zero pyright strict errors (including tests)
- All 252 API tests still pass
- Every `# type: ignore` has a justification comment explaining why it's necessary
- Route error handlers annotated with `-> NoReturn` for proper type narrowing
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-02-SUMMARY.md`
</output>
