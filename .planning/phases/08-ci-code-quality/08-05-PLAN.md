---
phase: 08-ci-code-quality
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/tests/integration/test_schema_parity.py
  - apps/api/project.json
  - libs/domain/project.json
  - .github/workflows/ci.yml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "npx nx typecheck api produces zero errors and zero warnings"
    - "npx nx format api runs ruff format --check for the api project"
    - "npx nx format domain runs ruff format --check for the domain project"
    - "CI workflow uses npx nx affected -t format instead of raw uv run ruff format"
    - "import-linter is either an Nx target or documented as intentionally workspace-scoped in CI"
  artifacts:
    - path: "apps/api/tests/integration/test_schema_parity.py"
      provides: "Pyright-clean side-effect import"
      contains: "pyright: ignore"
    - path: "apps/api/project.json"
      provides: "format Nx target"
      contains: "format"
    - path: "libs/domain/project.json"
      provides: "format Nx target"
      contains: "format"
    - path: ".github/workflows/ci.yml"
      provides: "CI using nx affected for format check"
      contains: "nx affected -t format"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "apps/api/project.json"
      via: "nx affected -t format"
      pattern: "nx affected.*-t format"
---

<objective>
Fix Nx/CI integration gaps: suppress pyright warning on side-effect import, add format Nx targets to both projects, and update CI to use nx affected for format checks instead of raw uv commands.

Purpose: Ensure all quality gates run through Nx consistently (no raw uv commands in CI for project-specific checks).
Output: Clean typecheck (zero warnings), per-project format targets, CI using nx affected for all checks.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/api/project.json
@libs/domain/project.json
@.github/workflows/ci.yml
@apps/api/tests/integration/test_schema_parity.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pyright warning and add format Nx targets</name>
  <files>
    apps/api/tests/integration/test_schema_parity.py
    apps/api/project.json
    libs/domain/project.json
  </files>
  <action>
    1. In apps/api/tests/integration/test_schema_parity.py, line 29:
       Change: `import src.adapters.persistence.orm.tables  # noqa: F401 -- registers tables with metadata`
       To: `import src.adapters.persistence.orm.tables  # noqa: F401  # pyright: ignore[reportUnusedImport] -- registers tables with metadata`
       This suppresses both the ruff F401 lint and the pyright reportUnusedImport warning.

    2. In apps/api/project.json, add a "format" target after the existing "coverage" target:
       ```json
       "format": {
         "executor": "nx:run-commands",
         "options": {
           "command": "uv run --package personal-finance-api ruff format --check src/ tests/",
           "cwd": "{projectRoot}"
         },
         "inputs": ["{projectRoot}/**/*.py"],
         "outputs": []
       }
       ```

    3. In libs/domain/project.json, add a "format" target after the existing "coverage" target:
       ```json
       "format": {
         "executor": "nx:run-commands",
         "options": {
           "command": "uv run --package personal-finance-domain ruff format --check domain/ tests/",
           "cwd": "{projectRoot}"
         },
         "inputs": ["{projectRoot}/**/*.py"],
         "outputs": []
       }
       ```
  </action>
  <verify>
    Run `npx nx typecheck api` -- zero errors AND zero warnings.
    Run `npx nx format api` -- exits 0 (all formatted).
    Run `npx nx format domain` -- exits 0 (all formatted).
  </verify>
  <done>
    Pyright warning gone. Both projects have format Nx targets that work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CI to use nx affected for format and document import-linter</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
    1. In .github/workflows/ci.yml, replace the "Format check" step (line ~60-61):
       Old: `run: uv run ruff format --check .`
       New: `run: npx nx affected -t format --base=$NX_BASE --head=$NX_HEAD`

    2. For the "Import architecture check" step (line ~63-64):
       import-linter is workspace-scoped (checks cross-project boundaries via root .importlinter config).
       It cannot be an Nx per-project target because it validates relationships BETWEEN projects.
       Add a comment documenting this:
       ```yaml
       - name: Import architecture check
         # import-linter is workspace-scoped (validates cross-project boundaries)
         # Not an Nx target because it checks relationships between projects
         run: uv run lint-imports
       ```
       This documents the intentional decision to keep it as a raw command.

    3. Add `"typecheck"` to the targetDefaults cache list in nx.json if not already there.
       Also add `"format"` to targetDefaults cache:
       ```json
       "targetDefaults": {
         "test": { "cache": true },
         "lint": { "cache": true },
         "typecheck": { "cache": true },
         "format": { "cache": true }
       }
       ```
  </action>
  <verify>
    Inspect .github/workflows/ci.yml -- format step uses `npx nx affected -t format`.
    Inspect .github/workflows/ci.yml -- import-linter has explanatory comment.
    Inspect nx.json -- format and typecheck are cached.
  </verify>
  <done>
    CI uses nx affected for format checks. import-linter is documented as intentionally workspace-scoped. format and typecheck targets are cached.
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck api` -- zero errors, zero warnings
2. `npx nx format api` -- exits 0
3. `npx nx format domain` -- exits 0
4. CI file uses `npx nx affected -t format` (not raw uv)
5. import-linter step has documentation comment
</verification>

<success_criteria>
- Zero pyright warnings in api typecheck
- Per-project format Nx targets exist and pass
- CI uses nx affected for format checks
- import-linter documented as workspace-scoped
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-05-SUMMARY.md`
</output>
