---
phase: 08-ci-code-quality
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - apps/api/project.json
  - libs/domain/project.json
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "npx nx coverage api runs tests with coverage and reports to terminal"
    - "npx nx coverage domain runs tests with coverage and reports to terminal"
    - "CI workflow uses nx affected with proper base/head SHA resolution"
    - "CI workflow caches both uv and npm dependencies"
    - "CI workflow runs lint, typecheck, test, format check, and import-linter -- all blocking"
    - "All quality gates pass locally: lint, typecheck, test, format, import-linter"
  artifacts:
    - path: "apps/api/project.json"
      provides: "Coverage Nx target for api project"
      contains: "coverage"
    - path: "libs/domain/project.json"
      provides: "Coverage Nx target for domain project"
      contains: "coverage"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline with nx affected, caching, and all blocking checks"
      contains: "nx affected"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "apps/api/project.json"
      via: "nx affected -t lint typecheck test"
      pattern: "nx affected"
    - from: ".github/workflows/ci.yml"
      to: "libs/domain/project.json"
      via: "nx affected -t lint typecheck test"
      pattern: "nx affected"
---

<objective>
Add code coverage Nx targets for api and domain projects, then restructure the CI workflow with nx affected, dependency caching, and all quality checks as blocking gates.

Purpose: Complete the CI pipeline so all quality checks (lint, typecheck, test, format, import-linter) run automatically on PRs and block merges on failure. Add coverage reporting for test improvement signal.
Output: Working CI pipeline with nx affected + caching, coverage targets for both projects.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-code-quality/08-RESEARCH.md
@.planning/phases/08-ci-code-quality/08-03-SUMMARY.md

Key files:
@apps/api/project.json
@libs/domain/project.json
@.github/workflows/ci.yml
@pyproject.toml (coverage config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage Nx targets</name>
  <files>
    apps/api/project.json
    libs/domain/project.json
  </files>
  <action>
**1. Add coverage target to `apps/api/project.json`:**

Add a new `coverage` target alongside the existing targets:
```json
{
  "coverage": {
    "executor": "nx:run-commands",
    "options": {
      "command": "uv run --package personal-finance-api pytest tests/ -v --tb=short --cov=src --cov-config=../../pyproject.toml --cov-report=term-missing --cov-branch",
      "cwd": "{projectRoot}"
    },
    "inputs": [
      "{projectRoot}/**/*.py",
      "{workspaceRoot}/libs/domain/**/*.py"
    ],
    "outputs": []
  }
}
```

Key decisions:
- `--cov=src` measures coverage of src/ directory
- `--cov-config=../../pyproject.toml` uses the root pyproject.toml coverage config
- `--cov-report=term-missing` shows terminal output with missing lines (no HTML artifacts per CONTEXT)
- `--cov-branch` enables branch coverage (better signal for finance app per RESEARCH)
- Separate from `test` target (per CONTEXT: `npx nx coverage api` runs with coverage, `npx nx test api` runs fast)

**2. Add coverage target to `libs/domain/project.json`:**

```json
{
  "coverage": {
    "executor": "nx:run-commands",
    "options": {
      "command": "uv run --package personal-finance-domain pytest tests/ -v --tb=short --cov=domain --cov-config=../../pyproject.toml --cov-report=term-missing --cov-branch",
      "cwd": "{projectRoot}"
    },
    "inputs": [
      "{projectRoot}/**/*.py"
    ],
    "outputs": []
  }
}
```

Note: `--cov=domain` measures coverage of the domain/ directory (not src/).

**3. Test both targets:**

Run `npx nx coverage api` and `npx nx coverage domain` to verify they work. Both should run tests and output coverage summary to terminal.
  </action>
  <verify>
- `npx nx coverage api` runs all 252 api tests and outputs coverage report to terminal
- `npx nx coverage domain` runs all 192 domain tests and outputs coverage report to terminal
- `npx nx test api` still runs without coverage overhead (fast)
- `npx nx test domain` still runs without coverage overhead (fast)
  </verify>
  <done>Coverage Nx targets configured for both api and domain. Terminal-only output. Branch coverage enabled. Separate from test target.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure CI workflow with nx affected and caching</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Rewrite `.github/workflows/ci.yml` with the following structure:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for nx affected

      - name: Determine affected projects
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            uv.lock

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Lint (affected)
        run: npx nx affected -t lint --base=$NX_BASE --head=$NX_HEAD

      - name: Type check (affected)
        run: npx nx affected -t typecheck --base=$NX_BASE --head=$NX_HEAD

      - name: Format check
        run: uv run ruff format --check .

      - name: Import architecture check
        run: uv run lint-imports

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: personal_finance_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d personal_finance_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/personal_finance_test
      DATABASE_URL_SYNC: postgresql+psycopg2://postgres:postgres@localhost:5432/personal_finance_test
      TEST_DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/personal_finance_test
      ENVIRONMENT: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine affected projects
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            uv.lock

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: uv sync --all-packages

      - name: Test (affected)
        run: npx nx affected -t test --base=$NX_BASE --head=$NX_HEAD
```

Key changes from current CI:
1. **fetch-depth: 0** on checkout (required for nx affected git history)
2. **nrwl/nx-set-shas@v4** for automatic base/head SHA resolution
3. **nx affected** instead of `nx run-many` for lint, typecheck, and test
4. **uv caching** via `enable-cache: true` on `astral-sh/setup-uv@v4`
5. **npm caching** via `cache: "npm"` on `actions/setup-node@v4`
6. **npm ci** instead of `npm install` for deterministic builds
7. **Removed `master` branch** from triggers (only `main`)
8. **All checks are blocking** -- if any step fails, the job fails

Note: Rust toolchain is NOT needed in CI at this point because `uv sync --all-packages` installs from the lock file which may have pre-built wheels. If typeid-python needs Rust build, add a step for Rust toolchain setup. Test this by verifying `uv sync --all-packages` succeeds in CI.

**Final local verification:**

Run the full quality gate locally to simulate CI:
```bash
npx nx affected -t lint typecheck test --base=main --head=HEAD
uv run ruff format --check .
uv run lint-imports
```

All must pass with zero errors.
  </action>
  <verify>
- `cat .github/workflows/ci.yml` shows nx affected, caching, fetch-depth: 0
- `npx nx run-many -t lint typecheck test` passes locally (simulates CI)
- `uv run ruff format --check .` passes
- `uv run lint-imports` passes (2/2 contracts kept)
- All quality gates are blocking (each is a separate step in CI)
  </verify>
  <done>CI workflow restructured with nx affected, dependency caching (uv + npm), fetch-depth: 0, npm ci, all checks blocking. Quality and test jobs both use affected-only execution.</done>
</task>

</tasks>

<verification>
Full quality gate simulation (run all of these locally):

1. `npx nx run-many -t lint` -- zero errors across all projects
2. `npx nx run-many -t typecheck` -- zero errors across all projects
3. `npx nx run-many -t test` -- all 444 tests pass (252 api + 192 domain)
4. `uv run ruff format --check .` -- no formatting violations
5. `uv run lint-imports` -- 2/2 contracts kept
6. `npx nx coverage api` -- runs with coverage output
7. `npx nx coverage domain` -- runs with coverage output
8. `cat .github/workflows/ci.yml` -- uses nx affected, caching, blocking checks
</verification>

<success_criteria>
- Coverage targets work for both api and domain (`npx nx coverage api/domain`)
- CI workflow uses nx affected with proper SHA resolution
- CI caches uv and npm dependencies
- CI uses npm ci for deterministic builds
- All quality checks (lint, typecheck, test, format, import-linter) are blocking in CI
- Full local quality gate passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-code-quality/08-04-SUMMARY.md`
</output>
