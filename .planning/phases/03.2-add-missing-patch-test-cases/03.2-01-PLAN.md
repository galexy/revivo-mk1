---
phase: 03.2-add-missing-patch-test-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/test_transaction_api.py
autonomous: true

must_haves:
  truths:
    - "PATCH changing category split amount returns 200 and preserves split ID (M1)"
    - "PATCH changing transfer split amount syncs mirror amount (M2)"
    - "PATCH changing category_id on split returns 200 with new category (M3)"
    - "PATCH changing transfer destination deletes old mirror and creates new mirror (M4)"
    - "PATCH converting category split to transfer creates mirror (M5)"
    - "PATCH converting transfer split to category deletes mirror (M6)"
  artifacts:
    - path: "tests/integration/test_transaction_api.py"
      provides: "TestPatchSplitModifications class with M1-M6 tests"
      contains: "class TestPatchSplitModifications"
  key_links:
    - from: "TestPatchSplitModifications"
      to: "PATCH /api/v1/transactions/{id}"
      via: "TestClient.patch()"
      pattern: "client\\.patch.*transactions"
---

<objective>
Add integration tests for PATCH modification sub-cases M1-M6.

Purpose: Verify that PATCH endpoint correctly handles all split modification scenarios including amount changes, category changes, transfer destination changes, and category/transfer conversions.

Output: New `TestPatchSplitModifications` class in test_transaction_api.py with 6 tests covering M1-M6 cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-add-missing-patch-test-cases/03.2-RESEARCH.md
@tests/integration/test_transaction_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TestPatchSplitModifications class with M1-M6 tests</name>
  <files>tests/integration/test_transaction_api.py</files>
  <action>
Add a new test class `TestPatchSplitModifications` after the existing `TestSplitIdentity` class with 6 tests:

**Test 1 - M1: Amount changed (category split)**
```python
def test_m1_patch_category_split_amount_change(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """M1: PATCH changing amount on category split updates amount, preserves ID."""
```
- Create transaction with -100.00 category split
- PATCH to -150.00 with same split ID
- Assert 200, split ID preserved, amount changed

**Test 2 - M2: Amount changed (transfer split) - verify mirror sync**
```python
def test_m2_patch_transfer_split_amount_syncs_mirror(
    self, client: TestClient, test_account: JsonDict
) -> None:
    """M2: PATCH changing amount on transfer split syncs mirror amount."""
```
- Create savings account
- Create -500.00 transfer, capture split ID and mirror
- PATCH to -750.00 with same split ID
- Assert source amount updated
- Assert mirror amount updated to +750.00 (positive)

**Test 3 - M3: Category changed**
```python
def test_m3_patch_category_change(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """M3: PATCH changing category_id on split updates category."""
```
- Create two categories (cat1, cat2)
- Create transaction with cat1
- PATCH to cat2 with same split ID
- Assert category_id changed, split ID preserved

**Test 4 - M4: Transfer destination changed**
```python
def test_m4_patch_transfer_destination_change(
    self, client: TestClient, test_account: JsonDict
) -> None:
    """M4: PATCH changing transfer destination deletes old mirror, creates new."""
```
- Create savings1 and savings2 accounts
- Create -500.00 transfer to savings1
- Verify mirror exists in savings1
- PATCH to transfer to savings2 with same split ID
- Assert savings1 has 0 transactions (old mirror deleted)
- Assert savings2 has 1 mirror transaction
- Assert new mirror has correct amount and is_mirror=True

**Test 5 - M5: Category to Transfer conversion**
```python
def test_m5_patch_category_to_transfer_creates_mirror(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """M5: PATCH converting category split to transfer creates mirror."""
```
- Create savings account
- Create -200.00 transaction with category split
- Verify savings has 0 transactions
- PATCH split to be transfer (remove category_id, add transfer_account_id), keep split ID
- Assert 200
- Assert split now has transfer_account_id, no category_id
- Assert savings now has 1 mirror transaction with +200.00

**Test 6 - M6: Transfer to Category conversion**
```python
def test_m6_patch_transfer_to_category_deletes_mirror(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """M6: PATCH converting transfer split to category deletes mirror."""
```
- Create savings account
- Create -300.00 transfer to savings
- Verify mirror exists in savings
- PATCH split to be category (remove transfer_account_id, add category_id), keep split ID
- Assert 200
- Assert split now has category_id, no transfer_account_id
- Assert savings now has 0 transactions (mirror deleted)

**Important implementation details:**
- All tests must include `amount` in PATCH body when updating splits
- Always capture and verify split IDs are preserved
- For mirror verification, use GET /transactions?account_id={dest_id}
- Use `Decimal` for amount comparisons
- Follow existing test patterns (fixtures: client, test_account, test_category)
  </action>
  <verify>
Run tests with:
```bash
cd /workspace && python -m pytest tests/integration/test_transaction_api.py::TestPatchSplitModifications -v
```
All 6 tests should pass.
  </verify>
  <done>
TestPatchSplitModifications class exists with 6 passing tests covering M1-M6 modification sub-cases. Each test verifies both the PATCH response and any side effects (mirror creation/deletion/update).
  </done>
</task>

</tasks>

<verification>
1. All 6 M1-M6 tests pass: `pytest tests/integration/test_transaction_api.py::TestPatchSplitModifications -v`
2. No regressions in existing tests: `pytest tests/integration/test_transaction_api.py -v`
3. Tests follow existing patterns and use proper assertions
</verification>

<success_criteria>
- TestPatchSplitModifications class added to test_transaction_api.py
- 6 tests covering M1-M6 modification sub-cases
- All tests pass
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-add-missing-patch-test-cases/03.2-01-SUMMARY.md`
</output>
