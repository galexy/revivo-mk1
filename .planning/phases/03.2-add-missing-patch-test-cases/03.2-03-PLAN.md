---
phase: 03.2-add-missing-patch-test-cases
plan: 03
type: execute
wave: 3
depends_on: ["03.2-02"]
files_modified:
  - tests/integration/test_transaction_api.py
autonomous: true

must_haves:
  truths:
    - "PATCH with invalid split ID format returns 400"
    - "PATCH with non-existent split ID returns 400"
    - "PATCH split with neither category nor transfer returns 400"
    - "PATCH split with both category and transfer returns 400"
    - "PATCH with empty string category_id returns 422"
    - "PATCH with invalid category_id format returns 400"
  artifacts:
    - path: "tests/integration/test_transaction_api.py"
      provides: "TestPatchValidationErrors class with PATCH-specific validation tests"
      contains: "class TestPatchValidationErrors"
  key_links:
    - from: "TestPatchValidationErrors"
      to: "PATCH /api/v1/transactions/{id}"
      via: "TestClient.patch()"
      pattern: "client\\.patch.*transactions"
---

<objective>
Add integration tests for PATCH-specific validation errors.

Purpose: Verify that PATCH endpoint returns proper error codes (400/422) for invalid split IDs, missing required fields, and other validation errors. Ensure the critical success criterion "Invalid split ID in PATCH returns 400" is tested.

Output: New `TestPatchValidationErrors` class in test_transaction_api.py with 6 tests covering PATCH-specific validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-add-missing-patch-test-cases/03.2-RESEARCH.md
@.planning/phases/03.2-add-missing-patch-test-cases/03.2-02-SUMMARY.md
@tests/integration/test_transaction_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TestPatchValidationErrors class with PATCH-specific validation tests</name>
  <files>tests/integration/test_transaction_api.py</files>
  <action>
Add a new test class `TestPatchValidationErrors` after `TestPatchSplitAddRemove` with 6 tests:

**Test 1: Invalid split ID format**
```python
def test_patch_invalid_split_id_format_returns_400(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH with invalid split ID format returns 400."""
```
- Create transaction with category split
- PATCH with split having invalid ID format (e.g., "invalid_format" or "not_a_split_id")
- Assert 400 status
- Assert error contains "INVALID_ID_FORMAT" or similar

**Test 2: Non-existent split ID**
```python
def test_patch_nonexistent_split_id_returns_400(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH with split ID that doesn't exist returns 400."""
```
- Create transaction with category split
- PATCH with a valid-format split ID that doesn't exist (e.g., "split_01h455vb4pex5vsknk084sn02q")
- Assert 400 status
- Assert error indicates split not found or invalid

**Test 3: Split with neither category nor transfer**
```python
def test_patch_split_with_neither_category_nor_transfer_returns_400(
    self, client: TestClient, test_account: JsonDict
) -> None:
    """PATCH split with neither category_id nor transfer_account_id returns 400."""
```
- Create transaction with category split
- Capture split ID
- PATCH with split that has amount and ID but NO category_id and NO transfer_account_id
- Assert 400 status

**Test 4: Split with both category and transfer**
```python
def test_patch_split_with_both_category_and_transfer_returns_400(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH split with both category_id and transfer_account_id returns 400."""
```
- Create savings account
- Create transaction with category split
- Capture split ID
- PATCH with split that has BOTH category_id AND transfer_account_id
- Assert 400 status

**Test 5: Empty string category_id in PATCH**
```python
def test_patch_empty_string_category_id_returns_422(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH with empty string category_id returns 422 (Pydantic validation)."""
```
- Create transaction with category split
- Capture split ID
- PATCH with split having category_id: "" (empty string)
- Assert 422 status (Pydantic validation error)
- Assert "category_id" mentioned in error

**Test 6: Invalid category_id format in PATCH**
```python
def test_patch_invalid_category_id_format_returns_400(
    self, client: TestClient, test_account: JsonDict
) -> None:
    """PATCH with invalid category_id format returns 400."""
```
- Create transaction with category split (using a valid category)
- Capture split ID
- PATCH with split having category_id: "invalid_format"
- Assert 400 status
- Assert error contains "INVALID_ID_FORMAT" or similar

**Important implementation details:**
- All PATCH requests with splits must include `amount` field
- Use existing test_category fixture where valid category needed
- Invalid format IDs: "invalid_format", "not_a_valid_id"
- Non-existent but valid format: "split_01h455vb4pex5vsknk084sn02q" (TypeID format)
- Empty string triggers Pydantic validation (422), invalid format triggers TypeID parsing (400)
  </action>
  <verify>
Run tests with:
```bash
cd /workspace && python -m pytest tests/integration/test_transaction_api.py::TestPatchValidationErrors -v
```
All 6 tests should pass.
  </verify>
  <done>
TestPatchValidationErrors class exists with 6 passing tests covering PATCH-specific validation errors. Critical success criterion "Invalid split ID in PATCH returns 400" is verified.
  </done>
</task>

</tasks>

<verification>
1. All 6 validation tests pass: `pytest tests/integration/test_transaction_api.py::TestPatchValidationErrors -v`
2. No regressions in existing tests: `pytest tests/integration/test_transaction_api.py -v`
3. Full test suite passes: `pytest tests/ -v --ignore=tests/e2e`
4. Phase success criterion met: Invalid split ID in PATCH returns 400
</verification>

<success_criteria>
- TestPatchValidationErrors class added to test_transaction_api.py
- 6 tests covering PATCH-specific validation errors
- All tests pass
- Phase 3.2 success criterion #4 verified: "Invalid split ID in PATCH returns 400"
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-add-missing-patch-test-cases/03.2-03-SUMMARY.md`
</output>
