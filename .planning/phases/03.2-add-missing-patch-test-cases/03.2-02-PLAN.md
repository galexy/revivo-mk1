---
phase: 03.2-add-missing-patch-test-cases
plan: 02
type: execute
wave: 2
depends_on: ["03.2-01"]
files_modified:
  - tests/integration/test_transaction_api.py
autonomous: true

must_haves:
  truths:
    - "PATCH with same splits but no changes returns 200 with unchanged data"
    - "PATCH removing category split reduces split count"
    - "PATCH removing transfer split deletes the corresponding mirror"
    - "PATCH adding new category split increases split count"
    - "PATCH adding new transfer split creates new mirror"
    - "PATCH with mixed operations (update some, remove some, add some) works correctly"
  artifacts:
    - path: "tests/integration/test_transaction_api.py"
      provides: "TestPatchSplitAddRemove class with split add/remove tests"
      contains: "class TestPatchSplitAddRemove"
  key_links:
    - from: "TestPatchSplitAddRemove"
      to: "PATCH /api/v1/transactions/{id}"
      via: "TestClient.patch()"
      pattern: "client\\.patch.*transactions"
---

<objective>
Add integration tests for PATCH split addition and removal scenarios.

Purpose: Verify that PATCH endpoint correctly handles adding new splits, removing existing splits, and mixed operations. Verify that mirror lifecycle (create/delete) is properly managed during split changes.

Output: New `TestPatchSplitAddRemove` class in test_transaction_api.py with 6 tests covering split add/remove scenarios.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-add-missing-patch-test-cases/03.2-RESEARCH.md
@.planning/phases/03.2-add-missing-patch-test-cases/03.2-01-SUMMARY.md
@tests/integration/test_transaction_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TestPatchSplitAddRemove class with split add/remove tests</name>
  <files>tests/integration/test_transaction_api.py</files>
  <action>
Add a new test class `TestPatchSplitAddRemove` after `TestPatchSplitModifications` with 6 tests:

**Test 1: No changes (idempotent PATCH)**
```python
def test_patch_splits_no_changes_idempotent(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH with same splits and no changes is idempotent."""
```
- Create transaction with -100.00 single category split
- PATCH with exact same split (same ID, same amount, same category)
- Assert 200, split ID unchanged, all values unchanged

**Test 2: Remove category split**
```python
def test_patch_remove_category_split(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH removing a category split reduces split count."""
```
- Create two categories
- Create transaction with 2 splits (-60.00, -40.00 = -100.00 total)
- PATCH with only 1 split (-100.00) using one of the original IDs
- Assert 200, now has 1 split, split ID preserved

**Test 3: Remove transfer split (verify mirror deleted)**
```python
def test_patch_remove_transfer_split_deletes_mirror(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH removing transfer split deletes corresponding mirror."""
```
- Create savings account
- Create transaction with 2 splits: -300.00 transfer + -200.00 category = -500.00
- Verify savings has 1 mirror
- PATCH to only have category split (-500.00), remove transfer split
- Assert 200, now has 1 category split
- Assert savings has 0 transactions (mirror deleted)

**Test 4: Add new category split**
```python
def test_patch_add_new_category_split(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH adding new category split increases split count."""
```
- Create second category
- Create transaction with 1 split (-100.00)
- Capture original split ID
- PATCH with 2 splits: original split at -60.00 (with ID), new split at -40.00 (no ID)
- Assert 200, now has 2 splits
- Assert original split ID preserved
- Assert new split has generated ID (split_ prefix)

**Test 5: Add new transfer split (verify mirror created)**
```python
def test_patch_add_new_transfer_split_creates_mirror(
    self, client: TestClient, test_account: JsonDict, test_category: JsonDict
) -> None:
    """PATCH adding new transfer split creates new mirror."""
```
- Create savings account
- Create transaction with 1 category split (-500.00)
- Verify savings has 0 transactions
- PATCH to 2 splits: -300.00 transfer (no ID), -200.00 category (original ID)
- Assert 200, now has 2 splits
- Assert savings now has 1 mirror with +300.00

**Test 6: Mixed operations**
```python
def test_patch_mixed_update_remove_add_splits(
    self, client: TestClient, test_account: JsonDict
) -> None:
    """PATCH can update, remove, and add splits in single operation."""
```
- Create cat1, cat2, cat3 categories and savings account
- Create transaction with 3 splits: -50.00 cat1, -30.00 cat2, -20.00 transfer to savings = -100.00
- Capture all 3 split IDs and mirror
- PATCH with:
  - Split 1: Updated amount to -60.00 (same ID, same cat1)
  - Split 2: REMOVED (not included)
  - Split 3: REMOVED (not included)
  - New split: -40.00 cat3 (no ID)
- Assert 200, now has 2 splits total
- Assert split 1 ID preserved, amount changed
- Assert split 2 ID gone (cat2 split removed)
- Assert new split has new ID with cat3
- Assert savings has 0 transactions (transfer mirror deleted)

**Important implementation details:**
- Always include `amount` field when PATCH includes `splits`
- New splits (without ID) get server-generated IDs
- Splits not included in PATCH are removed
- Follow existing fixture patterns
- Use Decimal for amount comparisons
  </action>
  <verify>
Run tests with:
```bash
cd /workspace && python -m pytest tests/integration/test_transaction_api.py::TestPatchSplitAddRemove -v
```
All 6 tests should pass.
  </verify>
  <done>
TestPatchSplitAddRemove class exists with 6 passing tests covering split addition, removal, and mixed operation scenarios. Mirror lifecycle (create/delete) is verified during split changes.
  </done>
</task>

</tasks>

<verification>
1. All 6 add/remove tests pass: `pytest tests/integration/test_transaction_api.py::TestPatchSplitAddRemove -v`
2. No regressions in existing tests: `pytest tests/integration/test_transaction_api.py -v`
3. Mirror lifecycle correctly tested (created when transfer added, deleted when transfer removed)
</verification>

<success_criteria>
- TestPatchSplitAddRemove class added to test_transaction_api.py
- 6 tests covering split addition and removal scenarios
- All tests pass including mirror lifecycle verification
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-add-missing-patch-test-cases/03.2-02-SUMMARY.md`
</output>
