---
phase: 03.2-add-missing-patch-test-cases
plan: 03
subsystem: testing
tags: [pytest, fastapi, validation, patch, transactions]

# Dependency graph
requires:
  - phase: 03.2-02
    provides: TestPatchSplitAddRemove tests for split addition/removal
provides:
  - TestPatchValidationErrors class with 6 PATCH validation tests
  - PATCH validation for uncategorized splits
  - PATCH validation for non-existent split IDs
affects: [phase-4-web-interface]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "API-level validation for uncategorized splits (domain allows for flexibility)"
    - "Split ID existence validation before update"

key-files:
  created: []
  modified:
    - tests/integration/test_transaction_api.py
    - src/adapters/api/routes/transactions.py

key-decisions:
  - "PATCH rejects splits with neither category nor transfer (API validation, domain allows)"
  - "PATCH validates provided split IDs exist on transaction before update"

patterns-established:
  - "Validate split ID format first (TypeIDException), then existence (HTTPException)"
  - "Fetch transaction before split conversion to validate IDs"

# Metrics
duration: 4min
completed: 2026-02-03
---

# Phase 3.2 Plan 03: PATCH Validation Errors Summary

**6 tests for PATCH validation: invalid split ID format/existence, uncategorized splits, both category and transfer, empty string category, invalid category format**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-03T01:04:10Z
- **Completed:** 2026-02-03T01:08:12Z
- **Tasks:** 1 (with bug fixes)
- **Files modified:** 2

## Accomplishments
- Added TestPatchValidationErrors class with 6 comprehensive validation tests
- Fixed PATCH to reject splits with neither category_id nor transfer_account_id
- Fixed PATCH to validate provided split IDs exist on the transaction
- All 55 transaction API tests pass

## Task Commits

Each task was committed atomically:

1. **Task 1: Add TestPatchValidationErrors class** - `08e6220` (test)

**Plan metadata:** pending docs commit

## Files Created/Modified
- `tests/integration/test_transaction_api.py` - Added TestPatchValidationErrors class with 6 tests, updated test_patch_with_split_id_updates_specific_split to use categorized splits
- `src/adapters/api/routes/transactions.py` - Added validation for uncategorized splits and non-existent split IDs

## Decisions Made
- PATCH rejects uncategorized splits at API level (domain allows for flexibility, API enforces stricter rules)
- Validate split ID format before existence check (TypeIDException returns INVALID_ID_FORMAT, HTTPException returns INVALID_SPLIT_ID)
- Fetch transaction before split conversion to enable ID validation

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] PATCH accepts splits with neither category nor transfer**
- **Found during:** Task 1 (test_patch_split_with_neither_category_nor_transfer_returns_400 failed)
- **Issue:** PATCH endpoint accepted uncategorized splits, returning 200 instead of 400
- **Fix:** Added validation loop before split conversion that rejects splits without category_id or transfer_account_id
- **Files modified:** src/adapters/api/routes/transactions.py
- **Verification:** test_patch_split_with_neither_category_nor_transfer_returns_400 passes
- **Committed in:** 08e6220

**2. [Rule 1 - Bug] PATCH accepts non-existent split IDs**
- **Found during:** Task 1 (test_patch_nonexistent_split_id_returns_400 failed)
- **Issue:** PATCH endpoint accepted any valid format split ID without checking if it exists on the transaction
- **Fix:** Added transaction fetch before split conversion, then validate provided split IDs exist in transaction's splits
- **Files modified:** src/adapters/api/routes/transactions.py
- **Verification:** test_patch_nonexistent_split_id_returns_400 passes
- **Committed in:** 08e6220

**3. [Rule 1 - Bug] Existing test used uncategorized splits**
- **Found during:** Task 1 (test_patch_with_split_id_updates_specific_split failed after fix)
- **Issue:** Pre-existing test used uncategorized splits which are now rejected
- **Fix:** Updated test to use categorized splits (test_category and new cat2)
- **Files modified:** tests/integration/test_transaction_api.py
- **Verification:** test_patch_with_split_id_updates_specific_split passes
- **Committed in:** 08e6220

---

**Total deviations:** 3 auto-fixed (3 bugs)
**Impact on plan:** All auto-fixes necessary for correctness. Bugs discovered by the new tests were fixed inline.

## Issues Encountered
None - test failures led directly to bug discoveries which were fixed.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 3.2 complete: All 3 plans executed successfully
- 21 new PATCH tests added across plans 01-03
- 2 bugs fixed (uncategorized splits, non-existent split IDs)
- Ready for Phase 4: Web Interface & API

---
*Phase: 03.2-add-missing-patch-test-cases*
*Completed: 2026-02-03*
