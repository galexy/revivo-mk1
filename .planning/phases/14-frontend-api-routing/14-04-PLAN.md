---
phase: 14-frontend-api-routing
plan: 04
type: execute
wave: 3
depends_on: ["14-03"]
files_modified:
  - apps/web/package.json
  - apps/web/src/test-setup.ts
  - apps/web/src/mocks/handlers.ts
  - apps/web/src/mocks/server.ts
  - apps/web/src/mocks/fixtures.ts
  - apps/web/src/lib/api-client.test.ts
  - apps/web/src/lib/api-error.test.ts
autonomous: true

must_haves:
  truths:
    - "MSW is installed and configured to intercept API requests in tests"
    - "Unit tests verify API client functions return typed responses"
    - "Unit tests verify error parsing handles 4xx, 5xx, and network errors"
    - "MSW handlers cover auth, accounts, and error scenarios"
  artifacts:
    - path: "apps/web/src/mocks/handlers.ts"
      provides: "MSW request handlers for API endpoints"
      contains: "http.get"
    - path: "apps/web/src/mocks/server.ts"
      provides: "MSW server setup for tests"
      contains: "setupServer"
    - path: "apps/web/src/mocks/fixtures.ts"
      provides: "Test fixture data matching API response shapes"
      contains: "mockAccount"
    - path: "apps/web/src/lib/api-client.test.ts"
      provides: "Tests for type-safe API client functions"
      contains: "fetchAccounts"
    - path: "apps/web/src/lib/api-error.test.ts"
      provides: "Tests for API error parsing"
      contains: "parseApiError"
  key_links:
    - from: "apps/web/src/mocks/handlers.ts"
      to: "apps/web/src/lib/api-client.ts"
      via: "handlers match the same endpoints api-client calls"
      pattern: "/api/v1/accounts"
    - from: "apps/web/src/test-setup.ts"
      to: "apps/web/src/mocks/server.ts"
      via: "starts MSW server before tests"
      pattern: "server"
---

<objective>
Set up MSW (Mock Service Worker) for API mocking in tests and write unit tests for the API client and error handling utilities.

Purpose: MSW intercepts at the network boundary, testing the full chain (component -> hook -> TanStack Query -> Axios -> interceptors). This test infrastructure supports all future Phase 15-26 component tests. Tests verify the data layer patterns work correctly.

Output: MSW handlers, test fixtures, API client tests, error parsing tests.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/lib/api-client.ts
@apps/web/src/lib/api-error.ts
@apps/web/src/lib/api.ts
@apps/web/src/test-setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MSW and create mock infrastructure</name>
  <files>
    apps/web/package.json
    apps/web/src/mocks/handlers.ts
    apps/web/src/mocks/server.ts
    apps/web/src/mocks/fixtures.ts
    apps/web/src/test-setup.ts
  </files>
  <action>
    1. Install MSW: `cd apps/web && pnpm add -D msw`

    2. Create `apps/web/src/mocks/fixtures.ts`:
       - Export mock data matching the generated API types (AccountResponse, TransactionResponse, etc.)
       - Use realistic but minimal fixture data:
         ```typescript
         export const mockAccount = {
           id: 'acct_01234567890123456789abcdef',
           name: 'Checking',
           account_type: 'checking',
           // ... match AccountResponse schema from generated types
         };
         export const mockAccounts = [mockAccount, ...];
         export const mockTransaction = { ... };
         export const mockCategory = { ... };
         ```
       - Import types from generated api-types to ensure fixtures match schema

    3. Create `apps/web/src/mocks/handlers.ts`:
       - Import `http` and `HttpResponse` from `msw`
       - Import fixtures from `./fixtures`
       - Export default handlers array:
         ```typescript
         export const handlers = [
           // Accounts
           http.get('http://localhost:8000/api/v1/accounts', () =>
             HttpResponse.json(mockAccounts)),
           http.get('http://localhost:8000/api/v1/accounts/:id', ({ params }) =>
             HttpResponse.json(mockAccount)),

           // Categories
           http.get('http://localhost:8000/api/v1/categories', () =>
             HttpResponse.json(mockCategories)),
           http.get('http://localhost:8000/api/v1/categories/tree', () =>
             HttpResponse.json(mockCategoryTree)),

           // Payees
           http.get('http://localhost:8000/api/v1/payees', () =>
             HttpResponse.json(mockPayees)),

           // Auth (for refresh)
           http.post('http://localhost:8000/auth/refresh', () =>
             HttpResponse.json({ access_token: 'mock-token', token_type: 'bearer', expires_in: 900 })),
           http.get('http://localhost:8000/auth/me', () =>
             HttpResponse.json(mockUserProfile)),
         ];
         ```
       - Use full URL (http://localhost:8000) since the Axios instance has baseURL set

    4. Create `apps/web/src/mocks/server.ts`:
       - Import `setupServer` from `msw/node`
       - Import handlers from `./handlers`
       - Export server: `export const server = setupServer(...handlers)`

    5. Update `apps/web/src/test-setup.ts`:
       - Import `server` from `./mocks/server`
       - Add MSW lifecycle hooks:
         ```typescript
         import { server } from './mocks/server';

         beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }));
         afterEach(() => server.resetHandlers());
         afterAll(() => server.close());
         ```
       - Keep existing matchMedia mock, ResizeObserver mock, and cleanup

    6. Run `npx nx test web` to verify existing tests still pass with MSW server running.
  </action>
  <verify>
    - `pnpm ls msw` shows package installed
    - `npx nx test web` passes (existing tests + MSW lifecycle)
    - No "unhandled request" warnings from MSW for existing tests
  </verify>
  <done>
    MSW installed and configured. Mock handlers cover key API endpoints. Server starts/stops cleanly in test lifecycle. Existing tests unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write API client and error handling tests</name>
  <files>
    apps/web/src/lib/api-client.test.ts
    apps/web/src/lib/api-error.test.ts
  </files>
  <action>
    1. Create `apps/web/src/lib/api-error.test.ts`:
       - Test `parseApiError`:
         - AxiosError with 400 + `{ detail: { code: 'VALIDATION_ERROR', message: 'Name required' } }` -> ApiError with isValidation=true
         - AxiosError with 401 + `{ detail: 'Invalid credentials' }` -> ApiError with string detail
         - AxiosError with 500 -> ApiError with isServerError=true
         - Network error (no response) -> ApiError with code 'NETWORK_ERROR'
         - Unknown error (not AxiosError) -> generic server error
       - Test `getErrorMessage`:
         - 400 error -> returns backend message directly
         - 500 error -> returns friendly "Something went wrong" message
         - Network error -> returns connection message

    2. Create `apps/web/src/lib/api-client.test.ts`:
       - Import `server` from `../mocks/server` (already running via test-setup)
       - Import `http`, `HttpResponse` from `msw`
       - Test `fetchAccounts`:
         - Returns array of accounts (from default handler)
         - Verify return type matches expected shape
       - Test `fetchAccount(id)`:
         - Returns single account by ID
       - Test API error scenarios:
         - Use `server.use()` to override handler with error response
         - 404 -> throws AxiosError with 404
         - 500 -> throws AxiosError with 500
       - Keep tests minimal (3-5 tests) â€” this validates the wiring, not business logic

    3. Run all quality checks:
       - `npx nx typecheck web`
       - `npx nx test web`
       - `npx nx lint web`
  </action>
  <verify>
    - `npx nx test web` passes with new tests
    - `npx nx typecheck web` passes
    - `npx nx lint web` passes
    - api-error.test.ts covers all error parse scenarios
    - api-client.test.ts covers happy path and error responses
  </verify>
  <done>
    API client tests verify typed responses. Error parsing tests cover all error formats. MSW intercepts correctly at network boundary. Test count increased.
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck web` passes
2. `npx nx test web` passes (all existing + new tests)
3. `npx nx lint web` passes
4. MSW server lifecycle in test-setup.ts
5. Mock handlers match API endpoints
6. API client tests verify typed responses from MSW
7. Error parsing tests cover 4xx, 5xx, and network errors
</verification>

<success_criteria>
- MSW configured and intercepting API requests in tests
- API client tests pass with typed mock responses
- Error parsing tests cover all error categories
- All quality checks pass
- Test infrastructure ready for Phase 15+ component testing
</success_criteria>

<output>
After completion, create `.planning/phases/14-frontend-api-routing/14-04-SUMMARY.md`
</output>
