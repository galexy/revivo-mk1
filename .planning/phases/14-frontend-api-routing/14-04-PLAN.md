---
phase: 14-frontend-api-routing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/e2e/smoke.spec.ts
  - apps/web/e2e/auth.setup.ts
  - apps/web/playwright.config.ts
  - apps/web/.gitignore
autonomous: true

must_haves:
  truths:
    - "Playwright smoke test verifies login page loads without errors"
    - "Auth setup fixture registers, verifies email via Mailpit API, and logs in a test user"
    - "Authenticated smoke test verifies dashboard loads after login"
    - "e2e tests work with the auth-guarded app (not old placeholder shell)"
  artifacts:
    - path: "apps/web/e2e/smoke.spec.ts"
      provides: "Updated smoke tests for auth-guarded app"
      contains: "login"
    - path: "apps/web/e2e/auth.setup.ts"
      provides: "Playwright auth setup fixture with Mailpit email verification"
      contains: "storageState"
    - path: "apps/web/playwright.config.ts"
      provides: "Updated config with auth setup project"
      contains: "setup"
  key_links:
    - from: "apps/web/e2e/auth.setup.ts"
      to: "apps/web/src/pages/LoginPage.tsx"
      via: "fills login form to authenticate"
      pattern: "fill.*email|password"
    - from: "apps/web/e2e/smoke.spec.ts"
      to: "apps/web/src/pages/DashboardPage.tsx"
      via: "navigates to dashboard after auth"
      pattern: "dashboard|Personal Finance"
    - from: "apps/web/e2e/auth.setup.ts"
      to: "http://mailpit:8025/api/v1/messages"
      via: "fetches verification email from Mailpit REST API"
      pattern: "mailpit.*messages"
---

<objective>
Update Playwright e2e smoke tests for the auth-guarded app. Replace old placeholder expectations with login page tests and add auth fixtures for authenticated test scenarios.

Purpose: The current smoke.spec.ts expects the old placeholder shell (Phase 12) but Phase 13 replaced it with auth-guarded login flow. This plan fixes the broken e2e tests and establishes auth fixtures that all future e2e tests will use.

Output: Working smoke tests, auth setup fixture with email verification, Playwright config with auth project.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/e2e/smoke.spec.ts
@apps/web/playwright.config.ts
@apps/web/src/routes.tsx
@apps/web/src/pages/LoginPage.tsx
@apps/web/src/pages/DashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth setup fixture and update Playwright config</name>
  <files>
    apps/web/e2e/auth.setup.ts
    apps/web/playwright.config.ts
    apps/web/.gitignore
  </files>
  <action>
    1. Create `apps/web/e2e/auth.setup.ts`:
       - This is a Playwright setup project that runs before authenticated tests.
       - It registers a test user, verifies the email via Mailpit API, and logs in.

       **Approach: Register via API + verify via Mailpit API + login via UI.**

       Login requires email verification (backend returns EMAIL_NOT_VERIFIED for unverified users).
       The setup uses Mailpit's REST API (http://mailpit:8025/api/v1/) to fetch the verification
       token from the email, then calls the backend verify endpoint directly.

       ```typescript
       import { test as setup, expect } from '@playwright/test';

       const TEST_USER = {
         email: 'e2e-test@example.com',
         password: 'TestPass123!',
         displayName: 'E2E Test User',
       };

       const API_BASE = 'http://localhost:8000';
       const MAILPIT_API = 'http://mailpit:8025/api/v1';

       setup('authenticate', async ({ page }) => {
         // Step 1: Try to log in first (user may already exist and be verified)
         await page.goto('/login');
         await page.getByLabel('Email').fill(TEST_USER.email);
         await page.getByLabel('Password').fill(TEST_USER.password);
         await page.getByRole('button', { name: /sign in/i }).click();

         // Wait briefly for response
         const loginResponse = await Promise.race([
           page.waitForURL('**/dashboard', { timeout: 5000 }).then(() => 'success'),
           page.waitForTimeout(5000).then(() => 'timeout'),
         ]);

         if (loginResponse === 'success') {
           // User already exists and is verified — save state and done
           await page.context().storageState({ path: 'apps/web/e2e/.auth/user.json' });
           return;
         }

         // Step 2: Register via API (POST /auth/register)
         // Returns 202 always (enumeration protection), so this is idempotent
         await page.request.post(`${API_BASE}/auth/register`, {
           data: {
             email: TEST_USER.email,
             password: TEST_USER.password,
             display_name: TEST_USER.displayName,
           },
         });

         // Step 3: Get verification token from Mailpit
         // Mailpit REST API: GET /api/v1/messages returns list of emails
         // Wait briefly for email delivery
         await page.waitForTimeout(1000);

         const messagesResponse = await page.request.get(`${MAILPIT_API}/messages`);
         const messagesData = await messagesResponse.json();

         // Find the verification email for our test user
         const verificationEmail = messagesData.messages?.find(
           (msg: { To: Array<{ Address: string }>; Subject: string }) =>
             msg.To?.some((to: { Address: string }) => to.Address === TEST_USER.email) &&
             msg.Subject?.includes('erif')
         );

         if (!verificationEmail) {
           throw new Error('Verification email not found in Mailpit');
         }

         // Get the full email content to extract the verification token
         const emailResponse = await page.request.get(`${MAILPIT_API}/message/${verificationEmail.ID}`);
         const emailData = await emailResponse.json();

         // Extract verification token from email body (HTML or text)
         // The verification URL format: http://host/verify?token=<TOKEN>
         const emailBody = emailData.HTML || emailData.Text || '';
         const tokenMatch = emailBody.match(/[?&]token=([^"&\s<]+)/);
         if (!tokenMatch) {
           throw new Error('Verification token not found in email body');
         }
         const verificationToken = tokenMatch[1];

         // Step 4: Verify email via API
         const verifyResponse = await page.request.get(
           `${API_BASE}/auth/verify?token=${encodeURIComponent(verificationToken)}`
         );
         expect(verifyResponse.ok()).toBeTruthy();

         // Step 5: Log in via UI
         await page.goto('/login');
         await page.getByLabel('Email').fill(TEST_USER.email);
         await page.getByLabel('Password').fill(TEST_USER.password);
         await page.getByRole('button', { name: /sign in/i }).click();

         // Wait for redirect to dashboard
         await page.waitForURL('**/dashboard');
         await expect(page.getByText('Personal Finance')).toBeVisible();

         // Save signed-in state to file
         await page.context().storageState({ path: 'apps/web/e2e/.auth/user.json' });
       });
       ```

    2. Update `apps/web/playwright.config.ts`:
       - Add a `setup` project that runs auth.setup.ts
       - Add `storageState` to the chromium project so all tests run authenticated
       ```typescript
       projects: [
         // Setup project: authenticate once
         { name: 'setup', testMatch: /.*\.setup\.ts/ },
         // Test project: use authenticated state
         {
           name: 'chromium',
           use: {
             ...devices['Desktop Chrome'],
             headless: true,
             storageState: 'apps/web/e2e/.auth/user.json',
             launchOptions: {
               executablePath: '/usr/bin/chromium',
               args: ['--no-sandbox', '--disable-gpu', '--disable-dev-shm-usage'],
             },
           },
           dependencies: ['setup'],
         },
       ]
       ```
       - NOTE: The setup project should NOT use storageState (it creates it).

    3. Add to `apps/web/.gitignore` (create if needed): `e2e/.auth/`

    4. Create directory: `mkdir -p apps/web/e2e/.auth`
  </action>
  <verify>
    - `apps/web/e2e/auth.setup.ts` exists with Mailpit API integration
    - `apps/web/playwright.config.ts` has setup project and storageState
    - `.gitignore` includes auth state directory
    - No exploratory comments or multiple approaches — single clear implementation
  </verify>
  <done>
    Auth setup fixture registers user, verifies email via Mailpit REST API, and logs in via UI. Playwright config uses setup project as dependency for authenticated tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite smoke tests for auth-guarded app</name>
  <files>
    apps/web/e2e/smoke.spec.ts
  </files>
  <action>
    1. Rewrite `apps/web/e2e/smoke.spec.ts`:
       - Remove old tests that expect placeholder shell (hardcoded balances, "Quick Add Transaction", "Accounts" sidebar)
       - Add unauthenticated smoke test (runs without auth state):
         ```typescript
         test.describe('Unauthenticated', () => {
           test.use({ storageState: { cookies: [], origins: [] } });

           test('redirects to login page', async ({ page }) => {
             await page.goto('/');
             await page.waitForURL('**/login');
             await expect(page.getByRole('heading', { name: /sign in/i })).toBeVisible();
           });

           test('login page loads without errors', async ({ page }) => {
             const errors: string[] = [];
             page.on('console', (msg) => {
               if (msg.type() === 'error') errors.push(msg.text());
             });

             await page.goto('/login');
             await expect(page.getByRole('heading', { name: /sign in/i })).toBeVisible();
             await expect(page.getByLabel('Email')).toBeVisible();
             await expect(page.getByLabel('Password')).toBeVisible();
             expect(errors).toHaveLength(0);
           });
         });
         ```
       - Add authenticated smoke test (uses saved auth state from setup):
         ```typescript
         test.describe('Authenticated', () => {
           test('dashboard loads after login', async ({ page }) => {
             await page.goto('/dashboard');
             await expect(page.getByText('Personal Finance')).toBeVisible();
           });

           test('dashboard has user menu', async ({ page }) => {
             await page.goto('/dashboard');
             // UserMenu shows user initials
             await expect(page.getByRole('button')).toBeVisible();
           });
         });
         ```

    2. The tests should pass when both API backend and web frontend are running.
       Verify by:
       - Starting `npx nx serve api` (background)
       - Starting `npx nx serve web` (background)
       - Running `npx nx e2e web`
       - Stopping both servers
  </action>
  <verify>
    - Smoke tests are rewritten for auth-guarded app
    - No references to old placeholder content (hardcoded balances, etc.)
    - Unauthenticated test verifies login page loads
    - Authenticated test verifies dashboard loads
    - `npx nx e2e web` passes with both servers running
  </verify>
  <done>
    Smoke tests updated for auth-guarded app. Login page smoke test works without auth. Dashboard smoke test uses saved auth state. All e2e tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx nx e2e web` passes with API + web servers running
2. Unauthenticated tests verify login page
3. Authenticated tests verify dashboard (using auth fixture)
4. No stale references to old placeholder shell
5. Auth state file properly gitignored
</verification>

<success_criteria>
- Playwright smoke tests work with auth-guarded app
- Auth setup fixture registers, verifies email via Mailpit API, and logs in test user
- Unauthenticated tests verify login page loads
- Authenticated tests verify dashboard loads after login
- e2e test infrastructure ready for Phase 15+ feature tests
</success_criteria>

<output>
After completion, create `.planning/phases/14-frontend-api-routing/14-04-SUMMARY.md`
</output>
