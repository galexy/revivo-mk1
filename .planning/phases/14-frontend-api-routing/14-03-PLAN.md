---
phase: 14-frontend-api-routing
plan: 03
type: execute
wave: 2
depends_on: ["14-02"]
files_modified:
  - apps/web/src/lib/query-options.ts
  - apps/web/src/lib/api-error.ts
  - apps/web/src/features/auth/context/AuthContext.tsx
autonomous: true

must_haves:
  truths:
    - "queryOptions factories exist for accounts, transactions, categories, payees"
    - "API errors are parsed into a consistent ApiError type with code and message"
    - "4xx errors are available for inline display, 5xx errors bubble to error boundaries"
    - "Auth context login/profile fetching uses TanStack Query-compatible patterns"
  artifacts:
    - path: "apps/web/src/lib/query-options.ts"
      provides: "queryOptions factories for all entity types"
      contains: "queryOptions"
    - path: "apps/web/src/lib/api-error.ts"
      provides: "API error parsing utilities"
      contains: "ApiError"
  key_links:
    - from: "apps/web/src/lib/query-options.ts"
      to: "apps/web/src/lib/api-client.ts"
      via: "uses typed API client functions as queryFn"
      pattern: "fetchAccounts|fetchTransactions"
    - from: "apps/web/src/lib/query-options.ts"
      to: "apps/web/src/lib/query-keys.ts"
      via: "uses query key factory for cache keys"
      pattern: "queryKeys"
---

<objective>
Create queryOptions factories for all entity types and establish consistent API error handling patterns.

Purpose: queryOptions factories are the single source of truth for query configuration (key + fn + staleTime). API error parsing ensures consistent error display across all future UI components. These patterns are used by every Phase 15-26 feature.

Output: Reusable queryOptions, API error utilities, error handling patterns.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/lib/api-client.ts
@apps/web/src/lib/query-keys.ts
@apps/web/src/lib/query-client.ts
@apps/web/src/lib/api.ts
@apps/web/src/features/auth/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create queryOptions factories and API error utilities</name>
  <files>
    apps/web/src/lib/query-options.ts
    apps/web/src/lib/api-error.ts
  </files>
  <action>
    1. Create `apps/web/src/lib/api-error.ts`:
       - Define `ApiError` type:
         ```typescript
         export interface ApiError {
           status: number;
           code: string;
           message: string;
           isValidation: boolean;   // 4xx
           isServerError: boolean;  // 5xx
         }
         ```
       - Export `parseApiError(error: unknown): ApiError` function:
         - If AxiosError with response: extract status, parse detail (FastAPI returns `{ detail: string | { code, message } }`)
         - Handle both string detail (auth endpoints) and object detail (domain endpoints)
         - If network error (no response): return `{ status: 0, code: 'NETWORK_ERROR', message: 'Unable to connect to server', ... }`
         - If unknown error: return generic server error
       - Export `isApiError(error: unknown): error is AxiosError` type guard
       - Export `getErrorMessage(error: unknown): string` convenience function that returns user-friendly message:
         - For validation errors (4xx): use backend message directly (it's specific and actionable, per user decision)
         - For server errors (5xx): return friendly "Something went wrong. Please try again." (per user decision)
         - For network errors: return "Unable to connect. Please check your connection."

    2. Create `apps/web/src/lib/query-options.ts`:
       - Import `queryOptions` from `@tanstack/react-query`
       - Import API client functions from `./api-client`
       - Import query keys from `./query-keys`
       - Create queryOptions factories following TkDodo's v5 pattern:

         ```typescript
         // Accounts
         export const accountsQueryOptions = queryOptions({
           queryKey: queryKeys.accounts.lists(),
           queryFn: fetchAccounts,
           staleTime: 60_000, // accounts rarely change
         });

         export const accountDetailQueryOptions = (id: string) =>
           queryOptions({
             queryKey: queryKeys.accounts.detail(id),
             queryFn: () => fetchAccount(id),
             staleTime: 60_000,
           });

         // Transactions
         export const transactionsQueryOptions = (accountId: string) =>
           queryOptions({
             queryKey: queryKeys.transactions.list({ accountId }),
             queryFn: () => fetchTransactions(accountId),
             staleTime: 15_000, // transactions change more often
           });

         export const transactionDetailQueryOptions = (id: string) =>
           queryOptions({
             queryKey: queryKeys.transactions.detail(id),
             queryFn: () => fetchTransaction(id),
             staleTime: 15_000,
           });

         // Categories
         export const categoriesQueryOptions = queryOptions({
           queryKey: queryKeys.categories.lists(),
           queryFn: fetchCategories,
           staleTime: 5 * 60_000, // categories very rarely change
         });

         export const categoryTreeQueryOptions = queryOptions({
           queryKey: queryKeys.categories.tree(),
           queryFn: fetchCategoryTree,
           staleTime: 5 * 60_000,
         });

         // Payees
         export const payeesQueryOptions = queryOptions({
           queryKey: queryKeys.payees.lists(),
           queryFn: fetchPayees,
           staleTime: 60_000,
         });
         ```

    3. Run quality checks:
       - `npx nx typecheck web`
       - `npx nx lint web`
  </action>
  <verify>
    - `npx nx typecheck web` passes
    - `npx nx lint web` passes
    - query-options.ts exports factories for accounts, transactions, categories, payees
    - api-error.ts exports parseApiError, getErrorMessage, ApiError type
  </verify>
  <done>
    queryOptions factories configured with per-entity stale times. API error parsing handles FastAPI error format consistently. Error messages follow user decision (backend messages for validation, friendly messages for server errors).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AuthContext to use query-compatible patterns</name>
  <files>
    apps/web/src/features/auth/context/AuthContext.tsx
  </files>
  <action>
    1. Update `apps/web/src/features/auth/context/AuthContext.tsx`:
       - Import `getErrorMessage` from `../../../lib/api-error`
       - In the `login` function, wrap the error handling to use `getErrorMessage`:
         - Currently the login function throws the raw AxiosError
         - The calling component (LoginForm) catches and displays `error.response?.data?.detail`
         - This is fine for now — LoginForm handles its own errors per Phase 13 pattern
         - NO CHANGES needed to login error handling (it already works)
       - Keep the existing AuthContext implementation as-is for now
       - The important thing is that `api-error.ts` utilities are available for FUTURE use by Phase 15+ components
       - Do NOT refactor AuthContext to use TanStack Query for auth state — auth state management via React Context is the correct pattern (per user decision: auth state = React Context, server state = TanStack Query)

    2. Run all quality checks:
       - `npx nx typecheck web`
       - `npx nx test web`
       - `npx nx lint web`
  </action>
  <verify>
    - `npx nx typecheck web` passes
    - `npx nx test web` passes (all 17 existing tests)
    - `npx nx lint web` passes
    - AuthContext unchanged except for any minimal imports
  </verify>
  <done>
    Auth context preserved as React Context (per user decision). API error utilities available for future components. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck web` passes
2. `npx nx test web` passes
3. `npx nx lint web` passes
4. queryOptions factories exist for all entity types with appropriate stale times
5. API error utilities handle FastAPI error format correctly
</verification>

<success_criteria>
- queryOptions factories usable by route loaders and components
- API errors parsed consistently with user-friendly messages
- Auth context unchanged (React Context for auth, TanStack Query for server state)
- All quality checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-frontend-api-routing/14-03-SUMMARY.md`
</output>
