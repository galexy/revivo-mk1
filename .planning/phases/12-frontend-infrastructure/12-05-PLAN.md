---
phase: 12-frontend-infrastructure
plan: 05
type: execute
wave: 5
depends_on: ["12-04"]
files_modified:
  - apps/web/src/test-setup.ts
  - apps/web/src/app/app.spec.tsx
  - apps/web/e2e/smoke.spec.ts
  - apps/web/playwright.config.ts
  - apps/web/project.json
  - apps/web/tsconfig.json
  - apps/web/tsconfig.spec.json
autonomous: true

must_haves:
  truths:
    - "Vitest component test runs and passes via npx nx test web"
    - "Playwright smoke test runs and passes via npx nx e2e web (with dev server running)"
    - "All Nx targets exist for web project: serve, test, lint, typecheck, format, e2e"
    - "ESLint lint target catches TypeScript issues in web project"
    - "TypeScript typecheck target runs strict mode on web project"
  artifacts:
    - path: "apps/web/src/test-setup.ts"
      provides: "Vitest setup with RTL matchers"
      contains: "jest-dom"
    - path: "apps/web/src/app/app.spec.tsx"
      provides: "Sample component test"
      contains: "render"
    - path: "apps/web/e2e/smoke.spec.ts"
      provides: "Playwright smoke test"
      contains: "page.goto"
    - path: "apps/web/playwright.config.ts"
      provides: "Playwright configuration"
      contains: "defineConfig"
    - path: "apps/web/project.json"
      provides: "Nx targets for web project"
      contains: "typecheck"
  key_links:
    - from: "apps/web/project.json"
      to: "apps/web/vite.config.ts"
      via: "Nx inferred targets or explicit commands"
      pattern: "test|lint|typecheck"
    - from: "apps/web/src/test-setup.ts"
      to: "apps/web/vite.config.ts"
      via: "setupFiles reference"
      pattern: "test-setup"
---

<objective>
Set up Vitest with React Testing Library for component testing, Playwright for smoke E2E testing, and complete the Nx target suite for the web project.

Purpose: Establish the testing infrastructure and Nx targets that CI will use for frontend quality gates.
Output: Working Vitest component test, Playwright smoke test, and complete Nx targets (serve, test, lint, typecheck, format, e2e) for the web project.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-infrastructure/12-CONTEXT.md
@.planning/phases/12-frontend-infrastructure/12-RESEARCH.md
@.planning/phases/12-frontend-infrastructure/12-01-SUMMARY.md
@.planning/phases/12-frontend-infrastructure/12-02-SUMMARY.md
@.planning/phases/12-frontend-infrastructure/12-03-SUMMARY.md
@.planning/phases/12-frontend-infrastructure/12-04-SUMMARY.md
@apps/web/vite.config.ts
@apps/web/project.json
@apps/web/tsconfig.json
@eslint.config.mjs
@nx.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vitest + React Testing Library setup with sample test</name>
  <files>
    apps/web/src/test-setup.ts
    apps/web/src/app/app.spec.tsx
    apps/web/tsconfig.spec.json
  </files>
  <action>
    1. Install Vitest and React Testing Library dependencies:
       ```bash
       cd /workspace/apps/web && pnpm add -D vitest jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event
       ```
    2. Create `apps/web/src/test-setup.ts`:
       ```typescript
       import '@testing-library/jest-dom/vitest';
       import { cleanup } from '@testing-library/react';
       import { afterEach } from 'vitest';

       // Cleanup after each test (unmount React trees)
       afterEach(() => {
         cleanup();
       });
       ```
       NOTE: `@testing-library/jest-dom/vitest` auto-extends vitest expect with jest-dom matchers (toBeInTheDocument, toHaveTextContent, etc.). This is the modern import path -- do NOT use the old `expect.extend(matchers)` pattern.
    3. Create `apps/web/tsconfig.spec.json` for test files (allows vitest globals):
       ```json
       {
         "extends": "./tsconfig.json",
         "compilerOptions": {
           "types": ["vitest/globals", "vite/client", "@testing-library/jest-dom"]
         },
         "include": ["src/**/*.spec.ts", "src/**/*.spec.tsx", "src/**/*.test.ts", "src/**/*.test.tsx", "src/test-setup.ts"]
       }
       ```
    4. Create `apps/web/src/app/app.spec.tsx`:
       ```typescript
       import { render, screen } from '@testing-library/react';
       import { describe, it, expect } from 'vitest';
       import { App } from './app';

       describe('App', () => {
         it('renders the app heading', () => {
           render(<App />);
           expect(screen.getByText('Personal Finance')).toBeInTheDocument();
         });

         it('renders without crashing', () => {
           const { container } = render(<App />);
           expect(container).toBeTruthy();
         });
       });
       ```
       NOTE: This test imports from './app' (the local component). It does NOT test shadcn/ui components from @workspace/ui -- that would require the path alias to resolve in vitest. The vite.config.ts test section with nxViteTsPaths should handle that, but for this basic test we use a local import.
    5. Verify: `npx vitest run --config apps/web/vite.config.ts` passes both tests
    6. If path resolution issues occur with @workspace/ui in tests, ensure the nxViteTsPaths plugin is working in test mode. The vitest test section in vite.config.ts inherits plugins from the main config.

    IMPORTANT: The vite.config.ts already has `setupFiles: './src/test-setup.ts'` and `globals: true` in the test section (from plan 12-02). Vitest will use these settings automatically.
  </action>
  <verify>
    - `npx vitest run --config apps/web/vite.config.ts` passes (2 tests)
    - test-setup.ts imports jest-dom matchers
    - Tests use @testing-library/react render and screen
  </verify>
  <done>Vitest + React Testing Library configured with setup file and sample component test.</done>
</task>

<task type="auto">
  <name>Task 2: Playwright smoke test + complete Nx targets</name>
  <files>
    apps/web/e2e/smoke.spec.ts
    apps/web/playwright.config.ts
    apps/web/project.json
  </files>
  <action>
    1. Install Playwright:
       ```bash
       cd /workspace && pnpm add -D @playwright/test
       npx playwright install --with-deps chromium
       ```
       NOTE: Only install chromium browser (not all browsers) to minimize disk usage. Smoke test only needs one browser.
    2. Create `apps/web/playwright.config.ts`:
       ```typescript
       import { defineConfig, devices } from '@playwright/test';

       export default defineConfig({
         testDir: './e2e',
         fullyParallel: true,
         forbidOnly: !!process.env['CI'],
         retries: process.env['CI'] ? 2 : 0,
         workers: process.env['CI'] ? 1 : undefined,
         reporter: 'html',
         use: {
           baseURL: 'http://localhost:5173',
           trace: 'on-first-retry',
         },
         projects: [
           {
             name: 'chromium',
             use: { ...devices['Desktop Chrome'] },
           },
         ],
         /* Do NOT configure webServer here -- developer starts servers manually.
          * This matches the CONTEXT.md decision: "Frontend and API serve targets
          * are independent -- developer runs both manually." */
       });
       ```
    3. Create `apps/web/e2e/smoke.spec.ts`:
       ```typescript
       import { test, expect } from '@playwright/test';

       test.describe('Smoke Tests', () => {
         test('app loads without errors', async ({ page }) => {
           // Collect console errors
           const errors: string[] = [];
           page.on('console', (msg) => {
             if (msg.type() === 'error') {
               errors.push(msg.text());
             }
           });

           await page.goto('/');

           // Verify page title
           await expect(page).toHaveTitle(/Personal Finance/);

           // Verify app rendered (heading visible)
           await expect(page.getByRole('heading', { name: 'Personal Finance' })).toBeVisible();

           // Verify no console errors
           expect(errors).toHaveLength(0);
         });

         test('app renders with correct fonts', async ({ page }) => {
           await page.goto('/');

           // Check that body uses Inter font
           const bodyFont = await page.evaluate(() => {
             return getComputedStyle(document.body).fontFamily;
           });
           expect(bodyFont).toContain('Inter');
         });
       });
       ```
    4. Update `apps/web/project.json` with complete Nx target suite:
       ```json
       {
         "name": "web",
         "projectType": "application",
         "sourceRoot": "apps/web/src",
         "implicitDependencies": ["ui"],
         "targets": {
           "lint": {
             "executor": "nx:run-commands",
             "options": {
               "command": "npx eslint src/",
               "cwd": "{projectRoot}"
             },
             "inputs": ["{projectRoot}/src/**/*.{ts,tsx}", "{workspaceRoot}/eslint.config.mjs"],
             "outputs": []
           },
           "typecheck": {
             "executor": "nx:run-commands",
             "options": {
               "command": "npx tsc --noEmit -p tsconfig.json",
               "cwd": "{projectRoot}"
             },
             "inputs": [
               "{projectRoot}/src/**/*.{ts,tsx}",
               "{projectRoot}/tsconfig.json",
               "{workspaceRoot}/tsconfig.base.json",
               "{workspaceRoot}/libs/ui/src/**/*.{ts,tsx}"
             ],
             "outputs": []
           },
           "format": {
             "executor": "nx:run-commands",
             "options": {
               "command": "npx prettier --check \"src/**/*.{ts,tsx,css}\"",
               "cwd": "{projectRoot}"
             },
             "inputs": ["{projectRoot}/src/**/*.{ts,tsx,css}", "{workspaceRoot}/.prettierrc"],
             "outputs": []
           },
           "e2e": {
             "executor": "nx:run-commands",
             "options": {
               "command": "npx playwright test --config=playwright.config.ts",
               "cwd": "{projectRoot}"
             },
             "inputs": ["{projectRoot}/e2e/**/*.ts", "{projectRoot}/playwright.config.ts"],
             "outputs": []
           }
         }
       }
       ```
       NOTE: serve, test (vitest), build, and preview targets are inferred by @nx/vite from vite.config.ts. We only need to define lint, typecheck, format, and e2e explicitly. If @nx/vite doesn't infer the test target, add it explicitly:
       ```json
       "test": {
         "executor": "nx:run-commands",
         "options": {
           "command": "npx vitest run",
           "cwd": "{projectRoot}"
         },
         "inputs": ["{projectRoot}/src/**/*.{ts,tsx}", "{workspaceRoot}/libs/ui/src/**/*.{ts,tsx}"],
         "outputs": []
       }
       ```
    5. Verify all Nx targets work:
       - `npx nx test web` -- Vitest tests pass
       - `npx nx lint web` -- ESLint runs on web source
       - `npx nx typecheck web` -- TypeScript strict check passes
       - `npx nx format web` -- Prettier check passes
       - For e2e: start dev server first (`npx nx serve web &`), then `npx nx e2e web`
    6. Verify `npx nx show project web` lists all targets: serve, test, lint, typecheck, format, e2e (and build if inferred)
    7. Fix any ESLint or Prettier errors in existing code to ensure lint and format targets pass clean.
    8. Run `npx nx run-many -t lint typecheck format -p web` to verify all quality gates pass in one command.

    IMPORTANT:
    - Playwright is local-only for now (per CONTEXT.md: "skip CI integration until real UI features exist")
    - The e2e target is defined but NOT added to CI workflow -- that's a future phase concern
    - Developer must start dev server manually before running e2e tests
    - Check `npx nx show project web` to see which targets are inferred vs explicit. If @nx/vite infers serve/test/build, don't duplicate them in project.json.
  </action>
  <verify>
    - `npx nx test web` passes (2 Vitest component tests)
    - `npx nx lint web` passes (ESLint runs without errors)
    - `npx nx typecheck web` passes (TypeScript strict mode)
    - `npx nx format web` passes (Prettier check)
    - `npx nx show project web` shows targets: serve, test, lint, typecheck, format, e2e
    - Playwright: start server, `npx nx e2e web` -- smoke test passes (2 tests)
    - **Visual (Chrome):** Use Claude Code Chrome to open http://localhost:5173 and take a screenshot. Confirm the final state: app shell with sidebar, shadcn components, correct fonts, and no console errors — this is the definitive visual sign-off for Phase 12.
  </verify>
  <done>Complete Nx target suite for web project. Vitest component tests, Playwright smoke test, ESLint lint, TypeScript typecheck, and Prettier format all working.</done>
</task>

</tasks>

<verification>
1. `npx nx test web` -- 2 Vitest tests pass
2. `npx nx lint web` -- ESLint clean
3. `npx nx typecheck web` -- TypeScript strict pass
4. `npx nx format web` -- Prettier clean
5. `npx nx e2e web` -- 2 Playwright smoke tests pass (with dev server running)
6. `npx nx show project web` -- all targets listed
7. `npx nx run-many -t test lint typecheck format -p web` -- all pass together
8. **Visual (Chrome):** Final screenshot of running app — definitive visual sign-off for Phase 12 frontend infrastructure
</verification>

<success_criteria>
- Vitest configured with React Testing Library and jest-dom matchers
- Sample component test passes
- Playwright smoke test verifies app loads without errors
- Full Nx target suite: serve, test, lint, typecheck, format, e2e
- All targets pass clean
- CI-compatible (test, lint, typecheck, format will be picked up by nx affected)
- e2e is local-only (not in CI yet)
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-infrastructure/12-05-SUMMARY.md`
</output>
