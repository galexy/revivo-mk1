---
phase: 12-frontend-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - .npmrc
  - .github/workflows/ci.yml
  - apps/web/package.json
  - apps/web/project.json
  - apps/web/tsconfig.json
  - apps/web/vite.config.ts
  - apps/web/index.html
  - apps/web/src/main.tsx
  - apps/web/src/app/app.tsx
  - apps/web/src/vite-env.d.ts
  - tsconfig.base.json
  - apps/api/src/adapters/api/app.py
autonomous: true

must_haves:
  truths:
    - "pnpm install succeeds and all existing Nx targets still work (npx nx test api, npx nx test domain)"
    - "apps/web renders a React app via npx nx serve web on port 5173"
    - "FastAPI CORS allows requests from http://localhost:5173"
    - "TypeScript strict mode enabled with bundler module resolution"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "pnpm workspace configuration for monorepo"
      contains: "apps/*"
    - path: "tsconfig.base.json"
      provides: "Root TypeScript config with path aliases"
      contains: "@workspace/ui"
    - path: "apps/web/vite.config.ts"
      provides: "Vite configuration for React app"
      contains: "react()"
    - path: "apps/web/src/main.tsx"
      provides: "React entry point"
      contains: "createRoot"
    - path: "apps/web/index.html"
      provides: "HTML entry point"
      contains: "main.tsx"
  key_links:
    - from: "apps/web/index.html"
      to: "apps/web/src/main.tsx"
      via: "script tag"
      pattern: "src/main.tsx"
    - from: "apps/web/src/main.tsx"
      to: "apps/web/src/app/app.tsx"
      via: "import"
      pattern: "import.*App"
    - from: "apps/web/vite.config.ts"
      to: "tsconfig.base.json"
      via: "nxViteTsPaths plugin"
      pattern: "nxViteTsPaths"
---

<objective>
Migrate from npm to pnpm, scaffold the React+Vite application in apps/web/, set up root TypeScript configuration with path aliases, and update FastAPI CORS for the frontend dev server.

Purpose: Establish the package manager and React application foundation that all subsequent plans build upon.
Output: Working pnpm monorepo with a minimal React app that renders on port 5173, root tsconfig.base.json with path aliases, and backend CORS configured for the frontend.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-infrastructure/12-CONTEXT.md
@.planning/phases/12-frontend-infrastructure/12-RESEARCH.md
@apps/api/project.json
@apps/web/package.json
@apps/web/project.json
@libs/ui/package.json
@libs/ui/project.json
@package.json
@nx.json
@.github/workflows/ci.yml
@apps/api/src/adapters/api/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate from npm to pnpm</name>
  <files>
    package.json
    pnpm-workspace.yaml
    .npmrc
    .github/workflows/ci.yml
  </files>
  <action>
    1. Install pnpm globally if not available: `npm install -g pnpm`
    2. Create `pnpm-workspace.yaml` at workspace root:
       ```yaml
       packages:
         - 'apps/*'
         - 'libs/*'
       ```
    3. Run `pnpm import` to convert package-lock.json to pnpm-lock.yaml
    4. Delete package-lock.json: `rm package-lock.json`
    5. Create `.npmrc` with `shamefully-hoist=true` (needed for some packages that assume hoisting)
    6. Run `pnpm install` to verify everything works
    7. Update `.github/workflows/ci.yml`:
       - Change `cache: "npm"` to `cache: "pnpm"` in both jobs
       - Add pnpm install step: `npm install -g pnpm` (or use `pnpm/action-setup@v4`)
       - Change `npm ci` to `pnpm install --frozen-lockfile` in both jobs
       - Add pnpm setup step before Node.js setup using pnpm/action-setup@v4
    8. Verify existing Python Nx targets still work: `npx nx test domain` (quick sanity check -- domain has no npm deps)

    IMPORTANT: The root package.json has devDependencies for mjml and nx. Keep these. Do NOT add a "name" field with @ scope to root package.json -- it's the workspace root.
  </action>
  <verify>
    - `pnpm install` succeeds without errors
    - `pnpm-lock.yaml` exists
    - `package-lock.json` does not exist
    - `npx nx test domain` passes (Python targets unaffected by pnpm migration)
    - `npx nx show projects` lists all 4 projects (api, domain, web, ui)
  </verify>
  <done>pnpm is the package manager. Lock file converted. CI updated. Existing Nx targets unaffected.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold React+Vite app in apps/web/</name>
  <files>
    apps/web/package.json
    apps/web/project.json
    apps/web/tsconfig.json
    apps/web/vite.config.ts
    apps/web/index.html
    apps/web/src/main.tsx
    apps/web/src/app/app.tsx
    apps/web/src/vite-env.d.ts
    tsconfig.base.json
  </files>
  <action>
    1. Create `tsconfig.base.json` at workspace root with path aliases:
       ```json
       {
         "compilerOptions": {
           "target": "ES2022",
           "module": "ESNext",
           "moduleResolution": "bundler",
           "lib": ["ES2022", "DOM", "DOM.Iterable"],
           "jsx": "react-jsx",
           "strict": true,
           "esModuleInterop": true,
           "skipLibCheck": true,
           "forceConsistentCasingInFileNames": true,
           "resolveJsonModule": true,
           "isolatedModules": true,
           "noEmit": true,
           "declaration": true,
           "declarationMap": true,
           "baseUrl": ".",
           "paths": {
             "@workspace/ui": ["libs/ui/src/index.ts"],
             "@workspace/ui/*": ["libs/ui/src/*"],
             "@/*": ["apps/web/src/*"]
           }
         }
       }
       ```
    2. Install React, Vite, and Nx Vite plugin as devDependencies in root or apps/web:
       ```bash
       cd apps/web && pnpm add react react-dom && pnpm add -D @types/react @types/react-dom typescript vite @vitejs/plugin-react @nx/vite
       ```
       Note: Install @nx/vite at workspace root level so Nx can infer targets:
       ```bash
       cd /workspace && pnpm add -D @nx/vite @vitejs/plugin-react
       ```
       And React deps in apps/web:
       ```bash
       cd /workspace/apps/web && pnpm add react react-dom && pnpm add -D @types/react @types/react-dom typescript
       ```
    3. Create `apps/web/tsconfig.json` extending base:
       ```json
       {
         "extends": "../../tsconfig.base.json",
         "compilerOptions": {
           "outDir": "../../dist/out-tsc",
           "types": ["vite/client"]
         },
         "include": ["src/**/*.ts", "src/**/*.tsx", "src/**/*.d.ts"],
         "exclude": ["node_modules", "dist"]
       }
       ```
    4. Create `apps/web/vite.config.ts`:
       ```typescript
       import { defineConfig } from 'vite';
       import react from '@vitejs/plugin-react';
       import { nxViteTsPaths } from '@nx/vite/plugins/nx-tsconfig-paths.plugin';

       export default defineConfig({
         root: __dirname,
         cacheDir: '../../node_modules/.vite/apps/web',
         plugins: [react(), nxViteTsPaths()],
         server: {
           port: 5173,
           host: 'localhost',
         },
         preview: {
           port: 4300,
           host: 'localhost',
         },
         build: {
           outDir: '../../dist/apps/web',
           reportCompressedSize: true,
           commonjsOptions: {
             transformMixedEsModules: true,
           },
         },
         test: {
           globals: true,
           environment: 'jsdom',
           setupFiles: './src/test-setup.ts',
           include: ['src/**/*.{test,spec}.{ts,tsx}'],
           reporters: ['default'],
           coverage: {
             reportsDirectory: '../../coverage/apps/web',
             provider: 'v8',
           },
         },
       });
       ```
    5. Create `apps/web/index.html`:
       ```html
       <!DOCTYPE html>
       <html lang="en">
         <head>
           <meta charset="UTF-8" />
           <meta name="viewport" content="width=device-width, initial-scale=1.0" />
           <title>Personal Finance</title>
         </head>
         <body>
           <div id="root"></div>
           <script type="module" src="/src/main.tsx"></script>
         </body>
       </html>
       ```
    6. Create `apps/web/src/main.tsx`:
       ```typescript
       import { StrictMode } from 'react';
       import { createRoot } from 'react-dom/client';
       import { App } from './app/app';

       const root = document.getElementById('root');
       if (!root) throw new Error('Root element not found');

       createRoot(root).render(
         <StrictMode>
           <App />
         </StrictMode>
       );
       ```
    7. Create `apps/web/src/app/app.tsx`:
       ```typescript
       export function App() {
         return (
           <div>
             <h1>Personal Finance</h1>
             <p>App is running.</p>
           </div>
         );
       }
       ```
    8. Create `apps/web/src/vite-env.d.ts`:
       ```typescript
       /// <reference types="vite/client" />
       ```
    9. Update `apps/web/project.json` to add serve target (Nx may infer some from vite.config.ts, but add explicit serve for clarity):
       ```json
       {
         "name": "web",
         "projectType": "application",
         "sourceRoot": "apps/web/src",
         "implicitDependencies": ["ui"],
         "targets": {}
       }
       ```
       Keep targets empty -- @nx/vite plugin will infer build, serve, preview, test targets from vite.config.ts. We'll add explicit targets for lint/typecheck/format in plan 12-04.
    10. Update `apps/web/package.json` to add name with scope for pnpm workspace:
       ```json
       {
         "name": "@workspace/web",
         "version": "0.0.0",
         "private": true
       }
       ```
    11. Verify: `npx nx serve web` starts dev server on port 5173

    IMPORTANT: Check if @nx/vite is available. If Nx inferred targets don't appear, we may need to register the plugin in nx.json plugins array. Run `npx nx show project web` to verify inferred targets.
  </action>
  <verify>
    - `npx nx show project web` shows inferred targets (serve, build, test, preview)
    - `npx nx serve web` starts Vite dev server on port 5173
    - Visiting http://localhost:5173 shows "Personal Finance" heading
    - TypeScript compiles without errors: `npx tsc --noEmit -p apps/web/tsconfig.json`
  </verify>
  <done>React+Vite app scaffolded with TypeScript strict mode. Dev server runs on port 5173. Root tsconfig.base.json has path aliases for @workspace/ui and @/.</done>
</task>

<task type="auto">
  <name>Task 3: Update FastAPI CORS for Vite dev server</name>
  <files>
    apps/api/src/adapters/api/app.py
  </files>
  <action>
    In `apps/api/src/adapters/api/app.py`, update the CORS middleware `allow_origins` from `["http://localhost:3000"]` to include the Vite dev server port:
    ```python
    app.add_middleware(
        CORSMiddleware,
        allow_origins=[
            "http://localhost:5173",  # Vite dev server
            "http://localhost:3000",  # Legacy/alternative
        ],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    ```
    Also update the comment from "React dev server" to "Vite dev server".

    Run typecheck and test to verify no regressions:
    - `npx nx typecheck api`
    - `npx nx test api` (if quick enough; at minimum typecheck)
  </action>
  <verify>
    - `npx nx typecheck api` passes
    - CORS middleware includes http://localhost:5173 in allow_origins
  </verify>
  <done>FastAPI backend allows CORS from Vite dev server on port 5173.</done>
</task>

</tasks>

<verification>
1. `pnpm install` succeeds (no package-lock.json, pnpm-lock.yaml exists)
2. `npx nx show projects` lists api, domain, web, ui
3. `npx nx serve web` starts React app on port 5173
4. `npx nx test domain` passes (Python targets unaffected)
5. `npx nx typecheck api` passes (CORS update clean)
6. tsconfig.base.json exists with @workspace/ui and @/ path aliases
</verification>

<success_criteria>
- pnpm is the package manager with workspace config
- React+Vite app renders on port 5173
- TypeScript strict mode enabled
- Path aliases configured for cross-project imports
- FastAPI CORS updated for Vite dev server
- CI workflow updated for pnpm
- All existing Python tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-infrastructure/12-01-SUMMARY.md`
</output>
