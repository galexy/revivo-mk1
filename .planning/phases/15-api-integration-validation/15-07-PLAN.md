---
phase: 15-api-integration-validation
plan: 07
type: execute
wave: 4
depends_on: ["15-04", "15-05"]
files_modified:
  - apps/web/e2e/accounts.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test creates an account via the wizard and verifies it appears in the sidebar"
    - "E2E test edits an account via the wizard and verifies the change in the sidebar"
    - "E2E test deletes an account via type-to-confirm dialog and verifies removal"
    - "E2E tests use authenticated session from auth.setup.ts fixture"
  artifacts:
    - path: "apps/web/e2e/accounts.spec.ts"
      provides: "Playwright E2E tests for account CRUD"
      min_lines: 60
  key_links:
    - from: "apps/web/e2e/accounts.spec.ts"
      to: "apps/web/e2e/auth.setup.ts"
      via: "storageState for authenticated session"
      pattern: "storageState.*user\\.json"
---

<objective>
Write Playwright E2E tests that exercise the full account CRUD flow against a running backend.

Purpose: E2E tests catch integration bugs that unit tests miss -- wizard state management, API timing, cache invalidation, routing. These tests run against real API + real database.
Output: Playwright spec covering create, edit, and delete account flows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/15-api-integration-validation/15-CONTEXT.md
@apps/web/e2e/auth.setup.ts
@apps/web/e2e/smoke.spec.ts
@apps/web/playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Playwright E2E tests for account CRUD</name>
  <files>
    apps/web/e2e/accounts.spec.ts
  </files>
  <action>
    Create `apps/web/e2e/accounts.spec.ts` using the authenticated session from auth.setup.ts.

    The tests require both `npx nx serve api` and `npx nx serve web` running. The Playwright config should already handle the web server startup. The API server needs to be running with a real database.

    Test structure:
    ```typescript
    import { test, expect } from '@playwright/test';

    // Use authenticated storage state
    test.use({ storageState: 'e2e/.auth/user.json' });

    test.describe('Account CRUD', () => {
      test('creates a checking account via wizard', async ({ page }) => {
        await page.goto('/dashboard');

        // If no accounts exist, click "Add Your First Account" from empty state
        // Otherwise, click the "Add Account" button in sidebar
        const addButton = page.getByRole('button', { name: /add.*account/i });
        await addButton.click();

        // Step 1: Select account type
        await expect(page.getByText('Choose Account Type')).toBeVisible();
        await page.getByText('Checking').click();
        await page.getByRole('button', { name: /next|continue/i }).click();

        // Step 2: Enter details
        await expect(page.getByText('Account Details')).toBeVisible();
        const uniqueName = `E2E Checking ${Date.now()}`;
        await page.getByLabel(/name/i).fill(uniqueName);
        await page.getByRole('button', { name: /next|continue/i }).click();

        // Step 3: Opening balance
        await expect(page.getByText('Opening Balance')).toBeVisible();
        // Fill balance (handle currency input)
        const balanceInput = page.getByRole('textbox').or(page.locator('input[type="text"]')).first();
        await balanceInput.fill('1500.00');
        await page.getByRole('button', { name: /next|continue/i }).click();

        // Step 4: Review and create
        await expect(page.getByText('Review')).toBeVisible();
        await expect(page.getByText(uniqueName)).toBeVisible();
        await page.getByRole('button', { name: /create account/i }).click();

        // Verify: account appears in sidebar
        await expect(page.getByText(uniqueName)).toBeVisible({ timeout: 10000 });
      });

      test('edits an account via wizard', async ({ page }) => {
        // First create an account to edit
        await page.goto('/dashboard');

        // Create account via API for test setup (faster)
        const createResponse = await page.request.post('http://localhost:8000/api/v1/accounts/checking', {
          data: {
            name: `Edit Test ${Date.now()}`,
            opening_balance: { amount: '500.00', currency: 'USD' },
          },
        });
        expect(createResponse.ok()).toBeTruthy();
        const account = await createResponse.json();

        // Reload to see the new account
        await page.reload();
        await expect(page.getByText(account.name)).toBeVisible({ timeout: 10000 });

        // Right-click or open context menu on the account
        // Try ... button first, then right-click
        const accountItem = page.getByText(account.name);
        await accountItem.hover();
        const moreButton = page.getByRole('button', { name: /more|options/i }).first();
        await moreButton.click();

        // Click Edit
        await page.getByRole('menuitem', { name: /edit/i }).click();

        // Wizard opens in edit mode (should start at step 2, type locked)
        const newName = `Edited ${Date.now()}`;
        const nameInput = page.getByLabel(/name/i);
        await nameInput.clear();
        await nameInput.fill(newName);

        // Navigate through remaining steps and save
        await page.getByRole('button', { name: /next|continue/i }).click();
        // Step 3 - balance (keep existing)
        await page.getByRole('button', { name: /next|continue/i }).click();
        // Step 4 - review
        await page.getByRole('button', { name: /save changes/i }).click();

        // Verify: updated name in sidebar
        await expect(page.getByText(newName)).toBeVisible({ timeout: 10000 });
      });

      test('deletes an account via type-to-confirm', async ({ page }) => {
        // Create account via API for test setup
        const accountName = `Delete Test ${Date.now()}`;
        await page.request.post('http://localhost:8000/api/v1/accounts/savings', {
          data: {
            name: accountName,
            opening_balance: { amount: '100.00', currency: 'USD' },
          },
        });

        await page.goto('/dashboard');
        await expect(page.getByText(accountName)).toBeVisible({ timeout: 10000 });

        // Open context menu
        const accountItem = page.getByText(accountName);
        await accountItem.hover();
        const moreButton = page.getByRole('button', { name: /more|options/i }).first();
        await moreButton.click();

        // Click Delete
        await page.getByRole('menuitem', { name: /delete/i }).click();

        // Type-to-confirm dialog
        await expect(page.getByText('Delete Account')).toBeVisible();
        await page.getByPlaceholder(new RegExp(accountName)).fill(accountName);
        await page.getByRole('button', { name: /delete account/i }).click();

        // Verify: account removed from sidebar
        await expect(page.getByText(accountName)).not.toBeVisible({ timeout: 10000 });
      });
    });
    ```

    IMPORTANT NOTES:
    - Tests should be resilient to timing (use `toBeVisible({ timeout: 10000 })` for API operations)
    - Tests create accounts with unique names (Date.now()) to avoid conflicts between runs
    - The auth setup creates a fresh user per run, so the account list starts empty
    - API requests in tests use the same auth cookies from storageState
    - Adapt selectors to actual component implementation (role, text, label patterns)
    - If wizard or sidebar implementations use different text/roles than assumed, adjust accordingly

    Before running, verify both servers are available:
    - API: `curl http://localhost:8000/health`
    - Web: `curl http://localhost:5173`

    Run: `npx nx e2e web`
  </action>
  <verify>
    `npx nx e2e web` passes (all 3 account CRUD tests + existing smoke test).
    Tests create, edit, and delete accounts successfully against real backend.
  </verify>
  <done>
    Playwright E2E tests cover the full account CRUD flow:
    1. Create checking account via 4-step wizard
    2. Edit account name via wizard (edit mode)
    3. Delete account via type-to-confirm dialog
    All tests use authenticated session and run against real API.
  </done>
</task>

</tasks>

<verification>
- `npx nx e2e web` passes
- All 3 account CRUD E2E tests pass
- Existing smoke test still passes
- Tests run against real backend (not mocked)
</verification>

<success_criteria>
E2E tests prove the full frontend-backend integration works for account CRUD.
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-07-SUMMARY.md`
</output>
