---
phase: 15-api-integration-validation
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/styles/globals.css
  - apps/web/src/features/accounts/validation/accountSchemas.ts
  - apps/web/src/features/accounts/hooks/useCreateAccount.ts
  - apps/web/src/features/accounts/hooks/useAccountWizard.ts
  - apps/web/src/features/accounts/components/AccountWizard.tsx
  - apps/web/src/features/accounts/hooks/__tests__/useCreateAccount.test.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All shadcn/ui semantic color utilities (bg-background, text-foreground, bg-card, etc.) compile to actual CSS in Tailwind v4 output"
    - "Dialog/modal content has an opaque white (light) or dark (dark mode) background, not transparent"
    - "Loan account creation succeeds when user enters APR as percentage (e.g. 6.5 for 6.5%)"
    - "Edit wizard for loan accounts shows APR as percentage (e.g. 5.99) not decimal (e.g. 0.0599)"
  artifacts:
    - path: "apps/web/src/styles/globals.css"
      provides: "Tailwind v4 @theme color registrations"
      contains: "--color-background"
    - path: "apps/web/src/features/accounts/hooks/useCreateAccount.ts"
      provides: "APR percentage-to-decimal conversion before API call"
      contains: "/ 100"
  key_links:
    - from: "apps/web/src/styles/globals.css"
      to: "libs/ui/src/lib/dialog.tsx"
      via: "@theme --color-background maps to bg-background utility"
      pattern: "--color-background.*var\\(--background\\)"
    - from: "apps/web/src/features/accounts/hooks/useCreateAccount.ts"
      to: "API POST /api/v1/accounts/loan"
      via: "APR converted from percentage to decimal before API call"
      pattern: "parseFloat.*apr.*/ 100"
---

<objective>
Fix two UAT gaps from Phase 15: (1) Tailwind v4 @theme missing color registrations causing all shadcn/ui components to have transparent backgrounds, and (2) APR percentage/decimal mismatch preventing loan account creation.

Purpose: Both gaps were discovered during UAT. The CSS fix affects ALL shadcn/ui components (not just Dialog). The APR fix unblocks loan account creation entirely.
Output: Working shadcn/ui theming and functional loan account creation/editing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/debug/dialog-overlay-bleed.md
@.planning/debug/apr-mismatch-loan.md
@.planning/phases/15-api-integration-validation/15-UAT.md

Key existing files:
@apps/web/src/styles/globals.css
@apps/web/src/features/accounts/hooks/useCreateAccount.ts
@apps/web/src/features/accounts/validation/accountSchemas.ts
@apps/web/src/features/accounts/hooks/useAccountWizard.ts
@apps/web/src/features/accounts/components/AccountWizard.tsx
@apps/web/src/features/accounts/hooks/__tests__/useCreateAccount.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Tailwind v4 @theme color registrations in globals.css</name>
  <files>apps/web/src/styles/globals.css</files>
  <action>
The @theme block in globals.css currently only registers font variables (--font-sans, --font-mono). Tailwind v4 requires color variables to be registered via the @theme block using the --color-<name> namespace for utility class generation.

The :root block defines HSL component values (e.g., `--background: 0 0% 100%`) without the hsl() wrapper. The body selector manually wraps them (`hsl(var(--background))`). This is the Tailwind v3 / old shadcn pattern. For Tailwind v4, the @theme block needs to map --color-* variables to the CSS custom properties.

Update globals.css:

1. **Wrap :root color variable values in hsl()** so they are complete color values:
   ```css
   :root {
     --background: hsl(0 0% 100%);
     --foreground: hsl(222.2 84% 4.9%);
     /* ... etc for ALL color variables */
   }
   ```
   Do the same for the `.dark` block.

2. **Add @theme inline block** that maps --color-* to the CSS variables. The `inline` keyword tells Tailwind to use the variables for utility class generation without duplicating them as separate CSS custom properties:
   ```css
   @theme inline {
     --color-background: var(--background);
     --color-foreground: var(--foreground);
     --color-card: var(--card);
     --color-card-foreground: var(--card-foreground);
     --color-popover: var(--popover);
     --color-popover-foreground: var(--popover-foreground);
     --color-primary: var(--primary);
     --color-primary-foreground: var(--primary-foreground);
     --color-secondary: var(--secondary);
     --color-secondary-foreground: var(--secondary-foreground);
     --color-muted: var(--muted);
     --color-muted-foreground: var(--muted-foreground);
     --color-accent: var(--accent);
     --color-accent-foreground: var(--accent-foreground);
     --color-destructive: var(--destructive);
     --color-destructive-foreground: var(--destructive-foreground);
     --color-success: var(--success);
     --color-success-foreground: var(--success-foreground);
     --color-warning: var(--warning);
     --color-warning-foreground: var(--warning-foreground);
     --color-border: var(--border);
     --color-input: var(--input);
     --color-ring: var(--ring);
     --radius: var(--radius);
     --color-sidebar: var(--sidebar);
     --color-sidebar-foreground: var(--sidebar-foreground);
     --color-sidebar-accent: var(--sidebar-accent);
     --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
     --color-sidebar-border: var(--sidebar-border);
     --color-sidebar-ring: var(--sidebar-ring);
   }
   ```
   Note: Only include sidebar color mappings if sidebar CSS variables exist in :root. If they don't exist in :root, skip them.

3. **Update body and base styles** to use the new complete color values:
   ```css
   body {
     background-color: var(--background);
     color: var(--foreground);
     font-family: var(--font-sans);
   }
   ```
   Update the `*` border-color and `.amount-negative` similarly to use `var(--border)` and `var(--destructive)` directly (since the variables now contain complete hsl() values).

4. **Keep the existing @theme block** with font variables. The new @theme inline block is separate.

IMPORTANT: The :root variables MUST use hsl() wrapper because Tailwind v4 @theme inline with var() references needs complete color values, not bare HSL components. Without the hsl() wrapper, var(--background) resolves to "0 0% 100%" which is not a valid CSS color value.

After this change, ALL shadcn/ui utility classes (bg-background, text-foreground, bg-card, text-muted-foreground, border-border, ring-ring, etc.) will compile into the CSS output and render correctly across all 31+ files using them.
  </action>
  <verify>
Run `npx nx build web` and inspect the compiled CSS output. Verify that `.bg-background`, `.text-foreground`, `.bg-card`, `.bg-popover` classes all exist in the output CSS. Previously they were completely missing. Also run `npx nx typecheck web` and `npx nx test web` to confirm no regressions.
  </verify>
  <done>
Built CSS contains bg-background, text-foreground, bg-card, bg-popover, text-muted-foreground, and all other shadcn/ui semantic color utility classes. Dialog content is no longer transparent. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix APR percentage/decimal conversion for loan accounts</name>
  <files>
    apps/web/src/features/accounts/validation/accountSchemas.ts
    apps/web/src/features/accounts/hooks/useCreateAccount.ts
    apps/web/src/features/accounts/hooks/useAccountWizard.ts
    apps/web/src/features/accounts/components/AccountWizard.tsx
    apps/web/src/features/accounts/hooks/__tests__/useCreateAccount.test.tsx
  </files>
  <action>
The UI collects APR as a percentage (label says "APR (%)", placeholder "3.5") but sends it to the API without dividing by 100. The API validates `apr <= 1` expecting a decimal fraction (0.065 for 6.5%). Three changes needed:

**1. Add APR range validation in accountSchemas.ts:**

Update the `apr` field in `stepDetailsSchema` to validate the numeric range 0-100:
```ts
apr: z.string().optional().refine(
  (val) => {
    if (!val) return true; // optional
    const num = parseFloat(val);
    return !isNaN(num) && num >= 0 && num <= 100;
  },
  { message: 'APR must be between 0 and 100' }
),
```

**2. Convert percentage to decimal in useCreateAccount.ts:**

In the `loan` case (around line 67), divide APR by 100 before sending to API:
```ts
case 'loan': {
  const aprDecimal = formData.apr
    ? (parseFloat(formData.apr) / 100).toString()
    : '0';
  const data: CreateLoanAccountRequest = {
    name,
    opening_balance: commonData.opening_balance,
    apr: aprDecimal,
    term_months: parseInt(formData.termMonths || '0', 10),
    subtype: formData.subtype as 'mortgage' | 'auto_loan' | 'personal_loan' | 'line_of_credit',
  };
  return createLoanAccount(data);
}
```

**3. Convert API decimal back to percentage in edit mode:**

In `useAccountWizard.ts`, the `mapAccountToFormData` function (line 46-48) currently copies `account.apr` directly. Since the API returns a decimal (e.g., "0.0599"), multiply by 100 for the form:
```ts
if (account.apr) {
  formData.apr = (parseFloat(account.apr) * 100).toString();
}
```

Do the same in `AccountWizard.tsx` (line 79-81) where `editAccount.apr` is copied:
```ts
if (editAccount.apr) {
  editData.apr = (parseFloat(editAccount.apr) * 100).toString();
}
```

**4. Update the existing test in useCreateAccount.test.tsx:**

The loan test case currently sends `apr: '0.0599'` as form input and expects `apr: '0.0599'` in the API call. After the fix, form input represents a percentage. Update:
- Form input: `apr: '5.99'` (user enters percentage)
- Expected API call: `apr: '0.0599'` (hook converts to decimal)

Update the test at lines 149-171:
```ts
const formData: AccountFormData = {
  accountType: 'loan',
  name: 'Auto Loan',
  openingBalance: '25000.00',
  apr: '5.99',        // User enters percentage
  termMonths: '60',
  subtype: 'auto_loan',
};
// ...
expect(createLoanSpy).toHaveBeenCalledWith({
  name: 'Auto Loan',
  opening_balance: { amount: '25000.00', currency: 'USD' },
  apr: '0.0599',      // Hook converts to decimal for API
  term_months: 60,
  subtype: 'auto_loan',
});
```

**Why NOT change the API:** The API correctly stores APR as a decimal fraction (0.065 for 6.5%), which is the standard domain representation. The frontend is responsible for the percentage/decimal UX conversion.
  </action>
  <verify>
Run `npx nx typecheck web && npx nx test web`. The loan test should pass with the new percentage input (5.99) being converted to decimal output (0.0599). Verify no other tests broke.
  </verify>
  <done>
Loan account creation works: user enters 5.99 in APR field, hook converts to 0.0599 before API call (passes le=1 validation). Edit mode converts API's 0.0599 back to 5.99 for display. Zod schema validates 0-100 range on input. All tests pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `npx nx typecheck web` -- zero errors
2. `npx nx test web` -- all tests pass (88+ existing, updated loan test)
3. `npx nx build web` -- build succeeds, compiled CSS contains bg-background and other semantic color classes
4. Visual verification: start `npx nx serve web` and `npx nx serve api`, open account wizard -- dialog has opaque white background (not transparent), content is clearly readable
5. Functional verification: create a loan account with APR 6.5 -- should succeed (previously returned 422)
</verification>

<success_criteria>
1. Compiled CSS output contains bg-background, text-foreground, bg-card, bg-popover, text-muted-foreground (previously all missing)
2. Dialog/modal has opaque background (not transparent overlay bleed-through)
3. Loan creation with percentage APR (e.g., 6.5) succeeds (API receives 0.065)
4. Edit loan shows APR as percentage (e.g., 5.99) not decimal (e.g., 0.0599)
5. APR input validated to 0-100 range in Zod schema
6. All existing tests pass, updated loan test verifies percentage-to-decimal conversion
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-09-SUMMARY.md`
</output>
