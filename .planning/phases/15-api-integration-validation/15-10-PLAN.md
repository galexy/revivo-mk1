---
phase: 15-api-integration-validation
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/features/accounts/components/AccountWizardSteps/StepTypeSelection.tsx
  - apps/web/src/features/accounts/components/AccountWizardSteps/StepDetails.tsx
  - apps/web/src/features/accounts/components/AccountWizardSteps/StepReview.tsx
  - apps/web/src/features/accounts/components/AccountWizard.tsx
  - apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking an account type in the wizard auto-advances to step 2 (no separate Next click needed)"
    - "Selected account type card has visible border color change (primary color border)"
    - "Pressing Enter in the Account Name input on step 2 advances to step 3"
    - "Edit mode skips step 0 (type selection) and starts at step 1 (details)"
    - "Edit mode review step shows 'Update Account' button (not 'Create Account')"
    - "Edit mode balance field shows 2 decimal places (not 4)"
  artifacts:
    - path: "apps/web/src/features/accounts/components/AccountWizardSteps/StepTypeSelection.tsx"
      provides: "Auto-advance on type selection"
    - path: "apps/web/src/features/accounts/components/AccountWizardSteps/StepDetails.tsx"
      provides: "Enter key advances from name field"
    - path: "apps/web/src/features/accounts/components/AccountWizardSteps/StepReview.tsx"
      provides: "Edit-mode-aware button label and description text"
    - path: "apps/web/src/features/accounts/components/AccountWizard.tsx"
      provides: "Edit mode starts at step 1, passes isEditMode to StepReview"
  key_links:
    - from: "StepTypeSelection.tsx"
      to: "AccountWizard.tsx"
      via: "onNext callback triggered by onValueChange"
      pattern: "onValueChange.*onNext"
    - from: "AccountWizard.tsx"
      to: "StepReview.tsx"
      via: "isEditMode prop"
      pattern: "isEditMode"
---

<objective>
Fix two minor UAT issues from Phase 15 acceptance testing:

1. **Wizard Type Selection UX** (UAT Test 2): Auto-advance when selecting account type (remove need for separate Next click), ensure visual feedback on selected type, and support Enter key to advance from step 2 name field.

2. **Edit Wizard Issues** (UAT Test 6): Skip type selection step in edit mode, show "Update Account" instead of "Create Account" on review step, and format balance to 2 decimal places in edit mode.

Purpose: Polish the account wizard UX based on real user feedback from UAT testing.
Output: Updated wizard components with improved UX and correct edit mode behavior.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/features/accounts/components/AccountWizard.tsx
@apps/web/src/features/accounts/components/AccountWizardSteps/StepTypeSelection.tsx
@apps/web/src/features/accounts/components/AccountWizardSteps/StepDetails.tsx
@apps/web/src/features/accounts/components/AccountWizardSteps/StepOpeningBalance.tsx
@apps/web/src/features/accounts/components/AccountWizardSteps/StepReview.tsx
@apps/web/src/features/accounts/hooks/useAccountWizard.ts
@apps/web/src/features/accounts/validation/accountSchemas.ts
@apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wizard type selection auto-advance and Enter key navigation</name>
  <files>
    apps/web/src/features/accounts/components/AccountWizardSteps/StepTypeSelection.tsx
    apps/web/src/features/accounts/components/AccountWizardSteps/StepDetails.tsx
  </files>
  <action>
    **StepTypeSelection.tsx changes:**

    1. When user clicks an account type radio card, auto-advance to the next step immediately. In the RadioGroup `onValueChange` handler, after calling `form.setValue('accountType', value)`, also call `onNext()`. This eliminates the need for a separate "Next" button click on step 1.

    2. Remove the "Next" button from the bottom of StepTypeSelection since it's no longer needed (auto-advance handles it). Keep the overall layout clean.

    3. The visual feedback for selected type should already work via the existing CSS class `peer-data-[state=checked]:border-primary`. Verify this still works after the auto-advance change. If the advance happens too fast for the visual feedback to register, add a small delay (150-200ms via setTimeout) before calling onNext() so the user sees the border color change momentarily before advancing.

    **StepDetails.tsx changes:**

    4. Add `onKeyDown` handler to the Account Name `<Input>` element. When the user presses Enter, prevent default form submission and call `onNext()` to advance to step 3. Only trigger if Enter is pressed (not Shift+Enter or other combos). The handler should be:
    ```
    onKeyDown={(e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        onNext();
      }
    }}
    ```
    Add this to the name Input element alongside the existing `{...register('name')}` spread. The register spread returns onBlur/onChange/ref/name, so onKeyDown won't conflict.
  </action>
  <verify>
    Run `npx nx typecheck web` to ensure no type errors.
    Run `npx nx test web` to ensure existing tests pass (some may need minor updates since the Next button is removed from step 1).
  </verify>
  <done>
    - Clicking account type auto-advances to step 2 (no Next button on step 1)
    - Brief visual feedback (border color) visible before auto-advance
    - Enter key in Account Name field on step 2 advances to step 3
    - All existing tests pass (updated as needed for removed Next button)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix edit mode (skip step 0, button label, balance decimals)</name>
  <files>
    apps/web/src/features/accounts/components/AccountWizard.tsx
    apps/web/src/features/accounts/components/AccountWizardSteps/StepReview.tsx
    apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx
  </files>
  <action>
    **AccountWizard.tsx changes:**

    1. **Skip step 0 in edit mode:** When `editAccount` is provided, initialize `currentStep` to 1 (not 0). Change the useState initializer:
    ```
    const [currentStep, setCurrentStep] = useState(editAccount ? 1 : 0);
    ```

    2. **Prevent back-navigation past step 1 in edit mode:** In `goToPreviousStep`, change the minimum step:
    ```
    const goToPreviousStep = () => {
      const currentValues = form.getValues();
      setFormData({ ...formData, ...currentValues });
      setCurrentStep((prev) => Math.max(prev - 1, editAccount ? 1 : 0));
    };
    ```

    3. **Reset to correct step on dialog close:** In the reset useEffect, set currentStep to 0 (create mode always resets to 0, and editAccount will re-trigger the edit initialization):
    ```
    useEffect(() => {
      if (!open) {
        setCurrentStep(editAccount ? 1 : 0);
        // ... rest of reset
      }
    }, [open, form, editAccount]);
    ```

    4. **Format balance for edit mode:** When populating edit data, format the openingBalance to 2 decimal places. In the edit account useEffect, change:
    ```
    openingBalance: editAccount.current_balance.amount,
    ```
    to:
    ```
    openingBalance: parseFloat(editAccount.current_balance.amount).toFixed(2),
    ```
    This ensures the CurrencyInput displays "$1,500.00" not "$1,500.0000".

    5. **Pass isEditMode to StepReview:** Add `isEditMode` prop when rendering StepReview:
    ```
    <StepReview
      formData={formData}
      onSubmit={handleSubmit}
      onBack={goToPreviousStep}
      isSubmitting={isSubmitting}
      isEditMode={!!editAccount}
    />
    ```

    6. **Update ProgressDots in edit mode:** Pass `totalSteps={editAccount ? 3 : 4}` to ProgressDots. Also adjust the currentStep for ProgressDots in edit mode so dot 0 maps to step 1: `currentStep={editAccount ? currentStep - 1 : currentStep}`.

    **StepReview.tsx changes:**

    7. Add `isEditMode` to the StepReviewProps interface (optional boolean, default false).

    8. Change the submit button text to be mode-aware:
    ```
    {isSubmitting
      ? (isEditMode ? 'Saving...' : 'Creating...')
      : (isEditMode ? 'Update Account' : 'Create Account')}
    ```

    9. Change the review step description to be mode-aware:
    ```
    <p className="text-sm text-muted-foreground">
      {isEditMode
        ? 'Please review the changes before saving'
        : 'Please review the details before creating your account'}
    </p>
    ```

    **AccountWizard.test.tsx changes:**

    10. Update test "selecting type and clicking Next advances to step 2": Since step 1 now auto-advances, remove the explicit Next button click. Instead, clicking the radio label should auto-advance. The test should click the account type and then directly wait for the step 2 elements to appear.

    11. Update test "Next button is disabled until account type is selected": This test needs to change since there's no Next button on step 1 anymore. Replace with a test that verifies clicking an account type auto-advances to step 2.

    12. Update test "step 2 shows name input and Back/Next buttons": The setup for this test clicks Next on step 1 - change it to just click the account type (which auto-advances).

    13. Update other tests that navigate past step 1 by clicking Next on step 1 - change them to just click the account type radio.

    14. Add a new test for edit mode: render AccountWizard with `editAccount` prop, verify it starts at step 2 (Account Details), does NOT show type selection step, and the review step shows "Update Account" button.
  </action>
  <verify>
    Run `npx nx typecheck web` to ensure no type errors.
    Run `npx nx test web` to ensure all tests pass.
  </verify>
  <done>
    - Edit mode starts at step 1 (details), not step 0 (type selection)
    - Edit mode shows "Update Account" button on review step (not "Create Account")
    - Edit mode shows "Saving..." during submission (not "Creating...")
    - Edit mode balance shows 2 decimal places (e.g., $1,500.00)
    - Edit mode ProgressDots shows 3 steps (not 4)
    - All tests pass including new edit mode test
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck web` -- zero type errors
2. `npx nx test web` -- all tests pass
3. Visual verification: Start `npx nx serve web` and test with Chrome DevTools:
   - Open wizard, click account type -> should auto-advance to step 2
   - On step 2, type account name, press Enter -> should advance to step 3
   - Complete creation flow
   - Edit an account -> should start at step 2, show "Update Account" on review step
   - Balance in edit mode should show 2 decimal places
</verification>

<success_criteria>
- UAT Test 2 issues resolved: auto-advance on type selection, Enter key navigation on step 2
- UAT Test 6 issues resolved: edit skips step 1, correct button label, 2-decimal balance
- All existing Vitest tests updated and passing
- New edit mode test added and passing
- Zero typecheck errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-10-SUMMARY.md`
</output>
