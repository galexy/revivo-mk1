---
phase: 15-api-integration-validation
plan: 06
type: execute
wave: 4
depends_on: ["15-04", "15-05"]
files_modified:
  - apps/web/src/features/accounts/components/__tests__/AccountSidebar.test.tsx
  - apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx
  - apps/web/src/features/accounts/components/__tests__/DeleteAccountDialog.test.tsx
  - apps/web/src/features/accounts/hooks/__tests__/useCreateAccount.test.ts
  - apps/web/src/features/accounts/utils.test.ts
  - apps/web/src/mocks/handlers.ts
autonomous: true

must_haves:
  truths:
    - "Vitest tests verify account grouping utility maps all 7 types correctly"
    - "Vitest tests verify wizard renders all 4 steps and validates per-step"
    - "Vitest tests verify delete dialog enables button only when name matches"
    - "Vitest tests verify sidebar renders grouped accounts with subtotals"
    - "Vitest tests verify create mutation calls correct API endpoint per account type"
  artifacts:
    - path: "apps/web/src/features/accounts/utils.test.ts"
      provides: "Tests for groupAccounts and formatCurrency"
      min_lines: 30
    - path: "apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx"
      provides: "Tests for wizard step navigation and validation"
      min_lines: 40
    - path: "apps/web/src/features/accounts/components/__tests__/DeleteAccountDialog.test.tsx"
      provides: "Tests for type-to-confirm pattern"
      min_lines: 20
  key_links:
    - from: "apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx"
      to: "apps/web/src/mocks/handlers.ts"
      via: "MSW server for API mocking"
      pattern: "server\\.use|setupServer"
---

<objective>
Write Vitest unit and component tests for account features: grouping utility, wizard, delete dialog, sidebar, and mutation hooks.

Purpose: Automated regression tests catch bugs that E2E tests are too slow to cover comprehensively (edge cases, validation rules, error states).
Output: Comprehensive Vitest test suite covering account feature logic and component behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/15-api-integration-validation/15-04-SUMMARY.md
@.planning/phases/15-api-integration-validation/15-05-SUMMARY.md
@apps/web/src/mocks/handlers.ts
@apps/web/src/mocks/fixtures.ts
@apps/web/src/mocks/server.ts
@apps/web/src/test-setup.ts
@apps/web/src/features/accounts/utils.ts
@apps/web/src/features/accounts/components/AccountSidebar.tsx
@apps/web/src/features/accounts/components/AccountWizard.tsx
@apps/web/src/features/accounts/components/DeleteAccountDialog.tsx
@apps/web/src/features/accounts/hooks/useCreateAccount.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for grouping utility and format functions</name>
  <files>
    apps/web/src/features/accounts/utils.test.ts
  </files>
  <action>
    Create `apps/web/src/features/accounts/utils.test.ts` with Vitest:

    1. Test `groupAccounts()`:
       - Groups checking + savings under "Cash"
       - Groups credit_card under "Credit"
       - Groups loan under "Loans"
       - Groups brokerage + ira under "Investments"
       - Groups rewards under "Rewards"
       - Empty input returns empty groups (filtered)
       - Accounts with mixed types all categorized correctly
       - Subtotal calculation is correct (sum of current_balance.amount)
       - Groups with zero accounts are filtered out

    2. Test `formatCurrency()`:
       - Positive amounts: "1234.56" -> "$1,234.56"
       - Zero: "0" or "0.00" -> "$0.00"
       - Negative amounts: "-542.30" -> "-$542.30"
       - Large amounts: "1000000" -> "$1,000,000.00"
       - Decimal precision: "10.1" -> "$10.10"

    Use mock fixtures from src/mocks/fixtures.ts for AccountResponse data.

    Verify: `npx nx test web -- --run src/features/accounts/utils.test.ts`
  </action>
  <verify>`npx nx test web -- --run src/features/accounts/utils.test.ts` passes.</verify>
  <done>
    groupAccounts utility tested with all 7 account types and edge cases.
    formatCurrency tested with positive, negative, zero, and large amounts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Component tests for wizard, delete dialog, and sidebar</name>
  <files>
    apps/web/src/features/accounts/components/__tests__/AccountWizard.test.tsx
    apps/web/src/features/accounts/components/__tests__/DeleteAccountDialog.test.tsx
    apps/web/src/features/accounts/components/__tests__/AccountSidebar.test.tsx
    apps/web/src/features/accounts/hooks/__tests__/useCreateAccount.test.ts
    apps/web/src/mocks/handlers.ts
  </files>
  <action>
    Use @testing-library/react + @testing-library/user-event + MSW for component tests. Wrap components that use TanStack Query in a test QueryClientProvider (create a test wrapper utility if one doesn't exist).

    1. Create `AccountWizard.test.tsx`:
       - Test: wizard renders step 1 (type selection) when opened
       - Test: selecting account type and clicking Next advances to step 2
       - Test: step 2 shows name input
       - Test: step 2 shows credit limit field only for credit_card type
       - Test: step 2 shows IRA subtype selector only for ira type
       - Test: Back button returns to previous step
       - Test: form validates name is required before advancing from step 2
       - Test: step 4 (review) shows all entered data
       - Test: closing and reopening dialog resets to step 1 (stale state bug prevention)
       - Test: edit mode starts at step 2 with pre-filled data and locked type
       - Wrap in QueryClientProvider since wizard may use mutation hooks

    2. Create `DeleteAccountDialog.test.tsx`:
       - Test: Delete button disabled initially
       - Test: Typing wrong text keeps button disabled
       - Test: Typing exact account name enables Delete button
       - Test: Clicking Delete calls onConfirmDelete with correct ID
       - Test: Closing dialog clears typed text

    3. Create `AccountSidebar.test.tsx`:
       - Test: renders grouped accounts with correct headers
       - Test: shows subtotal for each group
       - Test: "Add Account" button calls onAddAccount
       - Test: clicking account calls onSelectAccount with correct ID
       - Test: context menu shows Edit and Delete options
       - Test: empty accounts array renders nothing (or minimal state)

    4. Create `useCreateAccount.test.ts` (hook test):
       - Test: calling mutateAsync for 'checking' type hits /api/v1/accounts/checking
       - Test: calling mutateAsync for 'credit_card' type hits /api/v1/accounts/credit-card
       - Test: onSettled invalidates accounts list query
       - Use MSW handlers and renderHook from @testing-library/react
       - May need to update MSW handlers to be more dynamic (accept and return request body)

    Verify: `npx nx test web`
  </action>
  <verify>`npx nx test web` passes (all existing + new tests).</verify>
  <done>
    AccountWizard tested for step navigation, validation, edit mode, and reset behavior.
    DeleteAccountDialog tested for type-to-confirm pattern.
    AccountSidebar tested for rendering, grouping, and interaction.
    useCreateAccount tested for correct API endpoint routing.
  </done>
</task>

</tasks>

<verification>
- `npx nx test web` passes with all new tests
- `npx nx typecheck web` passes
- Test count increases by at least 20 new tests
</verification>

<success_criteria>
Comprehensive Vitest test suite covers account feature logic and component behavior. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-06-SUMMARY.md`
</output>
