---
phase: 15-api-integration-validation
plan: 05
type: execute
wave: 3
depends_on: ["15-02", "15-03"]
files_modified:
  - apps/web/src/features/accounts/hooks/useAccountWizard.ts
  - apps/web/src/lib/api-error.ts
autonomous: true

must_haves:
  truths:
    - "Multi-step form state persists across forward/backward navigation"
    - "Per-step Zod validation runs before advancing to next step"
    - "Form resets completely when wizard dialog closes"
    - "API errors surface in the wizard UI (not silent failures)"
    - "Loading state shown during account creation/update"
  artifacts:
    - path: "apps/web/src/features/accounts/hooks/useAccountWizard.ts"
      provides: "Multi-step form state management hook"
      min_lines: 40
  key_links:
    - from: "apps/web/src/features/accounts/hooks/useAccountWizard.ts"
      to: "apps/web/src/features/accounts/validation/accountSchemas.ts"
      via: "zodResolver for per-step validation"
      pattern: "zodResolver.*stepSchemas"
---

<objective>
Implement the multi-step form state management hook and enhance error handling for account mutations.

Purpose: The useAccountWizard hook is the core logic that drives the wizard's step navigation, validation, and form data accumulation. Separating it from the visual components keeps logic testable.
Output: Fully functional wizard hook with per-step validation, forward/backward navigation, and reset behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/15-api-integration-validation/15-RESEARCH.md
@.planning/phases/15-api-integration-validation/15-03-SUMMARY.md
@apps/web/src/features/accounts/validation/accountSchemas.ts
@apps/web/src/lib/api-error.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement useAccountWizard hook and enhance error handling</name>
  <files>
    apps/web/src/features/accounts/hooks/useAccountWizard.ts
    apps/web/src/lib/api-error.ts
  </files>
  <action>
    1. Create `apps/web/src/features/accounts/hooks/useAccountWizard.ts`:

       The hook manages multi-step form state for the account wizard. It must handle:

       - **Step tracking:** currentStep (0-3), totalSteps (4)
       - **Form state:** React Hook Form instance with zodResolver for current step's schema
       - **Accumulated data:** useState<Partial<AccountFormData>> to persist data across steps
       - **Edit mode:** accepts optional editAccount (AccountResponse) to pre-fill form data

       Implementation details:
       ```typescript
       export function useAccountWizard(editAccount?: AccountResponse | null) {
         const [currentStep, setCurrentStep] = useState(editAccount ? 1 : 0); // Skip type step in edit mode
         const [formData, setFormData] = useState<Partial<AccountFormData>>(() => {
           if (editAccount) {
             return mapAccountToFormData(editAccount); // Map API response to form fields
           }
           return {};
         });

         // Re-create form when step changes (new zodResolver per step)
         const form = useForm({
           resolver: zodResolver(stepSchemas[currentStep]),
           defaultValues: formData,
           mode: 'onBlur', // Validate on blur for UX
         });

         // Sync form defaultValues when formData changes (step navigation)
         useEffect(() => {
           form.reset(formData);
         }, [currentStep]); // Reset form when step changes to load accumulated data

         const goToNextStep = async () => {
           const isValid = await form.trigger();
           if (isValid) {
             const currentValues = form.getValues();
             setFormData(prev => ({ ...prev, ...currentValues }));
             setCurrentStep(prev => Math.min(prev + 1, 3));
           }
         };

         const goToPreviousStep = () => {
           const currentValues = form.getValues();
           setFormData(prev => ({ ...prev, ...currentValues }));
           setCurrentStep(prev => Math.max(prev - 1, editAccount ? 1 : 0));
         };

         const reset = () => {
           setCurrentStep(editAccount ? 1 : 0);
           setFormData(editAccount ? mapAccountToFormData(editAccount) : {});
           form.reset();
         };

         return {
           currentStep,
           totalSteps: editAccount ? 3 : 4, // 3 visible steps in edit mode (type locked)
           form,
           formData: { ...formData, ...form.getValues() },
           goToNextStep,
           goToPreviousStep,
           reset,
           isFirstStep: currentStep === (editAccount ? 1 : 0),
           isLastStep: currentStep === 3,
           isEditMode: !!editAccount,
         };
       }
       ```

       - Add `mapAccountToFormData(account: AccountResponse): Partial<AccountFormData>` helper:
         - Maps account_type, name, opening_balance.amount, credit_limit, apr, term_months, subtype, rewards_balance to form field names
         - Handles null/undefined fields gracefully

    2. Enhance `apps/web/src/lib/api-error.ts`:
       - Ensure it exports a function to extract user-friendly error messages from API error responses
       - The existing api-error.ts may already have this. If so, verify it handles:
         - 400 errors (validation): extract message from response body
         - 409 errors (conflict): "Account with this name already exists" or similar
         - 500 errors: "Something went wrong. Please try again."
         - Network errors: "Unable to connect. Check your network."
       - If the existing implementation is sufficient, no changes needed. Only add what's missing.

    Verify: `npx nx typecheck web && npx nx test web`
  </action>
  <verify>
    `npx nx typecheck web` passes.
    `npx nx test web` passes.
  </verify>
  <done>
    useAccountWizard hook manages multi-step form with per-step Zod validation, forward/backward navigation, edit mode pre-fill, and reset on close.
    API errors surfaced as user-friendly messages for display in wizard UI.
  </done>
</task>

</tasks>

<verification>
- `npx nx typecheck web` passes
- `npx nx test web` passes
- Hook tracks step state correctly (0-3 for new, 1-3 for edit)
- Form data persists across forward and backward navigation
- Zod validation blocks advancement on invalid input
- Reset clears all state to initial values
</verification>

<success_criteria>
Wizard form logic fully functional. Hook is testable independently of visual components.
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-05-SUMMARY.md`
</output>
