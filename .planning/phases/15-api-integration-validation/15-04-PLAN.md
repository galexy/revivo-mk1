---
phase: 15-api-integration-validation
plan: 04
type: execute
wave: 3
depends_on: ["15-02", "15-03"]
files_modified:
  - apps/web/src/features/accounts/hooks/useAccounts.ts
  - apps/web/src/features/accounts/hooks/useCreateAccount.ts
  - apps/web/src/features/accounts/hooks/useUpdateAccount.ts
  - apps/web/src/features/accounts/hooks/useDeleteAccount.ts
  - apps/web/src/pages/DashboardPage.tsx
  - apps/web/src/routes.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar fetches and displays real accounts from the API via TanStack Query"
    - "Creating an account via wizard updates the sidebar immediately (optimistic or invalidation)"
    - "Editing an account via wizard updates the sidebar immediately"
    - "Deleting an account removes it from sidebar immediately"
    - "Empty state shown when user has zero accounts"
    - "Clicking an account navigates to its detail view"
  artifacts:
    - path: "apps/web/src/features/accounts/hooks/useCreateAccount.ts"
      provides: "TanStack Query mutation hook for account creation"
      min_lines: 15
    - path: "apps/web/src/features/accounts/hooks/useUpdateAccount.ts"
      provides: "TanStack Query mutation hook for account updates"
      min_lines: 15
    - path: "apps/web/src/features/accounts/hooks/useDeleteAccount.ts"
      provides: "TanStack Query mutation hook for account deletion"
      min_lines: 15
    - path: "apps/web/src/pages/DashboardPage.tsx"
      provides: "Rewired dashboard with real sidebar and empty state"
      min_lines: 40
  key_links:
    - from: "apps/web/src/features/accounts/hooks/useCreateAccount.ts"
      to: "apps/web/src/lib/api-client.ts"
      via: "createCheckingAccount/createSavingsAccount/etc"
      pattern: "create.*Account"
    - from: "apps/web/src/pages/DashboardPage.tsx"
      to: "apps/web/src/features/accounts/hooks/useAccounts.ts"
      via: "useAccounts hook"
      pattern: "useAccounts"
    - from: "apps/web/src/features/accounts/hooks/useCreateAccount.ts"
      to: "apps/web/src/lib/query-keys.ts"
      via: "invalidateQueries"
      pattern: "queryKeys\\.accounts"
---

<objective>
Wire the designed components to real API data using TanStack Query hooks for all CRUD operations.

Purpose: Connect the visual components from Plans 02/03 to the backend API via mutation hooks and query-based data fetching.
Output: Fully functional account CRUD -- create, edit, delete accounts, sidebar updates in real-time.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/15-api-integration-validation/15-CONTEXT.md
@.planning/phases/15-api-integration-validation/15-RESEARCH.md
@.planning/phases/15-api-integration-validation/15-02-SUMMARY.md
@.planning/phases/15-api-integration-validation/15-03-SUMMARY.md
@apps/web/src/lib/api-client.ts
@apps/web/src/lib/query-keys.ts
@apps/web/src/lib/query-options.ts
@apps/web/src/routes.tsx
@apps/web/src/pages/DashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TanStack Query mutation hooks for account CRUD</name>
  <files>
    apps/web/src/features/accounts/hooks/useAccounts.ts
    apps/web/src/features/accounts/hooks/useCreateAccount.ts
    apps/web/src/features/accounts/hooks/useUpdateAccount.ts
    apps/web/src/features/accounts/hooks/useDeleteAccount.ts
  </files>
  <action>
    1. Create `useAccounts.ts`:
       - Thin wrapper around useQuery with accountsQueryOptions (from lib/query-options.ts)
       - Returns { accounts, isLoading, error } -- unwraps the AccountListResponse.accounts array
       - No extra logic, just convenience hook

    2. Create `useCreateAccount.ts`:
       - useMutation that accepts formData (from the wizard) and maps accountType to the correct API function:
         - checking -> createCheckingAccount
         - savings -> createSavingsAccount
         - credit_card -> createCreditCardAccount
         - loan -> createLoanAccount
         - brokerage -> createBrokerageAccount
         - ira -> createIraAccount
         - rewards -> createRewardsAccount
       - The mutationFn must map the wizard's flat formData to the correct API request shape:
         - Common: { name, opening_balance: { amount: parseFloat(openingBalance), currency: "USD" } }
         - credit_card adds: credit_limit: { amount: parseFloat(creditLimit), currency: "USD" }
         - loan adds: apr (as decimal, e.g., 5.99% -> 0.0599), term_months (parseInt), subtype
         - ira adds: subtype
         - rewards uses: rewards_balance: { value: parseFloat(rewardsValue), unit: rewardsUnit } instead of opening_balance
       - onSettled: invalidateQueries({ queryKey: queryKeys.accounts.lists() })
       - Do NOT use optimistic updates for create (we need the server-generated ID)
       - Return the mutation hook so consumers can check isPending, isError, error

    3. Create `useUpdateAccount.ts`:
       - useMutation accepting { id: string, data: UpdateAccountRequest }
       - mutationFn: updateAccount(id, data) from api-client
       - onSettled: invalidateQueries for both accounts.lists() and accounts.detail(id)
       - No optimistic updates (simpler, safer -- invalidation-based refresh)

    4. Create `useDeleteAccount.ts`:
       - useMutation accepting accountId (string)
       - mutationFn: deleteAccount(id) from api-client
       - onSettled: invalidateQueries({ queryKey: queryKeys.accounts.lists() })
       - Also remove the detail cache: queryClient.removeQueries({ queryKey: queryKeys.accounts.detail(id) })

    Verify: `npx nx typecheck web`
  </action>
  <verify>`npx nx typecheck web` passes.</verify>
  <done>
    Four mutation hooks (useAccounts, useCreateAccount, useUpdateAccount, useDeleteAccount) exist with proper cache invalidation.
    useCreateAccount correctly maps wizard formData to per-type API request shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire DashboardPage with real data, routing, and CRUD integration</name>
  <files>
    apps/web/src/pages/DashboardPage.tsx
    apps/web/src/routes.tsx
  </files>
  <action>
    1. Rewrite `DashboardPage.tsx` to integrate all account components:
       - Use useAccounts() hook to fetch real account data
       - State management for dialogs: wizardOpen (boolean), editAccount (AccountResponse | null), deleteAccount ({ id, name } | null)
       - Conditional rendering:
         - If accounts.length === 0: show EmptyAccountsState in the main area (no sidebar)
         - If accounts.length > 0: show AccountSidebar + main content area
       - Wire AccountSidebar props:
         - accounts: from useAccounts
         - onAddAccount: open wizard dialog (wizardOpen = true)
         - onEdit: set editAccount and open wizard
         - onDelete: set deleteAccount and open delete dialog
         - onSelectAccount: navigate to /dashboard/accounts/:id
         - activeAccountId: from route params (if on detail route)
       - Wire AccountWizard:
         - open: wizardOpen
         - onOpenChange: close wizard and clear editAccount
         - editAccount: from state
         - onSubmit: call createAccount.mutateAsync or updateAccount.mutateAsync, then close wizard. On success, navigate to the new account detail if creating.
       - Wire DeleteAccountDialog:
         - open: deleteAccount !== null
         - onOpenChange: clear deleteAccount
         - accountName/accountId: from deleteAccount state
         - onConfirmDelete: call deleteAccount.mutateAsync, then close
       - Preserve dark mode toggle behavior from existing DashboardPage
       - Header remains: "Personal Finance" title + UserMenu
       - Main content area: renders route Outlet (for account detail routes)

    2. Update `routes.tsx`:
       - Add account detail route under protectedLayoutRoute:
         ```typescript
         const accountDetailRoute = createRoute({
           getParentRoute: () => protectedLayoutRoute,
           path: '/dashboard/accounts/$accountId',
           loader: ({ context, params }) => {
             context.queryClient.ensureQueryData(accountDetailQueryOptions(params.accountId));
           },
           component: () => {
             // Lazy import or inline: simple page showing account name + balance + "Transactions coming in Phase 17" placeholder
           },
         });
         ```
       - Update dashboard route to use a layout that renders Outlet for nested routes
       - The dashboard route at /dashboard shows the main content area (accounts overview or empty state)
       - /dashboard/accounts/:accountId shows account detail in the main content area
       - Import accountDetailQueryOptions from query-options

    3. Create a simple AccountDetailPage (inline or separate file at apps/web/src/pages/AccountDetailPage.tsx):
       - Uses useQuery with accountDetailQueryOptions to fetch account
       - Shows: account name, account type badge, balance
       - Placeholder: "Transactions will appear here in a future update."
       - Uses Card component for clean layout

    Verify: `npx nx typecheck web && npx nx test web`
  </action>
  <verify>
    `npx nx typecheck web` passes.
    `npx nx test web` passes.
  </verify>
  <done>
    DashboardPage shows real accounts in sidebar, empty state when no accounts.
    Account CRUD operations work: create via wizard, edit via wizard, delete via dialog.
    Account detail route shows account info when clicked.
    All mutations invalidate the correct queries for instant UI updates.
  </done>
</task>

</tasks>

<verification>
- `npx nx typecheck web` passes
- `npx nx test web` passes
- Dashboard shows empty state for new users
- Creating account updates sidebar immediately
- Editing account updates sidebar immediately
- Deleting account removes from sidebar immediately
- Clicking account navigates to detail view
</verification>

<success_criteria>
Full account CRUD wired through the UI. All operations hit the real API and the UI updates via TanStack Query cache invalidation.
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-integration-validation/15-04-SUMMARY.md`
</output>
