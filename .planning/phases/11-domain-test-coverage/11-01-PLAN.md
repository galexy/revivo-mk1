---
phase: 11-domain-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/domain/tests/unit/domain/test_transaction.py
  - libs/domain/tests/unit/domain/test_category.py
  - libs/domain/tests/unit/domain/test_payee.py
autonomous: true

must_haves:
  truths:
    - "Transaction domain model has unit tests covering create, update, status changes, splits, and events"
    - "Category domain model has unit tests covering create, update, delete, hierarchy, system categories"
    - "Payee domain model has unit tests covering create, update, usage tracking"
    - "Domain coverage increases from 48% toward 70%+"
  artifacts:
    - path: "libs/domain/tests/unit/domain/test_transaction.py"
      provides: "Transaction aggregate unit tests"
      min_lines: 100
    - path: "libs/domain/tests/unit/domain/test_category.py"
      provides: "Category entity unit tests"
      min_lines: 80
    - path: "libs/domain/tests/unit/domain/test_payee.py"
      provides: "Payee entity unit tests"
      min_lines: 50
  key_links:
    - from: "libs/domain/tests/unit/domain/test_transaction.py"
      to: "libs/domain/domain/model/transaction.py"
      via: "import and test"
      pattern: "from domain.model.transaction import"
---

<objective>
Add domain unit tests for Transaction, Category, and Payee models to close the coverage gap.

Purpose: Domain coverage is 48% because 268 statements across Transaction (144 stmts), Category (88 stmts), and Payee (36 stmts) have zero domain-level unit tests. They rely on API integration tests only. Domain unit tests verify domain logic independent of infrastructure.
Output: Three new test files with comprehensive model coverage. Domain coverage should rise to ~70-80%.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@libs/domain/domain/model/transaction.py
@libs/domain/domain/model/category.py
@libs/domain/domain/model/payee.py
@libs/domain/domain/model/split_line.py
@libs/domain/domain/model/transaction_types.py
@libs/domain/domain/model/entity_id.py
@libs/domain/domain/model/money.py

Follow existing test patterns from:
@libs/domain/tests/unit/domain/test_account.py
@libs/domain/tests/unit/domain/test_money.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Transaction aggregate unit tests</name>
  <files>
    libs/domain/tests/unit/domain/test_transaction.py
  </files>
  <action>
    Create test_transaction.py with comprehensive tests for the Transaction aggregate root.
    Read libs/domain/domain/model/transaction.py first to understand all methods and invariants.

    Test classes to create:

    1. **TestTransactionCreate** -- Test Transaction.create() factory method:
       - Creates with required fields (account_id, user_id, amount, splits, effective_date)
       - Generates unique TransactionId
       - Sets default status (PENDING)
       - Sets default source (MANUAL)
       - Emits TransactionCreated event
       - Sets created_at and updated_at timestamps
       - Validates splits sum equals amount

    2. **TestTransactionCreateMirror** -- Test Transaction.create_mirror():
       - Creates mirror for transfer with correct attributes
       - Mirror has positive amount (incoming)
       - Sets source_split_id linking to source transaction's split
       - Emits TransactionCreated event

    3. **TestTransactionStatusChanges** -- Test status transitions:
       - PENDING -> CLEARED via clear()
       - CLEARED -> RECONCILED via reconcile()
       - Invalid transitions raise ValueError (if any)
       - Status change emits TransactionStatusChanged event

    4. **TestTransactionUpdate** -- Test update methods:
       - update_amount() changes amount and emits TransactionUpdated event
       - update_memo() changes memo
       - update_payee() changes payee_id
       - update_effective_date() changes date
       - update_posted_date() changes posted date
       - update_check_number() changes check number
       - update_splits() replaces splits list
       - Each mutation updates updated_at timestamp

    5. **TestTransactionDelete** -- Test delete():
       - Emits TransactionDeleted event
       - Marks as deleted (if applicable)

    6. **TestTransactionEvents** -- Test event collection:
       - events property returns list of domain events
       - clear_events() empties the list
       - Multiple mutations accumulate events

    Use test helpers to create valid SplitLine and Money instances.
    Follow existing patterns from test_account.py for entity testing style.
    Use well-known default household ID from entity_id module.
  </action>
  <verify>
    Run `npx nx test domain` -- all tests pass including new transaction tests.
    Run `npx nx typecheck domain` -- zero errors.
  </verify>
  <done>
    Transaction model has comprehensive unit tests covering create, create_mirror, status changes,
    update methods, delete, and event emission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Category and Payee unit tests</name>
  <files>
    libs/domain/tests/unit/domain/test_category.py
    libs/domain/tests/unit/domain/test_payee.py
  </files>
  <action>
    Read libs/domain/domain/model/category.py and libs/domain/domain/model/payee.py
    to understand all methods.

    **test_category.py** -- Test Category entity:

    1. **TestCategoryCreate** -- Category.create() factory:
       - Creates with required fields (user_id, name)
       - Generates unique CategoryId
       - Sets default category_type (EXPENSE)
       - Sets is_system=False by default
       - Sets is_hidden=False by default
       - Emits CategoryCreated event
       - Supports optional parent_id, icon, category_type

    2. **TestCategoryCreateSystem** -- Category.create_system():
       - Creates system category with is_system=True
       - System categories have correct name

    3. **TestCategoryUpdate** -- Test update methods:
       - update_name() changes name and emits CategoryUpdated event
       - update_name() rejects empty name
       - update_name() on system category raises ValueError
       - update_parent() changes parent_id
       - update_parent() on system category raises ValueError

    4. **TestCategoryDelete** -- Test delete():
       - Emits CategoryDeleted event
       - delete() on system category raises ValueError

    5. **TestCategoryEvents** -- Events:
       - events property, clear_events()

    6. **TestCategoryType** -- CategoryType enum:
       - INCOME and EXPENSE values exist
       - StrEnum behavior (string comparison)

    **test_payee.py** -- Test Payee entity:

    1. **TestPayeeCreate** -- Payee.create() factory:
       - Creates with required fields (user_id, name)
       - Generates unique PayeeId
       - Normalizes name to lowercase for normalized_name
       - Sets default_category_id if provided
       - Sets initial usage_count to 0
       - Sets last_used_at to None initially

    2. **TestPayeeUpdate** -- Test update methods:
       - update_name() changes name and normalized_name
       - update_default_category() changes default_category_id
       - record_usage() increments usage_count and sets last_used_at

    3. **TestPayeeNormalization** -- Name normalization:
       - Lowercase conversion
       - Whitespace handling
  </action>
  <verify>
    Run `npx nx test domain` -- all tests pass including new category and payee tests.
    Run `npx nx typecheck domain` -- zero errors.
    Run `npx nx coverage domain` -- coverage should be significantly higher than 48%.
  </verify>
  <done>
    Category and Payee models have comprehensive unit tests. Domain coverage improved significantly
    from 48% baseline.
  </done>
</task>

</tasks>

<verification>
1. `npx nx typecheck domain` -- zero errors
2. `npx nx test domain` -- all tests pass (192 existing + ~30-50 new)
3. `npx nx coverage domain` -- coverage significantly above 48%
4. All three test files exist with meaningful test coverage
</verification>

<success_criteria>
- test_transaction.py, test_category.py, test_payee.py exist with comprehensive tests
- All domain tests pass
- Domain coverage rises from 48% toward 70%+
- Tests verify domain logic (create, update, delete, events, invariants)
</success_criteria>

<output>
After completion, create `.planning/phases/11-domain-test-coverage/11-01-SUMMARY.md`
</output>
