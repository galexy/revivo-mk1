---
phase: 04.1-test-schema-parity
plan: 01
subsystem: database
tags: [alembic, sqlalchemy, migrations, autogenerate, schema-parity]

# Dependency graph
requires:
  - phase: 04-authentication-infrastructure
    provides: tables.py with all 10 tables, TypeDecorators for domain types
provides:
  - Alembic env.py with tables.py import for autogenerate support
  - Alembic env.py with compare_type=True for thorough drift detection
  - Alembic script.py.mako with custom types import
  - Single autogenerated initial migration replacing 7 hand-written migrations
  - Pre and post schema snapshots for comparison
affects: [all-future-migrations, schema-changes]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Autogenerate migrations from tables.py metadata"
    - "user_module_prefix for custom TypeDecorators"
    - "compare_type=True for type drift detection"

key-files:
  created:
    - alembic/versions/c30a32b605ab_initial_schema.py
    - .planning/phases/04.1-test-schema-parity/pre-rework-schema.json
    - .planning/phases/04.1-test-schema-parity/post-rework-schema.json
  modified:
    - alembic/env.py
    - alembic/script.py.mako

key-decisions:
  - "Import tables.py in env.py to register Table objects with metadata (fixes empty metadata bug)"
  - "Use user_module_prefix='types.' for clean TypeDecorator rendering in migrations"
  - "Enable compare_type=True for thorough drift detection during autogenerate"
  - "Replace all 7 hand-written migrations with single autogenerated migration"

patterns-established:
  - "Alembic autogenerate: Always autogenerate from tables.py metadata"
  - "FK naming convention: fk_{table}_{column}_{referred_table} (enforced by base.py)"
  - "Custom types in migrations: Rendered as types.XxxType() via user_module_prefix"

# Metrics
duration: 3min
completed: 2026-02-06
---

# Phase 04.1 Plan 01: Fix Alembic Config and Replace Migrations Summary

**Alembic autogenerate enabled with tables.py import, 7 hand-written migrations replaced by single autogenerated migration from metadata**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-06T05:12:41Z
- **Completed:** 2026-02-06T05:15:52Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- Fixed critical bug in env.py: added tables.py import so autogenerate sees all 10 tables
- Configured autogenerate with compare_type=True and user_module_prefix="types."
- Replaced all 7 hand-written migrations with single autogenerated migration
- Verified zero drift between tables.py metadata and migration chain
- All 407 tests pass, service starts and handles requests

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix Alembic config and capture pre-rework schema snapshot** - `cc69a61` (fix)
2. **Task 2: Replace hand-written migrations with autogenerated migration** - `2cd4481` (feat)

## Files Created/Modified
- `alembic/env.py` - Added tables.py import, compare_type=True, user_module_prefix
- `alembic/script.py.mako` - Added custom types import for autogenerated migrations
- `alembic/versions/c30a32b605ab_initial_schema.py` - Single autogenerated initial migration
- `.planning/phases/04.1-test-schema-parity/pre-rework-schema.json` - Pre-rework schema snapshot
- `.planning/phases/04.1-test-schema-parity/post-rework-schema.json` - Post-rework schema snapshot

## Decisions Made
- Used `user_module_prefix="types."` instead of `render_item` callback - simpler and sufficient for TypeDecorators with `impl = String`
- FK naming convention now standardized: `fk_{table}_{column}_{referred_table}` (10 FKs renamed from old shorter names)
- No data preservation needed - dev-stage project with no production data

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- psql not available in devcontainer; used SQLAlchemy with AUTOCOMMIT isolation level for schema drop/recreate
- Service module path is `src.adapters.api.app:app` not `src.main:app`

## Schema Comparison Results

Pre/post schema diff showed only expected differences (FK naming convention changes):

| Old FK Name | New FK Name | Table |
|-------------|-------------|-------|
| fk_accounts_household_id | fk_accounts_household_id_households | accounts |
| fk_categories_household_id | fk_categories_household_id_households | categories |
| fk_payees_household_id | fk_payees_household_id_households | payees |
| fk_transactions_household_id | fk_transactions_household_id_households | transactions |
| fk_users_household_id | fk_users_household_id_households | users |

## Verification Results

| Check | Result |
|-------|--------|
| alembic upgrade head | Applied cleanly |
| alembic check | No drift detected |
| alembic downgrade base && upgrade head | Reversible |
| pytest tests/ | 407 passed |
| Service /docs endpoint | Returns HTML |
| Service /auth/register | Returns 200 with user_id |

## Next Phase Readiness
- Alembic autogenerate now works correctly from tables.py
- Future migrations will autogenerate from the single source of truth
- Schema parity between integration tests (metadata.create_all) and production (Alembic) established

---
*Phase: 04.1-test-schema-parity*
*Completed: 2026-02-06*
