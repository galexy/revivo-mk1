---
phase: 04.1-test-schema-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - alembic/env.py
  - alembic/script.py.mako
  - alembic/versions/001_initial_schema.py
  - alembic/versions/002_create_accounts_table.py
  - alembic/versions/003_add_transaction_tables.py
  - alembic/versions/004_add_category_type.py
  - alembic/versions/005_add_split_identity.py
  - alembic/versions/006_add_auth_tables.py
  - alembic/versions/007_replace_owner_with_role.py
autonomous: true

must_haves:
  truths:
    - "alembic revision --autogenerate produces a migration that matches tables.py metadata"
    - "alembic upgrade head applies cleanly to a fresh database and produces the correct schema"
    - "alembic check reports no schema drift between metadata and migration chain"
    - "All 407 existing tests still pass after migration rework"
  artifacts:
    - path: "alembic/env.py"
      provides: "Fixed env.py that imports tables.py so autogenerate sees all 10 tables"
      contains: "import src.adapters.persistence.orm.tables"
    - path: "alembic/script.py.mako"
      provides: "Updated template with custom type imports for autogenerated migrations"
      contains: "from src.adapters.persistence.orm import types"
    - path: "alembic/versions/*_initial_schema.py"
      provides: "Single autogenerated migration replacing all 7 hand-written migrations"
  key_links:
    - from: "alembic/env.py"
      to: "src/adapters/persistence/orm/tables.py"
      via: "import statement"
      pattern: "import src\\.adapters\\.persistence\\.orm\\.tables"
    - from: "alembic/env.py"
      to: "src/adapters/persistence/orm/base.py"
      via: "metadata import"
      pattern: "from src\\.adapters\\.persistence\\.orm\\.base import metadata"
---

<objective>
Fix the Alembic configuration (env.py bug, script.py.mako template) and replace all 7 hand-written migrations with a single autogenerated migration from the current SQLAlchemy tables.py metadata.

Purpose: The root cause of schema drift between integration tests (metadata.create_all) and production (Alembic migrations) is that all 7 migrations were hand-written. This plan eliminates drift by autogenerating from the single source of truth (tables.py). Since this is a development-stage project with no production data, we do a clean fresh start.

Output: Working Alembic configuration with autogenerate support, one autogenerated initial migration, verified against real database.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/agents/gsd-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/04.1-test-schema-parity/04.1-CONTEXT.md
@.planning/phases/04.1-test-schema-parity/04.1-RESEARCH.md
@alembic/env.py
@alembic/script.py.mako
@src/adapters/persistence/orm/base.py
@src/adapters/persistence/orm/tables.py
@src/adapters/persistence/orm/types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Alembic config and capture pre-rework schema snapshot</name>
  <files>
    alembic/env.py
    alembic/script.py.mako
  </files>
  <action>
    **Fix env.py (CRITICAL BUG):**
    1. Add `import src.adapters.persistence.orm.tables  # noqa: F401` after the metadata import on line 17. Without this, autogenerate sees 0 tables because tables.py registers Table objects with metadata on import, and it's never imported.
    2. In `run_migrations_online()`, add `compare_type=True` to the `context.configure()` call. This enables type comparison during autogenerate for more thorough drift detection.
    3. Add `user_module_prefix="types."` to both `context.configure()` calls (offline and online). This makes autogenerated migrations render custom TypeDecorators as `types.AccountIdType()` instead of `src.adapters.persistence.orm.types.AccountIdType()`.

    **Update script.py.mako:**
    Add `from src.adapters.persistence.orm import types  # Custom TypeDecorators` as an import line in the template, so every autogenerated migration can resolve `types.XxxType` references.

    **Capture pre-rework schema snapshot:**
    Before deleting any migrations, capture the current database schema using SQLAlchemy `inspect()` API (pg_dump is not available in the devcontainer). Save the snapshot as a JSON file at `.planning/phases/04.1-test-schema-parity/pre-rework-schema.json`.

    Steps:
    1. Ensure the main database (`personal_finance`) has current migrations applied: run `alembic upgrade head`
    2. Use SQLAlchemy `inspect()` to capture all table names, columns (name, type, nullable), primary keys, foreign keys (name, referred_table), and indexes (name, unique) for every table except `alembic_version`
    3. Write the snapshot dict as formatted JSON

    Do NOT use `render_item` callback -- `user_module_prefix` is simpler and sufficient for this project's TypeDecorators (all have `impl = String`).
  </action>
  <verify>
    1. Run `python -c "from alembic.config import Config; from alembic import command; command.check(Config('alembic.ini'))"` -- this will fail (expected, since we haven't regenerated migrations yet) but should NOT error with "empty metadata" or import errors
    2. Verify the pre-rework schema JSON file exists and contains entries for all 10 tables (outbox, households, users, encrypted_secrets, accounts, categories, payees, transactions, split_lines, refresh_tokens)
  </verify>
  <done>
    env.py imports tables.py and configures autogenerate with compare_type and user_module_prefix. script.py.mako includes custom type import. Pre-rework schema snapshot captured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hand-written migrations with autogenerated migration</name>
  <files>
    alembic/versions/001_initial_schema.py (DELETE)
    alembic/versions/002_create_accounts_table.py (DELETE)
    alembic/versions/003_add_transaction_tables.py (DELETE)
    alembic/versions/004_add_category_type.py (DELETE)
    alembic/versions/005_add_split_identity.py (DELETE)
    alembic/versions/006_add_auth_tables.py (DELETE)
    alembic/versions/007_replace_owner_with_role.py (DELETE)
    alembic/versions/*_initial_schema.py (CREATE via autogenerate)
  </files>
  <action>
    **Delete all 7 hand-written migrations:**
    ```bash
    rm alembic/versions/001_initial_schema.py
    rm alembic/versions/002_create_accounts_table.py
    rm alembic/versions/003_add_transaction_tables.py
    rm alembic/versions/004_add_category_type.py
    rm alembic/versions/005_add_split_identity.py
    rm alembic/versions/006_add_auth_tables.py
    rm alembic/versions/007_replace_owner_with_role.py
    ```

    **Reset Alembic state on the main database:**
    Drop the `alembic_version` table (or run `alembic stamp base`) on the `personal_finance` database so Alembic doesn't think migrations are applied.

    **Drop and recreate the public schema on the main database:**
    Since this is a dev project with no data to preserve, drop all tables so autogenerate can compare against an empty database:
    ```sql
    DROP SCHEMA public CASCADE;
    CREATE SCHEMA public;
    ```

    **Autogenerate the initial migration:**
    ```bash
    alembic revision --autogenerate -m "initial schema"
    ```

    **Review the generated migration:**
    1. Verify all 10 tables are created (outbox, households, users, encrypted_secrets, accounts, categories, payees, transactions, split_lines, refresh_tokens)
    2. Verify custom types render as `types.AccountIdType(length=36)` etc. (not full module paths)
    3. Verify FKs use naming convention from base.py (e.g., `fk_accounts_household_id_households`)
    4. Verify indexes match those defined in tables.py
    5. Clean up any issues in the generated migration (e.g., remove `schema=None` noise if present, verify table creation order respects FK dependencies)

    **Apply the migration to the main database:**
    ```bash
    alembic upgrade head
    ```

    **Capture post-rework schema snapshot:**
    Using the same SQLAlchemy `inspect()` approach as Task 1, capture the schema after applying the new migration. Save to `.planning/phases/04.1-test-schema-parity/post-rework-schema.json`.

    **Compare pre and post snapshots:**
    Diff the two JSON files. Expected differences:
    - FK naming: `fk_accounts_household_id` -> `fk_accounts_household_id_households` (5 household_id FKs across accounts, categories, payees, transactions, users)
    - `email_verified` column may appear in post but not pre (was in tables.py but missing from old migrations -- verify which direction)
    - Any other differences must be investigated and explained

    **Verify no remaining drift:**
    ```bash
    alembic check
    ```
    This should report "No new upgrade operations detected" (no drift between metadata and migration chain).

    **Run all tests:**
    ```bash
    pytest tests/ -x -q
    ```
    All 407 tests must pass. The integration tests use `metadata.create_all()` on the test database, which is unaffected by migration changes. The unit tests don't touch the database at all.
  </action>
  <verify>
    1. `alembic upgrade head` applies cleanly to a fresh database (exit code 0)
    2. `alembic check` reports no drift (exit code 0)
    3. `alembic downgrade base` then `alembic upgrade head` works cleanly (reversibility)
    4. `pytest tests/ -x -q` -- all 407 tests pass
    5. Start the actual service: `uvicorn src.main:app --host 0.0.0.0 --port 8000` and smoke test:
       - `curl -s http://localhost:8000/docs | head -5` returns HTML (service starts)
       - `curl -s -X POST http://localhost:8000/auth/register -H "Content-Type: application/json" -d '{"email":"smoke@test.com","password":"Test1234!","display_name":"Smoke"}'` returns 202
  </verify>
  <done>
    All 7 hand-written migrations replaced with a single autogenerated migration. Migration applies cleanly, alembic check reports no drift, all tests pass, service starts and responds to requests.
  </done>
</task>

</tasks>

<verification>
1. `alembic upgrade head` on fresh database succeeds
2. `alembic check` reports no schema drift
3. `alembic downgrade base && alembic upgrade head` roundtrip works
4. `pytest tests/ -x -q` -- all 407 tests pass
5. Service starts and handles registration endpoint
6. Pre/post schema diff shows only expected differences (FK naming, email_verified)
</verification>

<success_criteria>
- Single autogenerated migration file exists in alembic/versions/
- No hand-written migration files remain
- alembic check confirms zero drift between tables.py metadata and migration chain
- All 407 existing tests pass
- Service starts and responds to API requests
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-test-schema-parity/04.1-01-SUMMARY.md`
</output>
