---
status: complete
phase: 04.1-test-schema-parity
source: [04.1-01-SUMMARY.md, 04.1-02-SUMMARY.md, 04-UAT.md, 03-UAT.md, 03.1-UAT.md]
started: 2026-02-06T06:00:00Z
updated: 2026-02-06T06:36:00Z
---

## Current Test

[testing complete]

## Tests

### 0. Start the API Server
expected: Server starts successfully and /docs returns Swagger UI
endpoint: GET /docs
result: pass

---

## Authentication (from Phase 4)

### 1. User Registration
expected: Returns 202 with user_id field (email enumeration protection - always returns 202)
endpoint: POST /auth/register
result: pass

### 2. Email Verification
expected: Returns 200 success when verifying with valid token.
endpoint: GET /auth/verify?token=<token>
result: pass

### 3. User Login
expected: Returns access_token, token_type="bearer", expires_in. Sets refresh_token cookie.
endpoint: POST /auth/token
result: pass

### 4. Protected Route Without Token
expected: Returns 401 "Not authenticated"
endpoint: GET /api/v1/accounts (no auth header)
result: pass

---

## Accounts (from Phase 2/3)

### 5. Create Checking Account
expected: Returns 201 with account object (id starts with "acct_", type="checking")
endpoint: POST /api/v1/accounts/checking
result: pass

---

## Categories (from Phase 3)

### 6. Create Category
expected: Returns 201 with category object (id starts with "cat_", category_type="expense" default)
endpoint: POST /api/v1/categories
result: pass

---

## Transactions (from Phase 3)

### 7. Create Simple Transaction
expected: Returns 201 with transaction (id starts with "txn_", splits array with split IDs starting with "split_")
endpoint: POST /api/v1/transactions
result: pass

### 8. List Transactions
expected: Returns array containing the transaction created in Test 7
endpoint: GET /api/v1/transactions?account_id=<ACCOUNT_ID>
result: pass

---

## Transfers (from Phase 3)

### 9. Create Second Account (for transfers)
expected: Returns 201 with savings account
endpoint: POST /api/v1/accounts/savings
result: pass

### 10. Create Transfer (Mirror Creation)
expected: Returns 201 with source transaction (is_mirror=false, negative amount). Mirror auto-created in savings.
endpoint: POST /api/v1/transactions
result: pass

### 11. Verify Mirror Exists
expected: Savings account shows mirror transaction (is_mirror=true, positive amount +200.00, has source_split_id)
endpoint: GET /api/v1/transactions?account_id=<ACCOUNT_ID_2>
result: pass

---

## Validation (from Phase 3.1)

### 12. Invalid Account ID Returns 400
expected: Returns 400 with INVALID_ID_FORMAT error (not 500)
endpoint: POST /api/v1/transactions
result: pass

### 13. Split Mismatch Returns 400
expected: Returns 400 with INVALID_SPLITS error when splits don't sum to amount
endpoint: POST /api/v1/transactions
result: pass

---

## PATCH Operations (from Phase 3.2)

### 14. PATCH Transaction Preserves Split IDs
expected: After PATCH, split IDs remain the same (not regenerated)
endpoint: PATCH /api/v1/transactions/<TXN_ID>
result: pass

---

## Household Isolation (from Phase 4)

### 15. Cross-Household Access Returns 404
expected: User cannot access another household's data - returns 404 (not 403, to prevent probing)
endpoint: GET /api/v1/accounts/<OTHER_USER_ACCOUNT_ID>
result: pass

---

## Schema Parity (Phase 4.1 specific)

### 16. Alembic Check Shows Zero Drift
expected: Running `alembic check` reports "No new upgrade operations detected"
command: alembic check
result: pass

### 17. Single Autogenerated Migration Exists
expected: Only one migration file exists in alembic/versions/ (c30a32b605ab_initial_schema.py)
command: ls alembic/versions/*.py
result: pass

### 18. Drift Detection Test Passes
expected: pytest tests/integration/test_schema_parity.py passes
command: pytest tests/integration/test_schema_parity.py -v
result: pass

## Summary

total: 19
passed: 19
issues: 0
pending: 0
skipped: 0

## Gaps

[none]
