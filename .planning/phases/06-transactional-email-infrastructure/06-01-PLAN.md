---
phase: 06-transactional-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .devcontainer/devcontainer.json
  - Makefile
  - docker-compose.yml
autonomous: false

must_haves:
  truths:
    - "MJML is installed via npm and available for template compilation"
    - "Devcontainer automatically installs npm dependencies on rebuild"
    - "make build-emails compiles MJML to HTML"
    - "Mailpit container runs and accepts SMTP on port 1025"
    - "Mailpit web UI accessible on localhost:8025"
  artifacts:
    - path: "package.json"
      provides: "MJML dependency for email template compilation"
      contains: "mjml"
    - path: ".devcontainer/devcontainer.json"
      provides: "Auto-install npm deps on container creation"
      contains: "npm ci"
    - path: "Makefile"
      provides: "Build target for email templates"
      contains: "build-emails"
    - path: "docker-compose.yml"
      provides: "Mailpit service definition"
      contains: "mailpit"
  key_links:
    - from: "Makefile"
      to: "package.json"
      via: "npx mjml command uses installed dependency"
      pattern: "npx mjml"
---

<objective>
Set up MJML build tooling with verified devcontainer integration, plus Mailpit for dev email capture.

Purpose: Ensure MJML is properly installed and working before creating email templates.
Output: Working build toolchain (package.json, devcontainer, Makefile) and Mailpit in Docker Compose.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/06-transactional-email-infrastructure/06-CONTEXT.md
@.planning/phases/06-transactional-email-infrastructure/06-RESEARCH.md

# Current configuration files
@.devcontainer/devcontainer.json
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package.json with MJML dependency</name>
  <files>
    package.json
    .gitignore
  </files>
  <action>
Create package.json in project root (must exist before devcontainer rebuild):

1. Create `package.json`:
```json
{
  "private": true,
  "description": "Node.js dependencies for build tooling (MJML email templates)",
  "devDependencies": {
    "mjml": "^4.15.0"
  }
}
```

2. Add to `.gitignore` if not already present:
```
node_modules/
```

This file must be committed before the devcontainer rebuild so that `npm ci` has something to install.
  </action>
  <verify>
Run `cat package.json | grep mjml` shows mjml dependency.
Run `grep node_modules .gitignore` shows node_modules is ignored.
  </verify>
  <done>
package.json exists with MJML dependency. node_modules in .gitignore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update devcontainer.json for npm integration</name>
  <files>
    .devcontainer/devcontainer.json
  </files>
  <action>
Update devcontainer configuration:

1. Change `postCreateCommand` from `"uv sync"` to `"uv sync && npm ci"`

2. Add port 8025 to `forwardPorts` array for Mailpit web UI:
   - Current: `"forwardPorts": [8000, 5432]`
   - Updated: `"forwardPorts": [8000, 5432, 8025]`

These changes ensure:
- MJML is installed automatically when container is created
- Mailpit UI is accessible from host browser
  </action>
  <verify>
Run `grep "npm ci" .devcontainer/devcontainer.json` shows updated postCreateCommand.
Run `grep "8025" .devcontainer/devcontainer.json` shows port forwarded.
  </verify>
  <done>
devcontainer.json updated with npm ci in postCreateCommand and port 8025 forwarded.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Rebuild devcontainer and verify MJML installation</name>
  <what-built>
Updated devcontainer configuration:
- package.json with MJML dependency
- devcontainer.json with `npm ci` in postCreateCommand
- Port 8025 forwarded for Mailpit UI
  </what-built>
  <how-to-verify>
1. Commit the changes (package.json, .gitignore, devcontainer.json):
   ```bash
   git add package.json .gitignore .devcontainer/devcontainer.json
   git commit -m "feat(06): add MJML build tooling and devcontainer npm integration"
   ```

2. Rebuild the devcontainer:
   - VS Code: Cmd/Ctrl+Shift+P â†’ "Dev Containers: Rebuild Container"
   - Or close and reopen the project in the devcontainer

3. After rebuild, verify MJML is installed:
   ```bash
   npx mjml --version
   ```
   Should output MJML version (e.g., "4.15.0")

4. Verify node_modules exists:
   ```bash
   ls node_modules/mjml
   ```

5. Verify port forwarding:
   - Check that port 8025 appears in forwarded ports (VS Code: Ports panel)
  </how-to-verify>
  <resume-signal>Type "done" when container is rebuilt and MJML is verified working</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create Makefile with build-emails target</name>
  <files>
    Makefile
  </files>
  <action>
Create Makefile in project root:

```makefile
.PHONY: build-emails help

# Default target
help:
	@echo "Available targets:"
	@echo "  build-emails  - Compile MJML templates to HTML"
	@echo "  help          - Show this help message"

# Compile MJML email templates to HTML
build-emails:
	@echo "Compiling MJML templates..."
	@mkdir -p src/adapters/email/templates
	npx mjml src/adapters/email/templates/verification.mjml -o src/adapters/email/templates/verification.html
	@echo "Done. Compiled templates:"
	@ls -la src/adapters/email/templates/*.html 2>/dev/null || echo "No templates compiled yet"
```

Note: The build-emails target will fail until .mjml files exist (created in Plan 06-02). That's expected.
  </action>
  <verify>
Run `make help` shows available targets.
Run `make build-emails` runs (may fail if no .mjml files yet, but command executes).
  </verify>
  <done>
Makefile exists with build-emails target that invokes npx mjml.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add Mailpit to Docker Compose</name>
  <files>
    docker-compose.yml
  </files>
  <action>
Add Mailpit service and SMTP configuration to docker-compose.yml:

1. Add mailpit service:
```yaml
  mailpit:
    image: axllent/mailpit:v1.29
    container_name: mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP
    environment:
      MP_MAX_MESSAGES: 500
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - app-network
```

2. Add SMTP environment variables to app service:
```yaml
    environment:
      # ... existing vars ...
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      SMTP_FROM_NAME: Personal Finance
      SMTP_FROM_EMAIL: noreply@localhost
      APP_BASE_URL: http://localhost:8000
```

3. Add mailpit to app service depends_on (without health check condition - app can start without it).

Per CONTEXT.md decisions:
- Mailpit always-on (not optional profile)
- App starts even if SMTP unavailable
- No SMTP_USER/SMTP_PASSWORD needed for Mailpit (accepts any auth)
  </action>
  <verify>
Run `docker compose config` shows mailpit service with correct ports.
Run `docker compose up -d mailpit` starts Mailpit container.
Run `curl -s http://localhost:8025 | grep -i mailpit` returns Mailpit UI content.
  </verify>
  <done>
Mailpit service defined in docker-compose.yml with ports 8025 (UI) and 1025 (SMTP). App has SMTP_* env vars.
  </done>
</task>

<task type="auto">
  <name>Task 6: Verify full stack and test email capture</name>
  <files>
  </files>
  <action>
Verify the complete setup works:

1. Start Mailpit:
   ```bash
   docker compose up -d mailpit
   ```

2. Verify Mailpit is running:
   ```bash
   docker compose ps mailpit
   curl -s http://localhost:8025 | head -5
   ```

3. Test SMTP accepts connections by sending a test email:
   ```python
   import smtplib
   from email.message import EmailMessage

   msg = EmailMessage()
   msg["Subject"] = "Test Email from Phase 6 Setup"
   msg["From"] = "test@localhost"
   msg["To"] = "recipient@example.com"
   msg.set_content("This is a test email to verify Mailpit is working.")

   with smtplib.SMTP("localhost", 1025) as smtp:
       smtp.send_message(msg)
       print("Email sent successfully")
   ```

4. Verify email appears in Mailpit:
   ```bash
   curl -s http://localhost:8025/api/v1/messages | python -c "import json,sys; d=json.load(sys.stdin); print(f'{len(d.get(\"messages\", []))} message(s)')"
   ```

5. Open http://localhost:8025 in browser and confirm test email is visible.
  </action>
  <verify>
Run `docker compose ps` shows mailpit running.
Run test script successfully sends email.
Mailpit API shows at least 1 message.
Mailpit web UI displays the test email.
  </verify>
  <done>
Full stack verified: MJML installed, Makefile works, Mailpit captures emails.
  </done>
</task>

</tasks>

<verification>
1. package.json exists with mjml dependency
2. devcontainer.json has npm ci in postCreateCommand
3. devcontainer.json forwards port 8025
4. Container rebuilt and MJML verified working (npx mjml --version)
5. Makefile exists with build-emails target
6. docker-compose.yml has mailpit service on ports 8025/1025
7. docker-compose.yml has SMTP_* env vars for app
8. Mailpit captures test email
</verification>

<success_criteria>
- package.json with mjml ^4.15.0 devDependency
- devcontainer postCreateCommand runs uv sync && npm ci
- Port 8025 forwarded in devcontainer
- Container successfully rebuilt with MJML auto-installed
- Makefile with build-emails target
- Mailpit service in docker-compose.yml
- Test email captured by Mailpit
</success_criteria>

<output>
After completion, create `.planning/phases/06-transactional-email-infrastructure/06-01-SUMMARY.md`
</output>
