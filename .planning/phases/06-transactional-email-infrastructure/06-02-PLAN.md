---
phase: 06-transactional-email-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - docker-compose.override.yml
autonomous: true

must_haves:
  truths:
    - "Mailpit container runs and accepts SMTP on port 1025"
    - "Mailpit web UI accessible on localhost:8025"
    - "App container has SMTP environment variables for Mailpit"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Mailpit service definition"
      contains: "mailpit"
    - path: "docker-compose.yml"
      provides: "SMTP environment variables for app"
      contains: "SMTP_HOST"
  key_links:
    - from: "docker-compose.yml services.app"
      to: "docker-compose.yml services.mailpit"
      via: "SMTP_HOST=mailpit"
      pattern: "SMTP_HOST=mailpit"
---

<objective>
Add Mailpit to Docker Compose for dev email capture and configure app SMTP environment.

Purpose: Enable developers to see sent emails in Mailpit web UI during development without real SMTP server.
Output: Mailpit service in Docker Compose, SMTP environment variables for app service.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CHECKPOINTS.md
@.planning/phases/06-transactional-email-infrastructure/06-CONTEXT.md
@.planning/phases/06-transactional-email-infrastructure/06-RESEARCH.md

# Current Docker configuration
@docker-compose.yml
@docker-compose.override.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Mailpit service to Docker Compose</name>
  <files>
    docker-compose.yml
  </files>
  <action>
Add Mailpit service to docker-compose.yml per RESEARCH.md configuration:

1. Add mailpit service:
```yaml
  mailpit:
    image: axllent/mailpit:v1.29
    container_name: mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP
    environment:
      MP_MAX_MESSAGES: 500
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - app-network
```

2. Add SMTP environment variables to app service:
```yaml
    environment:
      # ... existing vars ...
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - SMTP_FROM_NAME=Personal Finance
      - SMTP_FROM_EMAIL=noreply@localhost
      - APP_BASE_URL=http://localhost:8000
```

3. Add depends_on for mailpit to app service (not blocking - app should start even if mailpit slow):
   - Do NOT add condition: service_healthy (mailpit is optional for app startup)
   - Just add to depends_on list without condition

Per CONTEXT.md decisions:
- Mailpit always-on (not optional profile)
- App starts even if SMTP unavailable
- No SMTP_USER/SMTP_PASSWORD needed for Mailpit (accepts any auth)
  </action>
  <verify>
Run `docker compose config` shows mailpit service with correct ports.
Run `docker compose up -d mailpit` starts Mailpit container.
Run `curl -s http://localhost:8025 | grep -i mailpit` returns Mailpit UI content.
  </verify>
  <done>
Mailpit service defined in docker-compose.yml with ports 8025 (UI) and 1025 (SMTP). App has SMTP_* env vars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Docker Compose configuration</name>
  <files>
    docker-compose.override.yml
  </files>
  <action>
Verify and update docker-compose.override.yml if needed:

1. Check if docker-compose.override.yml needs any SMTP-related overrides
   - Usually override is for devcontainer-specific settings
   - SMTP config should be in main docker-compose.yml for all environments

2. Verify the full stack comes up correctly:
   - Run `docker compose down` to clean up
   - Run `docker compose up -d` to start all services
   - Verify postgres, postgres-jobs, and mailpit are running
   - Verify app can start (if applicable)

3. Test Mailpit SMTP accepts connections:
   - Use Python to send test email via smtplib to localhost:1025
   - Verify email appears in Mailpit UI at localhost:8025

Test script to run:
```python
import smtplib
from email.message import EmailMessage

msg = EmailMessage()
msg["Subject"] = "Test Email"
msg["From"] = "test@localhost"
msg["To"] = "recipient@example.com"
msg.set_content("This is a test email")

with smtplib.SMTP("localhost", 1025) as smtp:
    smtp.send_message(msg)
    print("Email sent successfully")
```
  </action>
  <verify>
Run `docker compose ps` shows mailpit running on ports 8025 and 1025.
Run test script successfully sends email.
Check `curl -s http://localhost:8025/api/v1/messages | python -c "import json,sys; print(len(json.load(sys.stdin)['messages']))"` shows at least 1 message.
  </verify>
  <done>
Docker Compose stack runs with Mailpit capturing emails. Test email visible in Mailpit web UI.
  </done>
</task>

</tasks>

<verification>
1. `docker compose config` validates without errors
2. Mailpit container starts and is healthy
3. Mailpit web UI accessible at localhost:8025
4. SMTP port 1025 accepts connections
5. Test email appears in Mailpit inbox
</verification>

<success_criteria>
- Mailpit service defined in docker-compose.yml
- App service has SMTP_HOST, SMTP_PORT, SMTP_FROM_NAME, SMTP_FROM_EMAIL, APP_BASE_URL environment variables
- Mailpit captures test emails sent to port 1025
- Web UI at localhost:8025 displays captured emails
</success_criteria>

<output>
After completion, create `.planning/phases/06-transactional-email-infrastructure/06-02-SUMMARY.md`
</output>
