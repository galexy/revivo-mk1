---
phase: 06-transactional-email-infrastructure
task: 3
total_tasks: 3
plan: 04
status: in_progress
last_updated: 2026-02-06T23:10:00Z
---

<current_state>
Phase 6 execute-phase is nearly complete. Plans 06-01 through 06-03 are fully done with SUMMARYs.
Plan 06-04 has Tasks 1-2 committed. Task 3 (checkpoint:human-verify) was manually verified and PASSED.

Two items remain before phase can be marked complete:

1. **Bug fix needed:** The event handler `src/application/handlers/user_handlers.py` has a sync/async mismatch for job deferral. The fix is already in the working tree (uncommitted) — changed `defer()` to `defer_async()` via `asyncio.get_running_loop().create_task()`. This fix was E2E verified and works. Needs to be committed.

2. **Phase completion steps:** After committing the fix, need to:
   - Create 06-04-SUMMARY.md
   - Run verifier
   - Update STATE.md, ROADMAP.md, REQUIREMENTS.md
   - Commit phase completion metadata
</current_state>

<completed_work>
## Plans Complete (with SUMMARYs)

- **06-01:** MJML Build Tooling & Mailpit Setup (6 tasks, 4 commits)
  - package.json with MJML, devcontainer npm ci, Makefile build-emails, Mailpit in docker-compose
  - SUMMARY: `.planning/phases/06-transactional-email-infrastructure/06-01-SUMMARY.md`

- **06-02:** EmailService Protocol & SMTP Adapter (2 tasks, 2 commits)
  - EmailService Protocol in domain/ports, SmtpEmailAdapter, MJML templates compiled to HTML, Jinja2 rendering
  - SUMMARY: `.planning/phases/06-transactional-email-infrastructure/06-02-SUMMARY.md`

- **06-03:** Event Handler & Job Queue Email Integration (3 tasks, 3 commits)
  - Token expiry 86400→172800 (48h), send_verification_email job implemented, on_user_registered wired
  - SUMMARY: `.planning/phases/06-transactional-email-infrastructure/06-03-SUMMARY.md`

## Plan 06-04 (In Progress)

- **Task 1:** Create MockEmailAdapter — committed as `b0f3ed1`
  - `tests/mocks/__init__.py`, `tests/mocks/email.py`
- **Task 2:** Create integration tests — committed as `e188870`
  - `tests/integration/test_email_verification.py`
  - Bug fix: verification URL corrected from `/auth/verify-email` to `/auth/verify` in tasks.py
- **Task 3:** E2E checkpoint — VERIFIED PASSING (all 8 steps)
  - Register → Mailpit email arrives → Verify link works → Login succeeds → Idempotent re-verify
</completed_work>

<remaining_work>
1. **Commit the defer fix** in `src/application/handlers/user_handlers.py`
   - Changed `send_verification_email.defer()` → `asyncio.get_running_loop().create_task(send_verification_email.defer_async(...))`
   - Reason: PsycopgConnector opened with `open_async()` in lifespan, but `defer()` needs sync connector
   - The fix is already in the working tree, E2E verified
   - Commit as: `fix(06-04): use defer_async for job deferral in async context`

2. **Run tests** to confirm no regressions from the defer fix
   - Some tests may need updating if they mock `defer()` — check test_email_verification.py

3. **Create 06-04-SUMMARY.md** covering all 3 tasks + the defer fix deviation

4. **Run phase verification** (gsd-verifier) against must_haves

5. **Update STATE.md** — Phase 6 complete, plan 4/4

6. **Update ROADMAP.md** — Mark Phase 6 complete

7. **Update REQUIREMENTS.md** — Mark phase 6 requirements as Complete (if applicable)

8. **Commit phase metadata** — `docs(06): complete transactional email infrastructure phase`
</remaining_work>

<decisions_made>
- **defer_async + create_task** instead of sync defer: The event bus is synchronous (handler(event) not await), but the procrastinate PsycopgConnector is opened async in FastAPI lifespan. Sync `defer()` fails with AppNotOpen. Solution: use `asyncio.get_running_loop().create_task(defer_async(...))` to schedule the async defer on the running event loop without blocking the sync handler.

- **Procrastinate schema applied manually:** The jobs database didn't have procrastinate tables. Ran `job_queue.schema_manager.apply_schema()` via `with job_queue.open()`. This is a one-time setup step needed after devcontainer rebuild.

- **Graceful degradation preserved:** Handler still wraps defer in try/except so registration succeeds even if job queue is down.
</decisions_made>

<blockers>
None — the fix is written and verified, just needs commit + test run + phase completion steps.
</blockers>

<context>
The execute-phase workflow was running all 4 waves sequentially. Each plan was spawned as a gsd-executor subagent. Plan 06-04's checkpoint returned to the orchestrator, and I (the orchestrator) ran the E2E verification steps manually. During E2E testing, discovered the sync/async defer mismatch and fixed it in the working tree.

The uncommitted change in `src/application/handlers/user_handlers.py` is the defer fix. The other uncommitted files (.devcontainer/devcontainer.json, .gitignore, PLAN.md files, CONTEXT.md) were modified by earlier sessions and are expected — they're planning docs that get committed during phase completion.

The `package-lock.json` is untracked and should be committed (it was generated by npm ci during devcontainer setup).
</context>

<next_action>
Resume with: `/gsd:execute-phase 6`

The execute-phase orchestrator should:
1. See 06-01, 06-02, 06-03 have SUMMARYs (complete)
2. See 06-04 has no SUMMARY (incomplete)
3. Pick up 06-04 — Tasks 1-2 already committed, Task 3 checkpoint already passed
4. Commit the defer fix, run tests, create SUMMARY
5. Run verifier, update roadmap/state, commit phase completion

OR manually:
1. `git diff src/application/handlers/user_handlers.py` — review the defer fix
2. Run tests: `uv run pytest tests/ -x -q`
3. If tests pass, commit the fix
4. Create 06-04-SUMMARY.md
5. Complete phase steps
</next_action>
