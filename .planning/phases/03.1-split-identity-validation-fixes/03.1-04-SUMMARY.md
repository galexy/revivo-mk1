---
phase: 03.1-split-identity-validation-fixes
plan: 04
subsystem: testing
tags: [pytest, integration-tests, unit-tests, validation, split-identity]

# Dependency graph
requires:
  - phase: 03.1-03
    provides: split_id persistence, source_split_id, validation handlers
provides:
  - split-identity-tests
  - validation-error-tests
  - phase-3.1-verification
affects: ["04-web-interface"]

# Tech tracking
tech-stack:
  added: []
  patterns: [test-fixture-reuse, api-validation-testing]

key-files:
  created:
    - tests/unit/domain/test_split_line.py
  modified:
    - tests/integration/test_transaction_api.py
    - src/adapters/api/routes/transactions.py
    - src/adapters/api/schemas/transaction.py

key-decisions:
  - "PATCH endpoint preserves split IDs when provided in request (new splits get generated IDs)"
  - "TransactionResponse includes source_split_id field for mirror linkage"
  - "Empty string validation returns 422 (Pydantic), invalid TypeID returns 400"

patterns-established:
  - "Split ID preservation: PATCH with id preserves, without id generates new"
  - "Mirror linkage: source_split_id exposed in API response for transfers"

# Metrics
duration: 4 min
completed: 2026-02-02
---

# Phase 3.1 Plan 04: Split Identity & Validation Tests Summary

**Comprehensive unit and integration tests for split identity, validation errors, and PATCH semantics with auto-fix for ID preservation**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-02T21:37:06Z
- **Completed:** 2026-02-02T21:41:13Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- 9 unit tests for SplitLine entity (identity, validation, properties)
- 9 integration tests for validation errors and split identity
- Fixed PATCH endpoint to preserve split IDs when provided
- Added source_split_id to TransactionResponse for mirror linkage
- All 318 tests pass (201 unit + 117 integration)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add unit tests for SplitLine with identity** - `6c7063b` (test)
2. **Task 2: Add integration tests for validation and split IDs** - `e50e6f5` (test)

## Files Created/Modified
- `tests/unit/domain/test_split_line.py` - Unit tests for SplitLine identity and validation
- `tests/integration/test_transaction_api.py` - Integration tests for validation and split identity
- `src/adapters/api/routes/transactions.py` - Fixed PATCH to preserve split IDs
- `src/adapters/api/schemas/transaction.py` - Added source_split_id to response

## Decisions Made
- PATCH endpoint preserves existing split IDs when provided in request body; omitted IDs generate new ones
- TransactionResponse now includes source_split_id to expose mirror-to-source-split linkage

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] PATCH endpoint doesn't preserve split IDs**
- **Found during:** Task 2 (test_patch_with_split_id_updates_specific_split failed)
- **Issue:** PATCH endpoint used SplitLine.create() for all splits, always generating new IDs
- **Fix:** Modified to check for split_req.id; if present, use SplitLine() constructor with that ID, else SplitLine.create()
- **Files modified:** src/adapters/api/routes/transactions.py
- **Verification:** test_patch_with_split_id_updates_specific_split passes
- **Committed in:** e50e6f5 (Task 2 commit)

**2. [Rule 3 - Blocking] TransactionResponse missing source_split_id field**
- **Found during:** Task 2 (test_mirror_transaction_has_source_split_id failed - KeyError)
- **Issue:** Schema didn't include source_split_id; API response didn't expose mirror-to-split linkage
- **Fix:** Added source_split_id field to TransactionResponse, updated _transaction_to_response helper
- **Files modified:** src/adapters/api/schemas/transaction.py, src/adapters/api/routes/transactions.py
- **Verification:** test_mirror_transaction_has_source_split_id passes
- **Committed in:** e50e6f5 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 blocking)
**Impact on plan:** Both auto-fixes necessary to make tests pass. These were missing pieces from Plan 03 that the tests revealed.

## Issues Encountered
None - deviations were handled via auto-fix rules.

## User Setup Required
None - no external service configuration required.

## Phase 3.1 Completion

This plan completes Phase 3.1: Split Identity & Validation Fixes.

**Phase 3.1 Success Criteria Verification:**

| Criterion | Status | Verified By |
|-----------|--------|-------------|
| SplitLine has unique ID | PASS | test_split_line_create_generates_id, test_multi_split_transaction_has_unique_split_ids |
| PATCH can update specific splits by ID | PASS | test_patch_with_split_id_updates_specific_split |
| Mirror transactions link to source split | PASS | test_mirror_transaction_has_source_split_id |
| Invalid account/category IDs return 400 | PASS | test_invalid_account_id_returns_400, test_invalid_category_id_returns_400 |
| Empty strings return 422 | PASS | test_empty_string_category_id_returns_422, test_empty_string_transfer_account_id_returns_422 |

## Next Phase Readiness
- Phase 3.1 complete, all UAT issues from Phase 3 resolved
- Ready to proceed to Phase 4: Web Interface & API
- All 318 tests pass

---
*Phase: 03.1-split-identity-validation-fixes*
*Completed: 2026-02-02*
