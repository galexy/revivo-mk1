---
phase: 03.1-split-identity-validation-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/model/category.py
  - alembic/versions/004_add_category_type.py
  - src/adapters/persistence/orm/tables.py
  - src/adapters/persistence/repositories/category.py
  - src/adapters/api/schemas/category.py
  - tests/integration/test_category_api.py
autonomous: true

must_haves:
  truths:
    - "Categories have income/expense type"
    - "Category type defaults to expense when not specified"
    - "Category type can be set to income on creation"
    - "Category type is persisted and retrieved correctly"
  artifacts:
    - path: "src/domain/model/category.py"
      provides: "CategoryType enum and category_type field"
      contains: "CategoryType"
    - path: "alembic/versions/004_add_category_type.py"
      provides: "Migration adding category_type column"
      contains: "category_type"
    - path: "src/adapters/api/schemas/category.py"
      provides: "Schema with category_type field"
      contains: "category_type"
  key_links:
    - from: "src/adapters/persistence/repositories/category.py"
      to: "src/domain/model/category.py"
      via: "CategoryType import"
      pattern: "CategoryType"
    - from: "src/adapters/api/schemas/category.py"
      to: "category_type field"
      via: "Pydantic field"
      pattern: "category_type.*str"
---

<objective>
Add CategoryType enum to Category entity with full vertical slice: domain, migration, persistence, API schema, and tests.

Purpose: Enable income/expense classification for categories to support proper transaction categorization.

Output: Complete CategoryType feature from domain to API with tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-CONTEXT.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-RESEARCH.md
@src/domain/model/category.py
@src/adapters/persistence/orm/tables.py
@src/adapters/persistence/repositories/category.py
@src/adapters/api/schemas/category.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CategoryType to domain and persistence</name>
  <files>
    src/domain/model/category.py
    alembic/versions/004_add_category_type.py
    src/adapters/persistence/orm/tables.py
    src/adapters/persistence/repositories/category.py
  </files>
  <action>
1. Add CategoryType enum to category.py BEFORE the Category class:
```python
from enum import StrEnum, auto

class CategoryType(StrEnum):
    """Category type for default transaction direction.

    INCOME: Categories for money coming in (salary, interest, etc.)
    EXPENSE: Categories for money going out (food, utilities, etc.)
    """
    INCOME = auto()
    EXPENSE = auto()
```

2. Add category_type field to Category class with default EXPENSE:
```python
category_type: CategoryType = CategoryType.EXPENSE
```

3. Update Category.create() factory to accept optional category_type parameter (default EXPENSE)

4. Update Category.create_system_category() to accept optional category_type parameter (default EXPENSE)

5. Create migration file alembic/versions/004_add_category_type.py:
```python
"""Add category_type to categories.

Phase 3.1: Split Identity & Validation Fixes (CategoryType feature)

Revision ID: 004
Revises: 003
Create Date: 2026-02-02
"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

revision: str = "004"
down_revision: Union[str, None] = "003"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # Add category_type column with default 'expense'
    op.add_column(
        "categories",
        sa.Column(
            "category_type",
            sa.String(10),
            nullable=False,
            server_default="expense",
        ),
    )


def downgrade() -> None:
    op.drop_column("categories", "category_type")
```

6. Update categories table in tables.py:
```python
sa.Column("category_type", sa.String(10), nullable=False, server_default="expense"),
```

7. Update SqlAlchemyCategoryRepository in category.py:
   - In _hydrate() or equivalent reconstruction: Convert string to CategoryType enum
   - In add(): Include category_type in insert values (as string via .value or str())
   - In update() if it exists: Include category_type in update values
  </action>
  <verify>
Run migration: `cd /workspace && alembic upgrade head`
Test domain: `cd /workspace && python -c "from src.domain.model.category import Category, CategoryType; c = Category.create('Test', CategoryType.INCOME); print(f'Type: {c.category_type}')"`
  </verify>
  <done>
- CategoryType enum exists with INCOME and EXPENSE
- Category has category_type field defaulting to EXPENSE
- Category.create() and create_system_category() accept category_type
- Migration 004 adds category_type column
- Repository handles CategoryType correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CategoryType to API schema and tests</name>
  <files>
    src/adapters/api/schemas/category.py
    tests/integration/test_category_api.py
  </files>
  <action>
1. Update category.py schemas:

Add category_type to CategoryResponse:
```python
category_type: str  # "income" or "expense"
```

Add category_type to CreateCategoryRequest (optional, defaults to expense):
```python
category_type: str = Field(default="expense", pattern="^(income|expense)$")
```

2. Update the category routes to handle category_type:
   - In create_category: Pass category_type from request to service
   - In CategoryResponse.from_entity: Include category_type (as string value)

3. Add tests to test_category_api.py:

```python
class TestCategoryType:
    """Tests for category type field."""

    def test_create_category_default_expense(
        self, client: TestClient, setup_user: UserId
    ) -> None:
        """Category should default to expense type."""
        response = client.post(
            "/api/v1/categories",
            json={"name": "Groceries"},
        )
        assert response.status_code == 201
        assert response.json()["category_type"] == "expense"

    def test_create_category_income_type(
        self, client: TestClient, setup_user: UserId
    ) -> None:
        """Can create category with income type."""
        response = client.post(
            "/api/v1/categories",
            json={"name": "Salary", "category_type": "income"},
        )
        assert response.status_code == 201
        assert response.json()["category_type"] == "income"

    def test_create_category_invalid_type_returns_422(
        self, client: TestClient, setup_user: UserId
    ) -> None:
        """Invalid category type should return 422."""
        response = client.post(
            "/api/v1/categories",
            json={"name": "Test", "category_type": "invalid"},
        )
        assert response.status_code == 422  # Pydantic validation error

    def test_get_category_includes_type(
        self, client: TestClient, setup_user: UserId
    ) -> None:
        """GET category should include category_type."""
        # Create
        create_response = client.post(
            "/api/v1/categories",
            json={"name": "Utilities", "category_type": "expense"},
        )
        cat_id = create_response.json()["id"]

        # Get
        get_response = client.get(f"/api/v1/categories/{cat_id}")
        assert get_response.status_code == 200
        assert get_response.json()["category_type"] == "expense"
```
  </action>
  <verify>
Run tests: `cd /workspace && python -m pytest tests/integration/test_category_api.py -v -k "category_type or CategoryType"`
All category type tests pass.
  </verify>
  <done>
- CategoryResponse includes category_type field
- CreateCategoryRequest accepts optional category_type (default expense)
- Invalid category_type returns 422
- Integration tests verify full round-trip
  </done>
</task>

</tasks>

<verification>
1. Migration runs: `alembic upgrade head`
2. Domain works: `python -c "from src.domain.model.category import CategoryType; print(CategoryType.INCOME, CategoryType.EXPENSE)"`
3. API tests pass: `python -m pytest tests/integration/test_category_api.py -v`
4. Full round-trip: Create category with income type via API, retrieve it, verify type persisted
</verification>

<success_criteria>
- CategoryType enum exists with INCOME and EXPENSE values
- Category.category_type field defaults to EXPENSE
- Migration adds category_type column with default
- Repository persists and loads CategoryType correctly
- API accepts category_type in create request
- API returns category_type in response
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-split-identity-validation-fixes/03.1-02-SUMMARY.md`
</output>
