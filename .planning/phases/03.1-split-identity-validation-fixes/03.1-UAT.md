---
status: testing
phase: 03.1-split-identity-validation-fixes
source: [03.1-01-SUMMARY.md, 03.1-02-SUMMARY.md, 03.1-03-SUMMARY.md, 03.1-04-SUMMARY.md]
started: 2026-02-02T22:00:00Z
updated: 2026-02-02T22:00:00Z
---

## Setup

Set these variables before running tests:

```bash
# Get an account ID (create one or list existing)
ACCOUNT_ID="acct_01jk..."

# Get a second account for transfers
ACCOUNT_ID_2="acct_01jk..."

# Get or create a category
CATEGORY_ID="cat_01jk..."

# Base URL
API="http://localhost:8000/api/v1"
```

## Current Test
<!-- OVERWRITE each test - shows where we are -->

number: 1
name: Split IDs in Transaction Response
expected: |
  POST a new transaction. Response should include a `splits` array where each split has an `id` field starting with "split_".
awaiting: user response

## Tests

### 1. Split IDs in Transaction Response
expected: POST a new transaction. Response should include a `splits` array where each split has an `id` field starting with "split_".
```bash
curl -s -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-50.00", "currency": "USD"},
    "splits": [{"amount": {"amount": "-50.00", "currency": "USD"}}]
  }' | jq '.splits[].id'
```
result: [pending]

### 2. Split IDs Persist Across GET
expected: Create a transaction, note the split ID. GET the same transaction. The split ID should be the same value.
```bash
# Create and capture transaction ID
TXN=$(curl -s -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-25.00", "currency": "USD"},
    "splits": [{"amount": {"amount": "-25.00", "currency": "USD"}}]
  }')
TXN_ID=$(echo $TXN | jq -r '.id')
SPLIT_ID=$(echo $TXN | jq -r '.splits[0].id')
echo "Created split: $SPLIT_ID"

# GET and verify same ID
curl -s "$API/transactions/$TXN_ID" | jq '.splits[0].id'
```
result: [pending]

### 3. PATCH Preserves Split IDs
expected: Create a transaction with splits, note the split IDs. PATCH the transaction including the splits with their IDs. The response should show the same split IDs (not new ones).
```bash
# Create transaction with two splits
TXN=$(curl -s -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-100.00", "currency": "USD"},
    "splits": [
      {"amount": {"amount": "-60.00", "currency": "USD"}},
      {"amount": {"amount": "-40.00", "currency": "USD"}}
    ]
  }')
TXN_ID=$(echo $TXN | jq -r '.id')
SPLIT1_ID=$(echo $TXN | jq -r '.splits[0].id')
SPLIT2_ID=$(echo $TXN | jq -r '.splits[1].id')
echo "Original splits: $SPLIT1_ID, $SPLIT2_ID"

# PATCH with same split IDs
curl -s -X PATCH "$API/transactions/$TXN_ID" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": {"amount": "-100.00", "currency": "USD"},
    "splits": [
      {"id": "'"$SPLIT1_ID"'", "amount": {"amount": "-70.00", "currency": "USD"}},
      {"id": "'"$SPLIT2_ID"'", "amount": {"amount": "-30.00", "currency": "USD"}}
    ]
  }' | jq '.splits[].id'
```
result: [pending]

### 4. Transfer Creates Mirror with source_split_id
expected: Create a transfer transaction (split with transfer_account_id). The mirror transaction in the target account should have a `source_split_id` field linking back to the original split.
```bash
# Create transfer from ACCOUNT_ID to ACCOUNT_ID_2
TXN=$(curl -s -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-200.00", "currency": "USD"},
    "splits": [
      {"amount": {"amount": "-200.00", "currency": "USD"}, "transfer_account_id": "'"$ACCOUNT_ID_2"'"}
    ]
  }')
SOURCE_SPLIT_ID=$(echo $TXN | jq -r '.splits[0].id')
echo "Source split ID: $SOURCE_SPLIT_ID"

# List transactions on target account, find mirror, check source_split_id
curl -s "$API/transactions?account_id=$ACCOUNT_ID_2" | jq '.transactions[] | select(.source_split_id != null) | {source_split_id, amount}'
```
result: [pending]

### 5. Invalid Account ID Returns 400
expected: POST a transaction with an invalid account_id format (e.g., "invalid"). Should return HTTP 400 (not 500) with error code INVALID_ID_FORMAT or VALIDATION_ERROR.
```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "invalid_format",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-50.00", "currency": "USD"},
    "splits": [{"amount": {"amount": "-50.00", "currency": "USD"}}]
  }'
```
result: [pending]

### 6. Invalid Category ID Returns 400
expected: POST a transaction with a split containing an invalid category_id format (e.g., "bad_id"). Should return HTTP 400 (not 500).
```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-50.00", "currency": "USD"},
    "splits": [{"amount": {"amount": "-50.00", "currency": "USD"}, "category_id": "bad_id"}]
  }'
```
result: [pending]

### 7. Empty String Category ID Returns 422
expected: POST a transaction with a split where category_id is an empty string "". Should return HTTP 422 (Pydantic validation error), not silently accept it as null.
```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST "$API/transactions" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "'"$ACCOUNT_ID"'",
    "effective_date": "2026-02-02",
    "amount": {"amount": "-50.00", "currency": "USD"},
    "splits": [{"amount": {"amount": "-50.00", "currency": "USD"}, "category_id": ""}]
  }'
```
result: [pending]

### 8. Create Category with Default Type
expected: POST a new category without specifying category_type. Response should include `category_type: "expense"` (the default).
```bash
curl -s -X POST "$API/categories" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Category Default"}' | jq '{name, category_type}'
```
result: [pending]

### 9. Create Income Category
expected: POST a new category with `category_type: "income"`. Response should include `category_type: "income"`.
```bash
curl -s -X POST "$API/categories" \
  -H "Content-Type: application/json" \
  -d '{"name": "Salary", "category_type": "income"}' | jq '{name, category_type}'
```
result: [pending]

### 10. Invalid Category Type Returns 422
expected: POST a new category with `category_type: "invalid"`. Should return HTTP 422 (Pydantic validation error).
```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST "$API/categories" \
  -H "Content-Type: application/json" \
  -d '{"name": "Bad Type", "category_type": "invalid"}'
```
result: [pending]

## Summary

total: 10
passed: 0
issues: 0
pending: 10
skipped: 0

## Gaps

[none yet]
