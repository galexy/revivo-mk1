# Phase 3.1 Plan 03: Split Identity Persistence & Validation Summary

## Frontmatter

```yaml
phase: 03.1-split-identity-validation-fixes
plan: 03
subsystem: persistence-api
tags: [database, migration, repository, validation, exception-handling]
requires: ["03.1-01"]
provides: ["split_id-persistence", "source_split_id-persistence", "validation-400", "typeid-400"]
affects: ["04-web-interface"]
tech-stack:
  added: []
  patterns: [exception-handler, pydantic-field-validator]
key-files:
  created:
    - alembic/versions/005_add_split_identity.py
  modified:
    - src/adapters/persistence/orm/tables.py
    - src/adapters/persistence/orm/types.py
    - src/adapters/persistence/repositories/transaction.py
    - src/adapters/api/schemas/transaction.py
    - src/adapters/api/app.py
    - src/adapters/api/routes/transactions.py
decisions:
  - SplitIdType custom TypeDecorator for ORM mapping
  - TypeIDException handler returns INVALID_ID_FORMAT code
  - Empty string validators use Pydantic field_validator (422 response)
metrics:
  duration: 5 min
  completed: 2026-02-02
```

## One-liner

Database migration 005 adds split_id/source_split_id columns, repository persists split IDs, API returns proper 400/422 for validation errors.

## Summary

This plan completes the persistence layer for split identity and adds proper error handling for invalid IDs and empty strings.

### What Was Done

1. **Database Migration 005**
   - Added `split_id` column to `split_lines` table (NOT NULL, unique index)
   - Added `source_split_id` column to `transactions` table (nullable, indexed)
   - Includes backfill logic for existing splits (generates TypeID for each)
   - Updated table definitions in `tables.py` to match

2. **Repository Updates**
   - `_load_splits()` now reads `split_id` from database and reconstructs `SplitId`
   - `_save_splits()` now persists `split_id` for each split
   - `_reconstruct_value_objects()` handles `source_split_id` reconstruction
   - `add()` method includes `source_split_id` in insert values

3. **Schema Updates**
   - `SplitLineRequest` now includes optional `id` field for updates
   - `SplitLineResponse` now includes required `id` field
   - Added `field_validator` for `category_id` and `transfer_account_id` to reject empty strings
   - Updated `_split_to_response()` helper to include split ID

4. **Exception Handlers**
   - Added `ValueError` exception handler returning 400 with `VALIDATION_ERROR` code
   - Added `TypeIDException` handler returning 400 with `INVALID_ID_FORMAT` code
   - Added `SplitIdType` custom TypeDecorator for ORM mapping

### Why It Matters

- Split IDs are now persisted and stable across loads (no more generating on each load)
- Mirror transactions can be properly linked to their source splits via `source_split_id`
- Invalid TypeIDs return 400 Bad Request (not 500 Internal Server Error)
- Empty strings in category_id/transfer_account_id are caught early with clear errors

## Commits

| Hash | Message |
|------|---------|
| 3d29f75 | feat(03.1-03): add database migration for split identity columns |
| afa6aca | feat(03.1-03): update repository, schemas, and add exception handlers |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added SplitIdType custom type decorator**
- **Found during:** Task 2 verification
- **Issue:** SQLAlchemy ORM couldn't adapt `SplitId` type when updating transactions with `source_split_id`
- **Fix:** Added `SplitIdType` TypeDecorator in `types.py`, updated `tables.py` to use it for `source_split_id` column
- **Files modified:** `src/adapters/persistence/orm/types.py`, `src/adapters/persistence/orm/tables.py`
- **Commit:** afa6aca

**2. [Rule 1 - Bug] Added TypeIDException handler**
- **Found during:** Task 2 verification
- **Issue:** Invalid TypeIDs raised `SuffixValidationException` (from typeid library) not `ValueError`, bypassing the ValueError handler
- **Fix:** Added dedicated `TypeIDException` exception handler returning 400 with `INVALID_ID_FORMAT` code
- **Files modified:** `src/adapters/api/app.py`
- **Commit:** afa6aca

## Verification

- [x] Migration 005 runs successfully: `alembic upgrade head`
- [x] All 300 tests pass
- [x] Invalid TypeID returns 400 with `INVALID_ID_FORMAT` code
- [x] Empty string in category_id returns 422 (Pydantic validation)
- [x] Split IDs persist through database round-trip
- [x] Mirror transactions include source_split_id

## Next Steps

Plan 04 (03.1-04-PLAN.md) will add integration tests for the validation scenarios and complete Phase 3.1.
