---
phase: 03.1-split-identity-validation-fixes
plan: 04
type: execute
wave: 3
depends_on: ["03.1-03"]
files_modified:
  - tests/integration/test_transaction_api.py
  - tests/unit/domain/test_split_line.py
autonomous: true

must_haves:
  truths:
    - "PATCH with split IDs updates specific splits"
    - "Invalid account/category IDs return 400 (not 500)"
    - "Empty string for IDs returns 400"
    - "Mirror transactions have source_split_id populated"
  artifacts:
    - path: "tests/integration/test_transaction_api.py"
      provides: "Integration tests for split ID PATCH and validation"
      contains: "test_patch_transaction_with_split_ids"
    - path: "tests/unit/domain/test_split_line.py"
      provides: "Unit tests for SplitLine with ID"
      contains: "test_split_line_create_generates_id"
  key_links:
    - from: "tests/integration/test_transaction_api.py"
      to: "/api/v1/transactions"
      via: "HTTP requests"
      pattern: "client.patch.*transactions"
---

<objective>
Add comprehensive tests for split identity and validation error handling. Verify all Phase 3.1 split identity success criteria are met.

Purpose: Ensure split identity and validation features work correctly through automated tests.

Output: New and updated test files covering split IDs and validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-CONTEXT.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-01-SUMMARY.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-03-SUMMARY.md
@tests/integration/test_transaction_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for SplitLine with identity</name>
  <files>
    tests/unit/domain/test_split_line.py
  </files>
  <action>
Create tests/unit/domain/test_split_line.py with comprehensive tests for SplitLine entity:

```python
"""Unit tests for SplitLine entity with identity."""

import pytest

from src.domain.model.entity_id import AccountId, CategoryId, SplitId
from src.domain.model.money import Money
from src.domain.model.split_line import SplitLine


class TestSplitLineIdentity:
    """Tests for SplitLine ID behavior."""

    def test_split_line_create_generates_id(self) -> None:
        """SplitLine.create() should generate a unique ID."""
        split = SplitLine.create(
            amount=Money("-100.00", "USD"),
            category_id=CategoryId.generate(),
        )
        assert split.id is not None
        assert split.id.prefix == "split"

    def test_split_line_create_multiple_have_unique_ids(self) -> None:
        """Multiple SplitLine.create() calls should generate unique IDs."""
        split1 = SplitLine.create(amount=Money("-50.00", "USD"))
        split2 = SplitLine.create(amount=Money("-50.00", "USD"))
        assert split1.id != split2.id

    def test_split_line_with_explicit_id(self) -> None:
        """SplitLine can be created with explicit ID (for loading from DB)."""
        explicit_id = SplitId.generate()
        split = SplitLine(
            id=explicit_id,
            amount=Money("-100.00", "USD"),
        )
        assert split.id == explicit_id

    def test_split_line_immutable_with_id(self) -> None:
        """SplitLine should remain immutable (frozen dataclass)."""
        split = SplitLine.create(amount=Money("-100.00", "USD"))
        with pytest.raises(AttributeError):
            split.amount = Money("-200.00", "USD")  # type: ignore


class TestSplitLineValidation:
    """Tests for SplitLine validation with ID."""

    def test_split_line_cannot_have_both_category_and_transfer(self) -> None:
        """Split cannot have both category_id and transfer_account_id."""
        with pytest.raises(ValueError, match="cannot have both"):
            SplitLine.create(
                amount=Money("-100.00", "USD"),
                category_id=CategoryId.generate(),
                transfer_account_id=AccountId.generate(),
            )

    def test_split_line_transfer_must_be_negative(self) -> None:
        """Transfer split must have negative amount."""
        with pytest.raises(ValueError, match="must be negative"):
            SplitLine.create(
                amount=Money("100.00", "USD"),  # Positive - invalid for transfer
                transfer_account_id=AccountId.generate(),
            )

    def test_split_line_uncategorized_allowed(self) -> None:
        """Split can have neither category nor transfer (uncategorized)."""
        split = SplitLine.create(
            amount=Money("-100.00", "USD"),
            memo="Uncategorized expense",
        )
        assert split.is_uncategorized
        assert not split.is_categorized
        assert not split.is_transfer


class TestSplitLineProperties:
    """Tests for SplitLine property methods."""

    def test_is_transfer_with_transfer_account(self) -> None:
        """is_transfer should be True when transfer_account_id is set."""
        split = SplitLine.create(
            amount=Money("-100.00", "USD"),
            transfer_account_id=AccountId.generate(),
        )
        assert split.is_transfer

    def test_is_categorized_with_category(self) -> None:
        """is_categorized should be True when category_id is set."""
        split = SplitLine.create(
            amount=Money("-100.00", "USD"),
            category_id=CategoryId.generate(),
        )
        assert split.is_categorized
```
  </action>
  <verify>
Run tests: `cd /workspace && python -m pytest tests/unit/domain/test_split_line.py -v`
All tests pass.
  </verify>
  <done>
- test_split_line.py exists with tests for:
  - SplitLine.create() generates ID
  - Multiple splits have unique IDs
  - Explicit ID construction works
  - Immutability preserved
  - Validation rules still work
  - Property methods work with ID
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for validation and split IDs</name>
  <files>
    tests/integration/test_transaction_api.py
  </files>
  <action>
Add tests to test_transaction_api.py for validation error handling and split identity:

```python
class TestTransactionValidationErrors:
    """Tests for proper 400 responses on validation errors."""

    def test_invalid_account_id_returns_400(
        self, client: TestClient, setup_user: UserId
    ) -> None:
        """Invalid account ID format should return 400, not 500."""
        response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": "invalid_format",
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {"amount": {"amount": "-100.00", "currency": "USD"}}
                ],
            },
        )
        assert response.status_code == 400
        assert "VALIDATION_ERROR" in response.json().get("detail", {}).get("code", "")

    def test_invalid_category_id_returns_400(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId
    ) -> None:
        """Invalid category ID format should return 400, not 500."""
        response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {
                        "amount": {"amount": "-100.00", "currency": "USD"},
                        "category_id": "invalid_format",
                    }
                ],
            },
        )
        assert response.status_code == 400

    def test_empty_string_category_id_returns_400(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId
    ) -> None:
        """Empty string category_id should return 400, not create with null."""
        response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {
                        "amount": {"amount": "-100.00", "currency": "USD"},
                        "category_id": "",  # Empty string - should be rejected
                    }
                ],
            },
        )
        assert response.status_code == 400

    def test_empty_string_transfer_account_id_returns_400(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId
    ) -> None:
        """Empty string transfer_account_id should return 400."""
        response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {
                        "amount": {"amount": "-100.00", "currency": "USD"},
                        "transfer_account_id": "",  # Empty string - should be rejected
                    }
                ],
            },
        )
        assert response.status_code == 400


class TestSplitIdentity:
    """Tests for split ID persistence and PATCH semantics."""

    def test_transaction_response_includes_split_ids(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId
    ) -> None:
        """Transaction response should include split IDs."""
        # Create transaction
        response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {"amount": {"amount": "-100.00", "currency": "USD"}}
                ],
            },
        )
        assert response.status_code == 201
        data = response.json()
        assert len(data["splits"]) == 1
        assert "id" in data["splits"][0]
        assert data["splits"][0]["id"].startswith("split_")

    def test_split_ids_persist_across_get(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId
    ) -> None:
        """Split IDs should persist when getting transaction."""
        # Create
        create_response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {"amount": {"amount": "-100.00", "currency": "USD"}}
                ],
            },
        )
        txn_id = create_response.json()["id"]
        split_id = create_response.json()["splits"][0]["id"]

        # Get
        get_response = client.get(f"/api/v1/transactions/{txn_id}")
        assert get_response.status_code == 200
        assert get_response.json()["splits"][0]["id"] == split_id

    def test_patch_with_split_id_updates_specific_split(
        self, client: TestClient, setup_user: UserId, setup_account: AccountId, setup_category: CategoryId
    ) -> None:
        """PATCH with split ID should update that specific split."""
        # Create transaction with two splits
        create_response = client.post(
            "/api/v1/transactions",
            json={
                "account_id": str(setup_account),
                "effective_date": "2026-01-15",
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {"amount": {"amount": "-60.00", "currency": "USD"}},
                    {"amount": {"amount": "-40.00", "currency": "USD"}},
                ],
            },
        )
        assert create_response.status_code == 201
        txn_id = create_response.json()["id"]
        splits = create_response.json()["splits"]
        split1_id = splits[0]["id"]
        split2_id = splits[1]["id"]

        # PATCH - update first split, keep second
        patch_response = client.patch(
            f"/api/v1/transactions/{txn_id}",
            json={
                "amount": {"amount": "-100.00", "currency": "USD"},
                "splits": [
                    {
                        "id": split1_id,
                        "amount": {"amount": "-70.00", "currency": "USD"},
                        "category_id": str(setup_category),
                    },
                    {
                        "id": split2_id,
                        "amount": {"amount": "-30.00", "currency": "USD"},
                    },
                ],
            },
        )
        assert patch_response.status_code == 200

        # Verify IDs preserved
        updated = patch_response.json()
        assert updated["splits"][0]["id"] == split1_id
        assert updated["splits"][1]["id"] == split2_id
```
  </action>
  <verify>
Run all integration tests: `cd /workspace && python -m pytest tests/integration/ -v --tb=short`
All tests pass.
  </verify>
  <done>
- Unit tests for SplitLine identity pass
- Integration tests for validation errors (400 not 500) pass
- Integration tests for empty string validation pass
- Integration tests for split ID persistence pass
- Integration tests for PATCH with split IDs pass
- All existing tests still pass
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass: `python -m pytest tests/unit/ -v`
2. All integration tests pass: `python -m pytest tests/integration/ -v`
3. Full test suite: `python -m pytest tests/ -v`

Phase 3.1 Split Identity Success Criteria Verification:
- [ ] SplitLine has unique ID; PATCH can update specific splits by ID
- [ ] Mirror transactions link to source split via source_split_id
- [ ] Invalid account/category IDs return 400 (not 500)
- [ ] Empty strings return 400
</verification>

<success_criteria>
- All new tests pass
- All existing tests pass
- Split identity criteria verified by tests:
  1. Split IDs work in responses and PATCH
  2. source_split_id populated for mirrors
  3. Invalid IDs return 400
  4. Empty strings return 400
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-split-identity-validation-fixes/03.1-04-SUMMARY.md`
</output>
