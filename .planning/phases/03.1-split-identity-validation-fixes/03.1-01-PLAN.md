---
phase: 03.1-split-identity-validation-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/model/entity_id.py
  - src/domain/model/split_line.py
  - src/domain/model/transaction.py
  - tests/unit/domain/test_entity_id.py
autonomous: true

must_haves:
  truths:
    - "SplitLine has unique ID that persists across updates"
    - "SplitLine.create() factory generates ID automatically"
    - "Transaction mirrors link to source split via source_split_id"
  artifacts:
    - path: "src/domain/model/entity_id.py"
      provides: "SplitId entity identifier class"
      contains: "class SplitId"
    - path: "src/domain/model/split_line.py"
      provides: "SplitLine entity with id field and create() factory"
      contains: "id: SplitId"
    - path: "src/domain/model/transaction.py"
      provides: "Transaction with source_split_id for mirror linkage"
      contains: "source_split_id"
  key_links:
    - from: "src/domain/model/split_line.py"
      to: "src/domain/model/entity_id.py"
      via: "import SplitId"
      pattern: "from.*entity_id.*import.*SplitId"
    - from: "src/domain/model/transaction.py"
      to: "src/domain/model/entity_id.py"
      via: "import SplitId for source_split_id"
      pattern: "SplitId"
---

<objective>
Add SplitId to entity identifiers, transform SplitLine from value object to entity with identity, and add source_split_id to Transaction for mirror linkage.

Purpose: Foundation for proper PATCH semantics where clients can reference specific splits by ID, and mirrors can be correctly matched to their source splits.

Output: Updated domain model files with SplitId, SplitLine entity, and Transaction.source_split_id.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-CONTEXT.md
@.planning/phases/03.1-split-identity-validation-fixes/03.1-RESEARCH.md
@src/domain/model/entity_id.py
@src/domain/model/split_line.py
@src/domain/model/transaction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SplitId to entity identifiers</name>
  <files>
    src/domain/model/entity_id.py
    tests/unit/domain/test_entity_id.py
  </files>
  <action>
1. Add SplitId class to entity_id.py following the exact pattern of existing ID classes (AccountId, TransactionId, etc.):
   - prefix: "split"
   - @dataclass(frozen=True, slots=True)
   - value: str
   - @classmethod generate() -> Self
   - @classmethod from_string(value: str) -> Self (validates prefix)
   - @property prefix -> str
   - __str__ -> str

2. Add test for SplitId in test_entity_id.py following existing test patterns:
   - test_split_id_generate()
   - test_split_id_from_string_valid()
   - test_split_id_from_string_invalid_prefix()
  </action>
  <verify>
Run tests: `cd /workspace && python -m pytest tests/unit/domain/test_entity_id.py -v`
All tests pass including new SplitId tests.
  </verify>
  <done>
- SplitId class exists with generate(), from_string(), prefix property
- Unit tests for SplitId pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Transform SplitLine to entity with identity</name>
  <files>
    src/domain/model/split_line.py
    src/domain/model/transaction.py
  </files>
  <action>
1. Update SplitLine in split_line.py:
   - Import SplitId from entity_id
   - Add id: SplitId as FIRST field (before amount)
   - Keep @dataclass(frozen=True, slots=True) - immutability preserved
   - Add SplitLine.create() class method factory that generates ID:
```python
@classmethod
def create(
    cls,
    amount: Money,
    category_id: CategoryId | None = None,
    transfer_account_id: AccountId | None = None,
    memo: str | None = None,
) -> Self:
    """Factory method that generates ID."""
    return cls(
        id=SplitId.generate(),
        amount=amount,
        category_id=category_id,
        transfer_account_id=transfer_account_id,
        memo=memo,
    )
```

2. Update Transaction in transaction.py:
   - Import SplitId from entity_id
   - Add source_split_id field after source_transaction_id:
```python
source_split_id: SplitId | None = None  # Which split created this mirror
```
   - Update Transaction.create_mirror() to accept source_split parameter (the SplitLine that triggers this mirror)
   - Store source_split.id as source_split_id on the mirror

3. Update Transaction.create() to use SplitLine objects passed in (they should already have IDs from caller using SplitLine.create())

4. Update Transaction.update_amount() method for mirrors - keep existing behavior but note that split ID is preserved since SplitLine is immutable and recreated.

IMPORTANT: Keep SplitLine frozen - the ID provides identity, but instances remain immutable. When updating, create new SplitLine with same ID.
  </action>
  <verify>
Run tests: `cd /workspace && python -m pytest tests/unit/domain/ -v -k "split or transaction"`
Check imports work: `cd /workspace && python -c "from src.domain.model.split_line import SplitLine; from src.domain.model.entity_id import SplitId; print('OK')"`
  </verify>
  <done>
- SplitLine has id: SplitId as first field
- SplitLine.create() factory method generates ID
- Transaction has source_split_id: SplitId | None field
- Transaction.create_mirror() accepts source_split and stores source_split_id
- All existing domain tests still pass
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass: `cd /workspace && python -m pytest tests/unit/domain/ -v`
2. Import check: `python -c "from src.domain.model.entity_id import SplitId; from src.domain.model.split_line import SplitLine; print('All imports OK')"`
3. SplitId generation: `python -c "from src.domain.model.entity_id import SplitId; sid = SplitId.generate(); print(f'Generated: {sid}'); assert sid.prefix == 'split'"`
4. SplitLine creation: `python -c "from src.domain.model.split_line import SplitLine; from src.domain.model.money import Money; s = SplitLine.create(Money('100.00', 'USD')); print(f'Split ID: {s.id}')"`
</verification>

<success_criteria>
- SplitId follows exact pattern of other entity IDs (frozen dataclass, generate, from_string, prefix)
- SplitLine.id is required (first field), SplitLine.create() factory generates ID
- Transaction.source_split_id exists for mirror linkage
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-split-identity-validation-fixes/03.1-01-SUMMARY.md`
</output>
