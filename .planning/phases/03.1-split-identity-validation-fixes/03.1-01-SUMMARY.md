---
phase: 03.1-split-identity-validation-fixes
plan: 01
subsystem: domain
tags: [entity-id, split-line, transaction, identity, typeid]

# Dependency graph
requires:
  - phase: 03-transaction-domain
    provides: Transaction aggregate, SplitLine value object
provides:
  - SplitId entity identifier class
  - SplitLine transformed to entity with id field
  - SplitLine.create() factory method
  - Transaction.source_split_id for mirror linkage
affects: [03.1-02, 03.1-03, 03.1-04, phase-4]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Entity identity via SplitId (same pattern as other entity IDs)"
    - "Factory method SplitLine.create() for ID generation"
    - "source_split_id links mirrors to their source splits"

key-files:
  created: []
  modified:
    - src/domain/model/entity_id.py
    - src/domain/model/split_line.py
    - src/domain/model/transaction.py
    - tests/unit/domain/test_entity_id.py
    - src/adapters/api/routes/transactions.py
    - src/adapters/persistence/repositories/transaction.py
    - src/application/services/transaction_service.py

key-decisions:
  - "SplitId follows exact pattern of other entity IDs (frozen dataclass, generate, from_string, prefix)"
  - "SplitLine.id is required first field, .create() factory generates ID"
  - "Repository generates SplitId on load until DB migration adds split_id column"
  - "Transaction.create_mirror() accepts source_split to record source_split_id linkage"

patterns-established:
  - "Entity factory methods: .create() generates ID, constructor requires ID"
  - "Mirror linkage: source_split_id links mirror transaction to originating split"

# Metrics
duration: 4min
completed: 2026-02-02
---

# Phase 3.1 Plan 01: SplitLine Identity Summary

**SplitId entity identifier with SplitLine.create() factory and Transaction.source_split_id for mirror linkage**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-02T21:19:09Z
- **Completed:** 2026-02-02T21:23:22Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Added SplitId class following existing entity ID pattern (frozen dataclass, generate, from_string, prefix)
- Transformed SplitLine from value object to entity with identity (id as first field)
- Added SplitLine.create() factory method for automatic ID generation
- Added Transaction.source_split_id to link mirror transactions to their source splits
- Updated Transaction.create_mirror() to record source_split linkage
- All 166 domain unit tests pass
- All 108 integration tests pass

## Task Commits

Each task was committed atomically:

1. **Task 1: Add SplitId to entity identifiers** - `e01a536` (feat)
2. **Task 2: Transform SplitLine to entity with identity** - `048d22f` (feat)

## Files Created/Modified
- `src/domain/model/entity_id.py` - Added SplitId class with prefix "split"
- `src/domain/model/split_line.py` - Added id: SplitId field and create() factory
- `src/domain/model/transaction.py` - Added source_split_id and updated create_mirror()
- `tests/unit/domain/test_entity_id.py` - Added SplitId tests
- `src/adapters/api/routes/transactions.py` - Updated to use SplitLine.create()
- `src/adapters/persistence/repositories/transaction.py` - Generate SplitId on load
- `src/application/services/transaction_service.py` - Pass source_split to create_mirror()

## Decisions Made
- SplitId prefix is "split" (consistent with other entity ID prefixes)
- Repository generates SplitId on load as temporary measure until DB migration
- SplitLine remains frozen dataclass - ID provides identity, instances remain immutable

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Updated repository to generate SplitId on load**
- **Found during:** Task 2 (running integration tests)
- **Issue:** Repository was constructing SplitLine without id, causing TypeError
- **Fix:** Import SplitId and generate new ID when loading splits from database
- **Files modified:** src/adapters/persistence/repositories/transaction.py
- **Verification:** All 108 integration tests pass
- **Committed in:** 048d22f (Task 2 commit)

**2. [Rule 3 - Blocking] Updated API routes to use SplitLine.create()**
- **Found during:** Task 2 (running integration tests)
- **Issue:** API routes constructing SplitLine without id, causing TypeError
- **Fix:** Changed SplitLine() to SplitLine.create() in create_transaction and update_transaction
- **Files modified:** src/adapters/api/routes/transactions.py
- **Verification:** All 108 integration tests pass
- **Committed in:** 048d22f (Task 2 commit)

**3. [Rule 3 - Blocking] Updated TransactionService to pass source_split to create_mirror()**
- **Found during:** Task 2 (updating create_mirror signature)
- **Issue:** TransactionService calls to create_mirror() missing required source_split parameter
- **Fix:** Updated both call sites to pass the split as source_split argument
- **Files modified:** src/application/services/transaction_service.py
- **Verification:** All 108 integration tests pass
- **Committed in:** 048d22f (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (3 blocking)
**Impact on plan:** All auto-fixes necessary for code to function. The plan focused on domain model changes; the adapter layer updates were necessary consequences.

## Issues Encountered
None - plan executed successfully with blocking issues resolved as deviations.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- SplitLine now has identity for PATCH semantics
- Transaction mirrors can be linked to their source splits
- Ready for Plan 02 (Invalid ID Handling) and Plan 03 (Database Migration to store split_id)

---
*Phase: 03.1-split-identity-validation-fixes*
*Completed: 2026-02-02*
